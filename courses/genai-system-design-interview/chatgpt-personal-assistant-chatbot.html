<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT: Personal Assistant Chatbot - Genai System Design Interview</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Open Sans', Arial, sans-serif;
    font-size: 16px;
    line-height: 1.6;
    color: #454545;
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

h1 {
    font-size: 2em;
    margin: 1em 0 0.5em 0;
    line-height: 1.2;
}

h2 {
    font-size: 1.5em;
    margin: 1.2em 0 0.6em 0;
    line-height: 1.3;
}

h3 {
    font-size: 1.2em;
    margin: 1em 0 0.5em 0;
    line-height: 1.4;
}

p {
    margin: 0.8em 0;
}

a {
    color: #0077aa;
    text-decoration: none;
}

a:hover {
    text-decoration: underline;
}

ul, ol {
    margin: 0.8em 0;
    padding-left: 2em;
}

li {
    margin: 0.4em 0;
}

code, pre {
    background: #f4f4f4;
    border: 1px solid #ddd;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
}

code {
    padding: 2px 5px;
}

pre {
    padding: 10px;
    overflow-x: auto;
    margin: 1em 0;
}

pre code {
    border: none;
    padding: 0;
}

img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 1.5em auto;
}

figure {
    margin: 1.5em 0;
    text-align: center;
}

figcaption {
    font-style: italic;
    font-size: 0.9em;
    color: #666;
    margin-top: 0.5em;
}

.chapter-number {
    font-weight: bold;
    color: #0077aa;
}

.nav {
    margin: 2em 0;
    padding: 1em 0;
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
}

.nav a {
    margin-right: 1em;
}

.toc {
    list-style: none;
    padding: 0;
}

.toc li {
    margin: 0.8em 0;
}

.course-section {
    margin: 2em 0;
}

.course-title {
    font-size: 1.3em;
    font-weight: bold;
    color: #0077aa;
    margin: 1.5em 0 0.8em 0;
}

.metadata {
    font-size: 0.9em;
    color: #888;
    margin: 2em 0 1em 0;
}

.breadcrumb {
    font-size: 0.9em;
    color: #666;
    margin-bottom: 1em;
}

.breadcrumb a {
    color: #0077aa;
}

@media (max-width: 600px) {
    body {
        padding: 10px;
    }

    h1 {
        font-size: 1.5em;
    }

    h2 {
        font-size: 1.3em;
    }
}</style>
</head>
<body>
    <div class="breadcrumb">
        <a href="../../index.html">Home</a> /
        <a href="../genai-system-design-interview.html">Genai System Design Interview</a> /
        ChatGPT: Personal Assistant Chatbot
    </div>

    <div class="nav">
        <a href="../genai-system-design-interview.html">← Course Contents</a>
        <a href="google-translate.html">← Previous</a>
        <a href="image-captioning.html">Next →</a>
    </div>

    <main>
        <h1>
            <span class="chapter-number">04</span> ChatGPT: Personal Assistant Chatbot
        </h1>

        <div class="metadata">
            <a href="https://bytebytego.com/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot" target="_blank" rel="noopener">Original source</a>
        </div>

        <article>
            <header><strong class="style_chapter__grtAe">04</strong><h1>ChatGPT: Personal Assistant Chatbot</h1></header><h2 id="introduction">Introduction</h2>
<p>ChatGPT [1] is a chatbot that was developed by OpenAI and launched in 2022. It generates human-like text based on the input it receives. The chatbot can assist with various tasks, including answering questions, providing explanations, and producing creative content.</p>
<p>ChatGPT has quickly become one of the most adopted applications in history. It gained over 100 million users in less than three months after its launch [2]. This rapid growth highlights the capabilities of generative AI and its potential to help with day-to-day tasks and enhance productivity. In this chapter, we examine the key components of building a chatbot similar to ChatGPT.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simulated ChatGPT interaction.  At the top, 'ChatGPT' is labeled, suggesting a user interface for interacting with the large language model.  Below this, a user input box contains the prompt: 'write a short message so I apologize my manage...'.  Two response bubbles, each preceded by a small, stylized circular logo, appear below. The first response bubble contains the text 'Sorry for the inconvenience.' and the second contains 'Sorry for my mistak...'.  To the right, another response bubble shows a user's follow-up message: 'inconvenience? lol'. At the bottom, a button labeled 'Message ChatGPT' is shown with an upward-pointing arrow next to it, indicating the direction of message submission to the ChatGPT model.  The overall arrangement suggests a conversational flow, with the user's prompt initiating the interaction, followed by ChatGPT's responses and a subsequent user interaction." loading="lazy" width="532" height="340" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-1-UACMX5Y5.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 1: Example of a conversation with ChatGPT</figcaption></div></figure>
<h2 id="clarifying-requirements">Clarifying Requirements</h2>
<p>Here is a typical interaction between a candidate and an interviewer:</p>
<p><strong>Candidate</strong>: What languages should the chatbot support?<br>
<strong>Interviewer</strong>: Initially, let’s focus on English.</p>
<p><strong>Candidate</strong>: We need to ensure the chatbot generates unbiased and safe outputs by having strict content moderation and algorithms in place. Is that a fair assumption?<br>
<strong>Interviewer</strong>: Certainly.</p>
<p><strong>Candidate</strong>: Can you specify the range of tasks the chatbot is expected to perform?<br>
<strong>Interviewer</strong>: The chatbot should be able to handle tasks like providing information and answering questions.</p>
<p><strong>Candidate:</strong> Does the chatbot take in or output non-text modalities, such as image, audio, or video?<br>
<strong>Interviewer:</strong> Let’s focus on a text-only chatbot for now. The input and the output are both text.</p>
<p><strong>Candidate</strong>: Should the chatbot handle follow-up questions? How long should the chatbot maintain the conversation context?<br>
<strong>Interviewer</strong>: Good question. The chatbot should be able to handle follow-up questions within the same conversation session. Let’s say it is expected to have a context window of at least 4096 tokens.</p>
<p><strong>Candidate:</strong> Is the chatbot expected to be able to browse websites, call external API, or search online?<br>
<strong>Interviewer</strong>: Let’s not focus on that in this round.</p>
<p><strong>Candidate</strong>: Should the chatbot personalize its interactions with users?<br>
<strong>Interviewer</strong>: Let’s not focus on personalization.</p>
<p><strong>Candidate</strong>: Do we have instruction-based training data?<br>
<strong>Interviewer</strong>: Yes, we have a dataset with 80,000 examples of instructions and answers.</p>
<h2 id="frame-the-problem-as-an-ml-task">Frame the Problem as an ML Task</h2>
<h3 id="specifying-the-systems-input-and-output">Specifying the system’s input and output</h3>
<p>The input to the chatbot is a text prompt provided by the user. The prompt can be a question, a command, or any other form of textual query. The output is a relevant and contextually appropriate response generated by the chatbot.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simple data flow diagram illustrating a user interaction with a chatbot.  The diagram shows a left-to-right flow.  On the left, the user input 'where bill gates...' is depicted.  A black arrow points from this input to a rectangular box representing the 'Chatbot,' which is colored light orange with a golden-yellow border.  The chatbot processes the input.  Another black arrow then points from the chatbot box to the output on the right, which displays the response 'Bill Gates was born in Seattle,...'.  The text 'Text is not SVG - cannot display' is present at the bottom of the chatbot box, indicating a technical note about the image's creation. The overall structure demonstrates a basic question-answer interaction where a user query is fed into a chatbot, which then generates a relevant response." loading="lazy" width="540" height="67" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-2-7UEMS34K.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 2: Input and output of a chatbot</figcaption></div></figure>
<h3 id="choosing-a-suitable-ml-approach">Choosing a suitable ML approach</h3>
<p>Developing a chatbot is a language generation task in which a language model processes an input prompt and generates a response. This language model typically needs billions of parameters to learn effectively; hence, they are often called large language models (LLMs).</p>
<p>As we saw in previous chapters, the decoder-only Transformer is the standard architectural choice in language models. Most modern LLMs, such as OpenAI’s GPT [3], Google’s Gemini [4], and Meta's Llama [5], are all based on the decoder-only Transformer. In line with these models, we use a decoder-only</p>
<h2 id="data-preparation">Data Preparation</h2>
<p>The effectiveness of an LLM depends on the quality of its training data, which mainly comes from web sources. This data, often automatically crawled from websites, forums, and blogs, requires special considerations and careful preparation. The most common steps include:</p>
<ul>
<li><strong>Content extraction and parsing:</strong> Web-crawled data often contains extraneous elements, for example, HTML tags, advertisements, and navigation links. This step involves parsing the raw HTML content using libraries such as Beautiful Soup [6] or lxml [7] and extracting the main text body while discarding irrelevant sections. Techniques such as DOM analysis [8] and boilerplate detection [9] are applied to isolate and retain the core content relevant to language modeling.</li>
<li><strong>URL and domain filtering:</strong> Not all web domains provide high-quality or relevant content. URL filtering uses predefined rules or machine learning (ML) classifiers to exclude unwanted sources, for example, low-quality blogs, content farms, or spam sites. Domain allowlisting or blocklisting techniques are also applied to curate data from trusted and relevant sources, ensuring the dataset’s quality and reliability.</li>
<li><strong>Language identification:</strong> Crawled data often includes multilingual content, which needs to be filtered to match the target language(s) for training. Language detection tools such as fastText [10] or langid.py [11] are employed to classify and filter documents.</li>
<li><strong>Content quality filtering:</strong> Not all web content is equally valuable for training purposes. Quality assessment techniques, including readability scoring, spam detection algorithms, and heuristic checks (e.g., content length, sentence structure), are used to evaluate and filter low-quality text. ML models can also be employed to predict the quality of web content based on features extracted from the text. This step is crucial to ensure that only high-quality data is used for training.</li>
</ul>
<p>Along with these techniques, the following are commonly applied to both web-crawled data and other data sources, such as books, articles, and social media posts:</p>
<ul>
<li><strong>Remove inappropriate content:</strong> We use ML models to remove offensive, harmful, or NSFW content from training data. This ensures our model learns only appropriate and safe content.</li>
<li><strong>Anonymize sensitive information:</strong> We anonymize any personally identifiable information (PII) in the dataset. This step is crucial to comply with privacy laws and ethical guidelines.</li>
<li><strong>Remove low-quality data</strong>: We use ML models to remove low-quality text data. The models assess coherence, relevance, grammar, and readability. This step ensures the training data is high in quality and useful for training.</li>
<li><strong>Remove duplicated data (Deduplication)</strong>: We remove similar texts that might be present in different sources. For example, if the same news article is collected from multiple websites, we identify and retain only one copy. This step reduces redundancy in the training dataset and ensures the model is not overexposed to certain data.</li>
<li><strong>Remove irrelevant data</strong>: We use heuristics and rule-based methods to remove irrelevant data. For example, we remove texts with non-standard characters or in languages that the chatbot is not expected to support.</li>
<li><strong>Tokenize text:</strong> We use a subword tokenization algorithm such as Byte-Pair Encoding (BPE) to tokenize the text data. To review BPE, refer to Chapter 3.</li>
</ul>
<h2 id="model-development">Model Development</h2>
<h3 id="architecture">Architecture</h3>
<p>The LLM’s architecture is based on a decoder-only Transformer. While the text embedding, Transformer blocks, and the prediction head are similar to the decoder-only Transformer discussed in Chapter 2, LLMs typically use more advanced positional encoding methods.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a diagram of a text generation model architecture.  At the bottom is a 'Text Embedding' layer, which presumably converts input text into numerical vectors. Above this is a 'Positional Encoding' layer, adding positional information to the embedded vectors.  The core of the model is a 'Transformer' block, which consists of a vertically stacked sequence of layers. This sequence is repeated Nx times, indicated by a curly brace and the label 'Nx'. Each repetition within the Transformer includes a 'Normalization' layer, a 'Feed Forward' layer, and another 'Normalization' layer, followed by a 'Multi-head...' layer (the ellipsis suggests further details omitted from the diagram). Finally, at the top is a 'Prediction Head' layer, responsible for generating the output text based on the processed information from the Transformer.  The data flow is bottom-up: text is embedded, positional information is added, then the data passes through the repeated Transformer layers, and finally, the prediction head generates the output." loading="lazy" width="192" height="276" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-3-XRPKKJCN.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 3: Components of a decoder-only Transformer</figcaption></div></figure>
<p>Let’s examine LLM’s positional encoding in more detail.</p>
<h4 id="positional-encoding">Positional encoding</h4>
<p>In a chatbot setting, the input sequence is typically much longer than a single sentence or email. As per the interviewer’s requirements, our goal is to build a system with a context window of at least 4096 tokens. This requires a positional encoding method that allows the model to understand the positions of all the tokens and the relationships between them.</p>
<p>In this section, we begin with a brief review of absolute positional encoding followed by an exploration of relative positional encoding. Finally, we delve into rotary positional embedding (RoPE) [12], a robust positional encoding method used by popular LLMs such as Llama 3 [13].</p>
<h5 id="absolute-positional-encoding">Absolute positional encoding</h5>
<p>Absolute positional encoding refers to traditional methods such as sinusoidal or learnable encodings whereby each position in a sequence is represented by a unique vector.</p>
<p>In this approach, encoded positions are then added to the token embeddings, providing the model with information about where each token appears in the sequence. Formally, the attention keys and queries are computed using the following equations:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>q</mi><mi>m</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi>W</mi><mi>q</mi></msub><mrow><mo fence="true">(</mo><msub><mi>e</mi><mi>m</mi></msub><mo>+</mo><msub><mi>p</mi><mi>m</mi></msub><mo fence="true">)</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>k</mi><mi>n</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi>W</mi><mi>k</mi></msub><mrow><mo fence="true">(</mo><msub><mi>e</mi><mi>n</mi></msub><mo>+</mo><msub><mi>p</mi><mi>n</mi></msub><mo fence="true">)</mo></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
	q_m &amp; =W_q\left(e_m+p_m\right) \\
	k_n &amp; =W_k\left(e_n+p_n\right)
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 3em; vertical-align: -1.25em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.75em;"><span style="top: -3.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span><span style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0315em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.25em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.75em;"><span style="top: -3.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span><span style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.25em;"><span></span></span></span></span></span></span></span></span></span></span></span>
<p>Where:</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">q_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> is the query vector at position <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span>,</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>k</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">k_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8444em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0315em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> is the key vector at position <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>,</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">W_q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">W_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> are learnable weight matrices,</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">e_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">e_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> are token embeddings at positions <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>,</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">p_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">p_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> are positional vectors (either learnable or fixed) at positions <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>.</li>
</ul>
<p>The attention score is calculated as a dot product of the query and key vectors:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>q</mi><mi>m</mi></msub><mo>⋅</mo><msub><mi>k</mi><mi>n</mi></msub><mo>=</mo><msub><mi>e</mi><mi>m</mi></msub><msub><mi>W</mi><mi>q</mi></msub><msub><mi>W</mi><mi>k</mi></msub><msub><mi>e</mi><mi>n</mi></msub><mo>+</mo><msub><mi>e</mi><mi>m</mi></msub><msub><mi>W</mi><mi>q</mi></msub><msub><mi>W</mi><mi>k</mi></msub><msub><mi>p</mi><mi>n</mi></msub><mo>+</mo><msub><mi>p</mi><mi>m</mi></msub><msub><mi>W</mi><mi>q</mi></msub><msub><mi>W</mi><mi>k</mi></msub><msub><mi>e</mi><mi>n</mi></msub><mo>+</mo><msub><mi>p</mi><mi>m</mi></msub><msub><mi>W</mi><mi>q</mi></msub><msub><mi>W</mi><mi>k</mi></msub><msub><mi>p</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">q_m \cdot k_n=e_m W_q W_k e_n+e_m W_q W_k p_n+p_m W_q W_k e_n+p_m W_q W_k p_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6389em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.8444em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0315em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span></span>
<p>Notice that positional encodings <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">p_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">p_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> depend only on absolute positions. Therefore, this approach captures only information about absolute position, limiting the model's ability to capture relative distances between tokens and generalize to sequences with different lengths or unseen token positions. For example, a model trained on sequences of up to 512 tokens may struggle to generalize when applied to sequences with 4096 tokens. The sinusoidal patterns tend to become repetitive over long distances, resulting in a loss of information about token relationships. This shortcoming is addressed by relative positional encoding.</p>
<h5 id="relative-positional-encoding">Relative positional encoding</h5>
<p>In relative positional encoding, instead of encoding the absolute positions of tokens, we encode the differences in the positions of two tokens. This way, the model can focus on the relative distances between tokens, which is often more important than their absolute positions. For example, in a sentence, knowing that the word "car" follows the word "chased" is more informative than knowing the positions of the tokens as numbers 5 and 10.</p>
<p>The attention calculation in relative positional encoding can be expressed in different ways. The T5 paper [14] suggests that the second and the third interaction terms in the original expression in absolute positional encoding can be dropped and that the fourth term could be replaced by a learnable bias:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>q</mi><mi>m</mi></msub><mo>⋅</mo><msub><mi>k</mi><mi>n</mi></msub><mo>=</mo><msub><mi>e</mi><mi>m</mi></msub><msub><mi>W</mi><mi>q</mi></msub><msub><mi>W</mi><mi>k</mi></msub><msub><mi>e</mi><mi>n</mi></msub><mo>+</mo><msub><mi>b</mi><mrow><mi>m</mi><mo separator="true">,</mo><mi>n</mi></mrow></msub></mrow><annotation encoding="application/x-tex">q_m \cdot k_n=e_m W_q W_k e_n+b_{m, n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6389em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.8444em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0315em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.9805em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span></span></span></span></span></span></span></span></span></span></span>
<p>In contrast, the DeBerta paper [15] drops the last term and replaces the second and third terms, which consist of the absolute positional vectors <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">p_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">p_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span>, respectively, with the relative positional vector <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mrow><mi>n</mi><mo>−</mo><mi>m</mi></mrow></msub></mrow><annotation encoding="application/x-tex">R_{n-m}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8917em; vertical-align: -0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2583em;"><span style="top: -2.55em; margin-left: -0.0077em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span></span></span></span></span></span></span></span></span></span> :</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>q</mi><mi>m</mi></msub><mo>⋅</mo><msub><mi>k</mi><mi>n</mi></msub><mo>=</mo><msub><mi>e</mi><mi>m</mi></msub><msub><mi>W</mi><mi>q</mi></msub><msub><mi>W</mi><mi>k</mi></msub><msub><mi>e</mi><mi>n</mi></msub><mo>+</mo><msub><mi>e</mi><mi>m</mi></msub><msub><mi>W</mi><mi>q</mi></msub><msub><mi>W</mi><mi>k</mi></msub><msub><mi>R</mi><mrow><mi>n</mi><mo>−</mo><mi>m</mi></mrow></msub><mo>+</mo><msub><mi>R</mi><mrow><mi>n</mi><mo>−</mo><mi>m</mi></mrow></msub><msub><mi>W</mi><mi>q</mi></msub><msub><mi>W</mi><mi>k</mi></msub><msub><mi>e</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">q_m \cdot k_n=e_m W_q W_k e_n+e_m W_q W_k R_{n-m}+R_{n-m} W_q W_k e_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6389em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.8444em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0315em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2583em;"><span style="top: -2.55em; margin-left: -0.0077em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2583em;"><span style="top: -2.55em; margin-left: -0.0077em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span></span>
<p>Relative positional encoding allows the model to understand the relationships between tokens independently of their absolute positions. However, it introduces additional complexity because <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mi>m</mi></msub><mo>⋅</mo><msub><mi>k</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">q_m \cdot k_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6389em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.8444em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0315em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> in the attention mechanism can no longer be reduced to a simple dot product. This limits our ability to use efficient techniques such as linear attention [16].
RoPE, which we examine next, addresses this limitation by encoding both absolute and relative positional information through a rotation in the embedding space.</p>
<h5 id="rotary-positional-encoding-rope">Rotary positional encoding (RoPE)</h5>
<p>RoPE represents positional information as a rotation matrix applied to the token embeddings.<br>
This can be described mathematically as follows: Given an input sequence, RoPE applies a rotation matrix to each embedding. This transformation can be expressed as:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mrow><mo fence="true">(</mo><msub><mi>q</mi><mi>m</mi></msub><mo separator="true">,</mo><mi>m</mi><mo fence="true">)</mo></mrow><mo>=</mo><msub><mi>q</mi><mi>m</mi></msub><mo>⋅</mo><mi>R</mi><mrow><mo fence="true">(</mo><msub><mi>θ</mi><mi>m</mi></msub><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">f\left(q_m, m\right)=q_m \cdot R\left(\theta_m\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.10764em;">f</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">m</span><span class="mclose delimcenter" style="top: 0em;">)</span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6389em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.00773em;">R</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span></span></span>
<p>where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">q_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> is token embedding at the position <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span>, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mrow><mo fence="true">(</mo><msub><mi>θ</mi><mi>m</mi></msub><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">R\left(\theta_m\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.00773em;">R</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span></span> is a rotation matrix parameterized by the positional angle <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">\theta_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8444em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span>. This angle is typically derived from the position index <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> and is constructed in such a way that the rotation captures both the absolute and relative position information. This rotation matrix, constructed using trigonometric functions, rotates the embeddings in the complex plane, capturing both absolute and relative positional information.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a comparison of two 2D vector representations.  The left side shows a Cartesian coordinate system (x and y axes) with two vectors originating from the origin (0,0). A reddish-brown vector labeled 'cat' points upward and to the right, and a blue-gray vector labeled 'dog' points upward and to the right at a smaller angle than the 'cat' vector.  A curved arrow indicates an angle θ between the two vectors. Below the graph, the text 'The cat chased the dog' is written. The right side mirrors the structure, also showing a Cartesian coordinate system with two vectors originating from the origin.  However, the 'cat' vector (reddish-brown) points upward and to the left, while the 'dog' vector (blue-gray) points upward and to the right.  The angle θ between these vectors is also indicated by a curved arrow. Below this graph, the text 'Once upon a time, the cat ch...' is partially visible, suggesting a narrative context.  The overall image uses vector diagrams to potentially illustrate different interpretations or scenarios related to the phrase 'the cat chased the dog,' highlighting the change in relative vector directions and the angle between them." loading="lazy" width="524" height="217" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-4-324BQF7V.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 4: RoPE in 2D</figcaption></div></figure>
<p>Figure 4 shows how rotational position encoding works by rotating word embeddings in a two-dimensional space. The words "cat" and "dog" are represented as vectors, and the angle between them, denoted by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal" style="margin-right: 0.02778em;">θ</span></span></span></span> , encodes their positional relationship. On the left, the sentence is “The cat chased the dog.” The position of "cat" is shown in red, and the position of "dog" is shown in blue. The angle between these vectors captures the relative positioning of these two words in the sentence.</p>
<p>On the right, another sentence “Once upon a time, the cat chased the dog” is shown. Notice that the relative angle between the "cat" and "dog" vectors is still the same, but their absolute positions are different. This demonstrates how RoPE captures both the absolute and relative positions of words, allowing the model to understand the order and distance between words in a sentence.</p>
<p>In a higher-dimensional space, the rotation matrix can be extended to accommodate <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> dimensions:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>R</mi><mrow><mi>θ</mi><mo separator="true">,</mo><mi>m</mi></mrow><mi>d</mi></msubsup><mo>=</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center center center center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>cos</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mi>m</mi><msub><mi>θ</mi><mn>1</mn></msub><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi>sin</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mi>m</mi><msub><mi>θ</mi><mn>1</mn></msub><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>sin</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mi>m</mi><msub><mi>θ</mi><mn>1</mn></msub><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>cos</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mi>m</mi><msub><mi>θ</mi><mn>1</mn></msub><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>cos</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mi>m</mi><msub><mi>θ</mi><mn>2</mn></msub><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi>sin</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mi>m</mi><msub><mi>θ</mi><mn>2</mn></msub><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>sin</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mi>m</mi><msub><mi>θ</mi><mn>2</mn></msub><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>cos</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mi>m</mi><msub><mi>θ</mi><mn>2</mn></msub><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋱</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>cos</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mi>m</mi><msub><mi>θ</mi><mrow><mi>d</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></msub><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi>sin</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mi>m</mi><msub><mi>θ</mi><mrow><mi>d</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></msub><mo fence="true">)</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>sin</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mi>m</mi><msub><mi>θ</mi><mrow><mi>d</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></msub><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>cos</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mi>m</mi><msub><mi>θ</mi><mrow><mi>d</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></msub><mo fence="true">)</mo></mrow></mrow></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">	R_{\theta, m}^d=\left(\begin{array}{ccccccc}
		\cos \left(m \theta_1\right) &amp; -\sin \left(m \theta_1\right) &amp; 0 &amp; 0 &amp; \cdots &amp; 0 &amp; 0 \\
		\sin \left(m \theta_1\right) &amp; \cos \left(m \theta_1\right) &amp; 0 &amp; 0 &amp; \cdots &amp; 0 &amp; 0 \\
		0 &amp; 0 &amp; \cos \left(m \theta_2\right) &amp; -\sin \left(m \theta_2\right) &amp; \cdots &amp; 0 &amp; 0 \\
		0 &amp; 0 &amp; \sin \left(m \theta_2\right) &amp; \cos \left(m \theta_2\right) &amp; \cdots &amp; 0 &amp; 0 \\
		\vdots &amp; \vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots &amp; \vdots \\
		0 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots &amp; \cos \left(m \theta_{d / 2}\right) &amp; -\sin \left(m \theta_{d / 2}\right) \\
		0 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots &amp; \sin \left(m \theta_{d / 2}\right) &amp; \cos \left(m \theta_{d / 2}\right)
	\end{array}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1.2822em; vertical-align: -0.3831em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8991em;"><span style="top: -2.453em; margin-left: -0.0077em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.02778em;">θ</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span><span style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3831em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 9.08em; vertical-align: -4.29em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 4.7499em;"><span style="top: -6.7499em;"><span class="pstrut" style="height: 11em;"></span><span style="width: 0.875em; height: 9em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.875em" height="9.000em" viewBox="0 0 875 9000"><path d="M863,9c0,-2,-2,-5,-6,-9c0,0,-17,0,-17,0c-12.7,0,-19.3,0.3,-20,1
c-5.3,5.3,-10.3,11,-15,17c-242.7,294.7,-395.3,682,-458,1162c-21.3,163.3,-33.3,349,
-36,557 l0,5484c0.2,6,0,26,0,60c2,159.3,10,310.7,24,454c53.3,528,210,
949.7,470,1265c4.7,6,9.7,11.7,15,17c0.7,0.7,7,1,19,1c0,0,18,0,18,0c4,-4,6,-7,6,-9
c0,-2.7,-3.3,-8.7,-10,-18c-135.3,-192.7,-235.5,-414.3,-300.5,-665c-65,-250.7,-102.5,
-544.7,-112.5,-882c-2,-104,-3,-167,-3,-189
l0,-5492c0,-162.7,5.7,-314,17,-454c20.7,-272,63.7,-513,129,-723c65.3,
-210,155.3,-396.3,270,-559c6.7,-9.3,10,-15.3,10,-18z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 4.2501em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 4.79em;"><span style="top: -7.6375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mop">cos</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span><span style="top: -6.4375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mop">sin</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span><span style="top: -5.2375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top: -4.0375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top: -2.1775em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span style="top: -0.9675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top: 0.2425em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 4.29em;"><span></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 4.79em;"><span style="top: -7.6375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">−</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop">sin</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span><span style="top: -6.4375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mop">cos</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span><span style="top: -5.2375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top: -4.0375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top: -2.1775em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span style="top: -0.9675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top: 0.2425em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 4.29em;"><span></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 4.79em;"><span style="top: -7.6375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top: -6.4375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top: -5.2375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mop">cos</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span><span style="top: -4.0375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mop">sin</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span><span style="top: -2.1775em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span style="top: -0.9675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top: 0.2425em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 4.29em;"><span></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 4.79em;"><span style="top: -7.6375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top: -6.4375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top: -5.2375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">−</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop">sin</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span><span style="top: -4.0375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mop">cos</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span><span style="top: -2.1775em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span style="top: -0.9675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top: 0.2425em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 4.29em;"><span></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 4.79em;"><span style="top: -7.45em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="minner">⋯</span></span></span><span style="top: -6.25em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="minner">⋯</span></span></span><span style="top: -5.05em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="minner">⋯</span></span></span><span style="top: -3.85em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="minner">⋯</span></span></span><span style="top: -1.99em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="minner">⋱</span></span></span><span style="top: -0.78em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="minner">⋯</span></span></span><span style="top: 0.43em;"><span class="pstrut" style="height: 3.5em;"></span><span class="mord"><span class="minner">⋯</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 4.29em;"><span></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 4.79em;"><span style="top: -7.6375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top: -6.4375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top: -5.2375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top: -4.0375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top: -2.1775em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span style="top: -0.9675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mop">cos</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size1">(</span></span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em;"><span style="top: -2.5198em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mtight">/2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3552em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size1">)</span></span></span></span></span><span style="top: 0.2425em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mop">sin</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size1">(</span></span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em;"><span style="top: -2.5198em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mtight">/2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3552em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size1">)</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 4.29em;"><span></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 4.79em;"><span style="top: -7.6375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top: -6.4375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top: -5.2375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top: -4.0375em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top: -2.1775em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width: 0em; border-top-width: 1.5em; bottom: 0em;"></span></span></span></span><span style="top: -0.9675em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mord">−</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop">sin</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size1">(</span></span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em;"><span style="top: -2.5198em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mtight">/2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3552em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size1">)</span></span></span></span></span><span style="top: 0.2425em;"><span class="pstrut" style="height: 3.6875em;"></span><span class="mord"><span class="mop">cos</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size1">(</span></span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em;"><span style="top: -2.5198em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mtight">/2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3552em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size1">)</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 4.29em;"><span></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 4.7499em;"><span style="top: -6.7499em;"><span class="pstrut" style="height: 11em;"></span><span style="width: 0.875em; height: 9em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.875em" height="9.000em" viewBox="0 0 875 9000"><path d="M76,0c-16.7,0,-25,3,-25,9c0,2,2,6.3,6,13c21.3,28.7,42.3,60.3,
63,95c96.7,156.7,172.8,332.5,228.5,527.5c55.7,195,92.8,416.5,111.5,664.5
c11.3,139.3,17,290.7,17,454c0,28,1.7,43,3.3,45l0,5409
c-3,4,-3.3,16.7,-3.3,38c0,162,-5.7,313.7,-17,455c-18.7,248,-55.8,469.3,-111.5,664
c-55.7,194.7,-131.8,370.3,-228.5,527c-20.7,34.7,-41.7,66.3,-63,95c-2,3.3,-4,7,-6,11
c0,7.3,5.7,11,17,11c0,0,11,0,11,0c9.3,0,14.3,-0.3,15,-1c5.3,-5.3,10.3,-11,15,-17
c242.7,-294.7,395.3,-681.7,458,-1161c21.3,-164.7,33.3,-350.7,36,-558
l0,-5544c-2,-159.3,-10,-310.7,-24,-454c-53.3,-528,-210,-949.7,
-470,-1265c-4.7,-6,-9.7,-11.7,-15,-17c-0.7,-0.7,-6.7,-1,-18,-1z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 4.2501em;"><span></span></span></span></span></span></span></span></span></span></span></span>
<center>Figure 5: Rotation matrix <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>R</mi><mrow><mi>θ</mi><mo separator="true">,</mo><mi>m</mi></mrow><mi>d</mi></msubsup></mrow><annotation encoding="application/x-tex">R_{\theta, m}^d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1.2683em; vertical-align: -0.4192em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8491em;"><span style="top: -2.4169em; margin-left: -0.0077em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.02778em;">θ</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span><span style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.4192em;"><span></span></span></span></span></span></span></span></span></span> with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> dimension parameterized by positional angle <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal" style="margin-right: 0.02778em;">θ</span></span></span></span> </center>
<h5 id="pros">Pros:</h5>
<ul>
<li><strong>Translational invariance:</strong> RoPE encodes positional information in a way that remains consistent even when the positions of tokens shift. This helps the model handle changes in position better than other methods.</li>
<li><strong>Relative position representation:</strong> RoPE’s rotations encode positional information geometrically within the embedding space. This enables the model to inherently understand the relative distances between tokens, unlike traditional sinusoidal encodings, which encode position additively without leveraging this geometric insight.</li>
<li><strong>Generalization to unseen positions:</strong> Because RoPE encodes position through rotations, the resulting embeddings maintain consistent relationships, regardless of absolute position. This allows for better generalization across varying sequence lengths.</li>
</ul>
<h5 id="cons">Cons:</h5>
<ul>
<li><strong>Mathematical complexity</strong>: RoPE introduces additional mathematical operations involving rotations in the embedding space. While these are not overly complex, they are more intricate than traditional positional encoding methods such as sinusoidal or learned positional embeddings.</li>
</ul>
<h3 id="training">Training</h3>
<p>In earlier chapters, we explored a two-stage strategy for training language models. However, those stages are not sufficient when training advanced chatbots. Most chatbots, including ChatGPT, use a three-stage training strategy:</p>
<ul>
<li>Pretraining</li>
<li>Supervised finetuning (SFT)</li>
<li>Reinforcement learning from human feedback (RLHF)</li>
</ul>
<p>Let’s discuss each stage in more detail to understand its purpose.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a three-stage process for training a chatbot.  Three cylindrical databases labeled 'General...', 'Instruction...', and 'Human Feedba...' (presumably representing general data, instruction data, and human feedback data, respectively) feed into three sequential processing stages.  The first stage, '1. Pretraining,' uses the 'General...' data to create a 'Base Model' represented as a light gray cloud.  The output 'Base Model' is then fed, along with data from the 'Instruction...' database, into the second stage, '2. SFT' (Supervised Fine-Tuning), which produces an 'SFT Model,' also represented as a light gray cloud.  Finally, the 'SFT Model' and data from the 'Human Feedba...' database are input into the third stage, '3. RLHF' (Reinforcement Learning from Human Feedback), resulting in a final 'Chatbot...' output, depicted as a light green cloud.  Arrows clearly indicate the data flow between each component, showing a linear progression from raw data to a refined chatbot model." loading="lazy" width="375" height="277" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-6-XRSE67N2.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 6: Three stages of training an LLM</figcaption></div></figure>
<h4 id="1-pretraining">1. Pretraining</h4>
<p>Pretraining is the initial stage of the training process. In this stage, a model is trained with an enormous volume of text data from the Internet. The purpose of pretraining is to create a base model with a broad understanding of language and world knowledge.</p>
<p>The pretraining stage requires significant computational resources. It typically requires thousands of GPUs, costs millions of dollars, and takes months of training.</p>
<h5 id="pretraining-data">Pretraining data</h5>
<p>The pretraining data typically consists of a large corpus of general text data from various sources on the Internet, for example, web pages, books, and social media posts.</p>
<p>Several datasets are commonly used when pretraining LLMs. Each serves a unique purpose, from broadening the model's exposure to diverse language styles to deepening its understanding of specific domains. Commonly used datasets are:</p>
<ul>
<li><strong>Common Crawl:</strong> Common Crawl [17] is a publicly available dataset collected from a large number of web pages on the internet. It contains petabytes of data that have been regularly collected since 2008. This data often includes irrelevant information and harmful content; hence, significant data cleaning is needed to make it suitable for training LLMs.</li>
<li><strong>C4:</strong> C4 [18], created by Google, is a cleaned version of the Common Crawl dataset specifically used for training LLMs.</li>
<li><strong>GitHub:</strong> The GitHub dataset comprises a vast collection of open-source code repositories. Its purpose is to help the model understand programming languages and code structures.</li>
<li><strong>Wikipedia:</strong> The Wikipedia dataset includes a wide range of factual information extracted from Wikipedia. This dataset is generally a more reliable source because it is written and edited more carefully.</li>
<li><strong>Books:</strong> The books dataset is a collection of books across various genres. Books have long textual content and good data quality, both of which contribute to improving the performance of LLMs.</li>
<li><strong>ArXiv:</strong> The Arxiv dataset contains academic materials and published papers. This dataset helps the model understand the terminology and knowledge within the academic domain.</li>
<li><strong>Stack Exchange:</strong> Stack Exchange [19] is a website of high-quality questions and answers, primarily in the format of a dialogue between users.
Most popular LLMs are trained on all or some of the listed datasets. For example, Meta’s Llama-1 model uses all the above datasets, consisting of about 1.4 trillion tokens. Table 1 shows the proportion of each dataset used by Llama-1 during training.</li>
</ul>
<div class="table-wrap"><table><thead><tr><th>Dataset</th><th style="text-align: center;">Sampling proportion</th><th style="text-align: center;">Disk size</th></tr></thead><tbody><tr><td>Common Crawl</td><td style="text-align: center;">67.0%</td><td style="text-align: center;">3.3 TB</td></tr><tr><td>C4</td><td style="text-align: center;">15.0%</td><td style="text-align: center;">783 GB</td></tr><tr><td>Github</td><td style="text-align: center;">4.5%</td><td style="text-align: center;">328 GB</td></tr><tr><td>Books</td><td style="text-align: center;">4.5%</td><td style="text-align: center;">85 GB</td></tr><tr><td>Wikipedia</td><td style="text-align: center;">4.5%</td><td style="text-align: center;">83 GB</td></tr><tr><td>ArXiv</td><td style="text-align: center;">2.5%</td><td style="text-align: center;">92 GB</td></tr><tr><td>Stack Exchange</td><td style="text-align: center;">2.0%</td><td style="text-align: center;">78 GB</td></tr></tbody></table></div>
<p class="tableCaption">Table 1: Llama 1 pretraining dataset</p>
<h5 id="ml-objective-and-loss-function">ML objective and loss function</h5>
<p>As we are training a decoder-only Transformer for text generation, we use the standard next-token prediction as our ML objective. For the loss function, we employ cross-entropy loss to measure the difference between the predicted token probabilities and correct tokens.</p>
<h5 id="the-outcome-of-the-pretraining-stage">The outcome of the pretraining stage</h5>
<p>The pretraining stage produces a model that understands language well. This model, usually referred to as the base model, predicts text to follow the given input prompt, generating relevant and meaningful text.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simple, vertically oriented diagram enclosed within a dashed-line border.  At the bottom, the text 'I want to learn programming' is positioned. An upward-pointing arrow connects this text to a light orange, rectangular box labeled 'Base Model' in the center.  Another upward-pointing arrow extends from the top of the 'Base Model' box to the text 'because it is a valuable skill' at the top of the diagram. The arrows visually represent a causal relationship, suggesting that the desire to learn programming ('I want to learn programming') leads to engaging with a 'Base Model,' which in turn is motivated by the perceived value of programming as a skill ('because it is a valuable skill').  The overall structure is minimalistic, focusing on the core relationship between motivation, a foundational model, and the ultimate goal." loading="lazy" width="276" height="244" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-7-EE5JTSIQ.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 7: Base model continuing a sentence</figcaption></div></figure>
<p>While the base model understands language well, it is only capable of continuing on from the text prompt. To make the model a useful chatbot that answers questions, we need to further train the base model. This leads to the next stage: supervised finetuning.</p>
<h4 id="2-supervised-finetuning-sft">2. Supervised finetuning (SFT)</h4>
<p>SFT, also named instruction finetuning, is the second stage of the training process. In this stage, we finetune the base model on a smaller, high-quality dataset in a (prompt, response) format. The purpose of this stage is to preserve the base model’s language understanding and world knowledge while adapting its behavior to responding to prompts instead of just continuing them.</p>
<h5 id="training-data">Training data</h5>
<p>The training data for the SFT stage follows the (prompt, response) format. This data is usually called <strong>demonstration data</strong> because it demonstrates to the model how to respond to prompts.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simple, rectangular box with rounded corners, representing a system's input and output.  The top section, labeled 'Prompt...', is a blank space intended for user input, likely text-based, to initiate a process or query.  Below this, a larger blank space labeled 'Response...' is provided for the system's output, also presumably text-based, in response to the prompt.  There are no visible connections or arrows indicating information flow between the prompt and response areas; the implication is that the input in the 'Prompt...' area triggers a process within the unseen system, resulting in the output displayed in the 'Response...' area.  At the very bottom, in small text, is the note 'text is not SVG - cannot display,' indicating a limitation in displaying the image's underlying format." loading="lazy" width="537" height="236" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-8-ET7POLAV.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 8: An example of demonstration data</figcaption></div></figure>
<p>The main differences between demonstration data and pretraining data, aside from format, are size and quality.</p>
<p><strong>Size:</strong> Demonstration data is significantly smaller than pretraining data. It usually ranges from 10,000 to 100,000 (prompt, response) pairs. Table 2 shows the data sizes of popular demonstration datasets.</p>
<div class="table-wrap" style="--table-min-width: 400px;"><table><thead><tr><th>Dataset</th><th style="text-align: center;">Size</th><th>Notes</th></tr></thead><tbody><tr><td>InstructGPT [20]</td><td style="text-align: center;">~14,500</td><td>OpenAI’s GPT-3 instruction datasets</td></tr><tr><td>Alpaca [21]</td><td style="text-align: center;">52,000</td><td>Developed by Stanford researchers</td></tr><tr><td>Dolly-15K [22]</td><td style="text-align: center;">~15,000</td><td>Created by Databricks</td></tr><tr><td>FLAN 2022 [23]</td><td style="text-align: center;">~104,000</td><td>Developed by Google Research</td></tr></tbody></table></div>
<p class="tableCaption">Table 2: Common demonstration datasets</p>
<p><strong>Quality:</strong> Demonstration data is of higher quality compared to pretraining data. The data is usually created by educated human contractors. In specialized industries such as healthcare or finance, it is essential to hire domain experts to ensure the accuracy and relevance of data. For instance, as shown in Table 3, over one-third of OpenAI’s labelers for GPT’s demonstration dataset held a master’s degree [20]. While this requirement is costly, it's crucial for producing reliable, industry-specific responses.</p>
<div class="table-wrap"><table><thead><tr><th>Education</th><th style="text-align: center;">Percentage</th></tr></thead><tbody><tr><td>Less than a high school degree</td><td style="text-align: center;">0%</td></tr><tr><td>High school degree</td><td style="text-align: center;">10.5%</td></tr><tr><td>Undergraduate degree</td><td style="text-align: center;">52.6%</td></tr><tr><td>Master’s degree</td><td style="text-align: center;">36.8%</td></tr></tbody></table></div>
<p class="tableCaption"><p>Table 3: The education levels of OpenAI’s labelers</p></p>
<h5 id="ml-objective-and-loss-function-1">ML objective and loss function</h5>
<p>Although the training data differs from the pretraining stage, the model still learns a similar task: generating a text one token at a time based on the input prompt. Therefore, the ML objective and loss functions remain similar to those at the pretraining stage: next-token prediction ML objective and cross-entropy loss function.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simplified diagram of a sequence-to-sequence model, likely used in a machine translation or text generation task.  At the bottom, the input 'What is the capital...' is fed into a rectangular 'Model' component, which represents the core neural network.  The model processes this input and outputs 'Predicted token...', visualized as four vertically stacked rectangles representing token embeddings.  Above this, 'Correct tokens' ('It is Paris.') are shown as a similar set of four vertically stacked rectangles.  Arrows indicate the flow of information: the input feeds into the model, the model produces predicted tokens, and these predicted tokens are compared to the correct tokens.  The comparison is quantified by 'cross-entropy loss,' which is calculated and represented by an upward-pointing arrow from the predicted tokens to the correct tokens.  The entire system is enclosed within a dashed box.  The rectangles represent token embeddings, with each rectangle likely containing a vector representation of a word or sub-word unit." loading="lazy" width="296" height="389" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-9-TTMVEPKX.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 9: Loss calculation over a (prompt, response) example</figcaption></div></figure>
<h5 id="the-outcome-of-the-sft-stage">The outcome of the SFT stage</h5>
<p>The outcome of this stage is the SFT model, a finetuned version of the base model. Instead of merely continuing the text prompt, the SFT model generates detailed and helpful responses because it has been trained on demonstration data in a (prompt, response) format.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simple flowchart enclosed within a dashed-line box.  At the bottom, the text 'I want to learn programming' indicates the starting point or goal. An upward-pointing arrow connects this text to a light orange, rectangular box labeled 'SFT Model,' representing a specific model or system.  Another upward-pointing arrow connects the 'SFT Model' box to the text 'Start with Python' at the top, suggesting that Python is the recommended or suggested programming language to interact with or utilize the 'SFT Model.' The overall structure depicts a linear flow, implying that to achieve the goal of learning programming ('I want to learn programming'), one should utilize the 'SFT Model' and start with Python." loading="lazy" width="212" height="228" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-10-3KFNUWCW.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 10: The SFT model answers a prompt instead of continuing it</figcaption></div></figure>
<p>The SFT model usually generates a grammatically correct and reasonable response. However, it might not always generate the best response; its answers can be unhelpful or even unsafe. Figure 11 displays four plausible responses to a question. Only the second response is both safe and helpful. The first and fourth responses are grammatically and contextually correct but do not offer accurate advice. The third response is helpful but impolite.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simple flowchart illustrating a generative AI model's response to a user prompt.  A central rectangular box labeled 'PromptWhat are some effective w...' represents the user's input, a question likely seeking effective ways to manage stress or similar.  From this central box, four curved arrows point to four separate rectangular boxes, each labeled 'Response 1,' 'Response 2,' 'Response 3,' and 'Response 4,' respectively. Each response box contains a different suggestion: Response 1 suggests 'Go skydiving for an adrenaline...'; Response 2 suggests 'Exercise regularly and maintain...'; Response 3 offers the more critical 'Shame on you! Try meditation!!!'; and Response 4 provides the somewhat dismissive 'Ignore your problems and hope t...'. The arrows visually depict the flow of information, showing how the AI model generates multiple diverse responses based on a single user prompt." loading="lazy" width="549" height="340" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-11-3BHSLOH6.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 11: Various responses to a prompt</figcaption></div></figure>
<p>To ensure the model produces relevant, safe, and helpful responses, we must further finetune the model. This further finetuning is the primary focus of the next stage: RLHF.</p>
<h4 id="3-rlhf">3. RLHF</h4>
<p>RLHF, also known as the <strong>alignment</strong> stage, is the final stage in the training process. This stage aligns the model to human preferences, that is, it adapts the model to generate responses preferred by humans.</p>
<p>To understand RLHF, let's briefly revisit the SFT stage. In SFT, the model learns from demonstration data to produce a plausible response to a given prompt. However, demonstration data provides the model with one plausible response for a prompt, which is not necessarily the most helpful or relevant response. Usually, multiple responses can be plausible, and some will be more relevant than others, as shown in Figure 11.</p>
<p>If we have a separate reward model that can score how relevant a model’s response is to a prompt, we can further finetune the SFT model to generate not just any plausible response but one with a high score. This is the key idea behind RLHF. RLHF consists of two sequential steps:</p>
<ol>
<li>Training a reward model</li>
<li>Optimizing the SFT model</li>
</ol>
<h4 id="31-training-a-reward-model">3.1 Training a reward model</h4>
<p>The first step in RLHF is to train a reward model that evaluates the relevance of a response to a prompt. This model takes a (prompt, response) pair as input and produces a score predicting the helpfulness of the response. The higher the score, the more helpful the response is expected to be. Figure 12 illustrates the predicted scores for different (prompt, response) pairs.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a flowchart illustrating a reward model's scoring mechanism for two different responses to the same prompt.  The flowchart is divided into two sections by a dashed line, representing Example 1 and Example 2. Each section begins with a 'Prompt' box containing the text 'What are some effective w...', followed by a 'Response' box.  Example 1's response is 'Exercise regularly and maintain...', while Example 2's response is 'Shame on you! Try meditation!!!'.  Each 'Response' box is connected to a 'Reward Model' box (represented in light purple).  The 'Reward Model' processes the response and outputs a 'Score' to a circular box.  Example 1 receives a score of '5', while Example 2 receives a score of '1', indicating that the reward model assigns higher scores to responses deemed more effective or appropriate based on some underlying criteria not explicitly shown in the diagram.  The arrows clearly show the flow of information from the prompt and response to the reward model and finally to the score." loading="lazy" width="597" height="269" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-12-ZOPQFBTX.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 12: Reward model input and output</figcaption></div></figure>
<h5 id="reward-model-architecture">Reward model architecture</h5>
<p>Training a model to output a score is a very common task in ML. There are various architectures we can employ for reward modeling: It can be a decoder-only, encoder-only, or encoder-decoder Transformer as long as it outputs a scalar value.</p>
<p>Based on public studies, there isn't a consistent pattern of reward models being larger or smaller than the language models they are used to train. For example, OpenAI uses a 6B reward model for the 175B language model [20]. Anthropic uses language models and reward models ranging from 10B to 52B parameters [24]. A typical option is to create a copy of the SFT model and add a prediction head to produce the relevance score for the given (prompt, response) pair.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a system for evaluating the quality of responses generated by a language model.  At the bottom, a 'Prompt' ('What is 2+2?') and a 'Response' ('Math is hard.') are input into a 'Reward Model...'. This model processes the prompt and response, producing multiple intermediate representations (shown as vertically stacked rectangles), which are then aggregated.  These aggregated representations are fed into a 'Prediction He...' module, which generates a prediction.  Finally, a 'score' (0.3 in this example) is output, representing the quality of the response as assessed by the system.  The ellipsis (...) indicates that multiple intermediate representations are generated by the Reward Model, suggesting a process involving multiple steps or features for evaluating the response.  The arrows depict the flow of information between the components." loading="lazy" width="252" height="431" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-13-ABOKVB4D.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 13: Reward model architecture</figcaption></div></figure>
<h5 id="training-data-1">Training data</h5>
<p>To collect training data for reward modeling, we follow these steps:</p>
<ol>
<li><strong>Collect prompts:</strong> Manually create a list of prompts.</li>
<li><strong>Generate multiple responses:</strong> Use the SFT model to generate multiple responses for each prompt.</li>
<li><strong>Rank responses:</strong> Ask contractors to evaluate those responses and rank them based on their relevance. The reason they typically rank them instead of scoring each response is that ranking reduces subjectivity and inconsistency. It is easier and more intuitive for annotators to compare responses directly than to assign numerical scores, which can vary between annotators. This approach simplifies the evaluation process and ensures more reliable data for training.</li>
<li><strong>Create preference pairs:</strong> Construct the training dataset by forming pairs in the format (prompt, winning response, losing response). In each pair, the winning response is preferred over the losing response based on the rankings from the previous step.</li>
</ol>
<p>Figure 14 shows the process of collecting training data to train the reward model.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a system for evaluating responses from a Large Language Model (LLM).  The process begins (1) with a prompt list containing questions like 'What is the capital of France?', 'Name a famous physicist?', 'What's 2 + 2?', and 'Give a synonym for 'happy.''.  These prompts are fed (2) into an 'SFT Model' (likely a fine-tuned large language model), which generates three different responses (Response 1, Response 2, Response 3) for each prompt.  A human evaluator (3) then reviews these responses and determines a 'winning' and 'losing' response for each prompt, based on accuracy and quality. This information is compiled (4) into a table showing the winning and losing responses for each prompt. Finally, the evaluator provides rankings (R1 &gt; R2 &gt; R3, for example) indicating the relative quality of the three responses for each prompt, providing feedback on the LLM's performance.  The entire diagram illustrates a human-in-the-loop evaluation process for ranking the quality of LLM responses." loading="lazy" width="812" height="579" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(812px, 100vw), (max-width: 1200px) min(812px, 80vw), min(812px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-14-W7RQHVNH.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-14-W7RQHVNH.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-14-W7RQHVNH.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-14-W7RQHVNH.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-14-W7RQHVNH.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-14-W7RQHVNH.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-14-W7RQHVNH.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-14-W7RQHVNH.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-14-W7RQHVNH.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 14: Collecting training data to train a reward model</figcaption></div></figure>
<p>Once we collect the training data, where each example is in (prompt, winning response, losing response) format, we define the ML objective and the associated loss function to train our reward model.</p>
<h5 id="ml-objective-and-loss-function-2">ML objective and loss function</h5>
<p>The reward model aims to predict a higher score for the winning response compared to the losing response. More formally, for a given (prompt, winning response, losing response), the ML objective is to maximize <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mtext>win&nbsp;</mtext></msub><mo>−</mo><msub><mi>S</mi><mtext>lose&nbsp;</mtext></msub></mrow><annotation encoding="application/x-tex">S_{\text {win }}-S_{\text {lose }}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3175em;"><span style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">win&nbsp;</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">lose&nbsp;</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span>, where:</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mtext>win&nbsp;</mtext></msub></mrow><annotation encoding="application/x-tex">S_{\text {win }}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3175em;"><span style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">win&nbsp;</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> is the predicted score for the (prompt, winning response) pair</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mtext>lose&nbsp;</mtext></msub></mrow><annotation encoding="application/x-tex">S_{\text {lose }}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">lose&nbsp;</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> is the predicted score for the (prompt, losing response) pair</li>
</ul>
<p>To achieve this ML objective, we need a loss function that penalizes the model when the difference between the winning and losing scores is too small. A commonly used loss function for this purpose is the margin ranking loss. The loss function is defined as:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="script">L</mi><mrow><mo fence="true">(</mo><msub><mi>S</mi><mtext>win&nbsp;</mtext></msub><mo separator="true">,</mo><msub><mi>S</mi><mtext>lose&nbsp;</mtext></msub><mo fence="true">)</mo></mrow><mo>=</mo><mi>max</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mn>0</mn><mo separator="true">,</mo><mi>m</mi><mo>−</mo><mrow><mo fence="true">(</mo><msub><mi>S</mi><mtext>win&nbsp;</mtext></msub><mo>−</mo><msub><mi>S</mi><mtext>lose&nbsp;</mtext></msub><mo fence="true">)</mo></mrow><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{L}\left(S_{\text {win }}, S_{\text {lose }}\right)=\max \left(0, m-\left(S_{\text {win }}-S_{\text {lose }}\right)\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathcal">L</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3175em;"><span style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">win&nbsp;</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">lose&nbsp;</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mop">max</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3175em;"><span style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">win&nbsp;</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">lose&nbsp;</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span></span></span>
<p>Where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> is a hyperparameter defining the margin. This margin indicates the minimum desired difference between the scores of the winning and losing responses. If the difference between <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mtext>win</mtext></msub></mrow><annotation encoding="application/x-tex">S_{\text {win}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3175em;"><span style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">win</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mtext>lose</mtext></msub></mrow><annotation encoding="application/x-tex">S_{\text {lose}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">lose</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> is less than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span>, the optimizer will update the model parameters so that either <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mtext>win</mtext></msub></mrow><annotation encoding="application/x-tex">S_{\text {win}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3175em;"><span style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">win</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> increases or <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mtext>lose</mtext></msub></mrow><annotation encoding="application/x-tex">S_{\text {lose}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">lose</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> decreases.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simplified reward model for a generative AI system.  A central, peach-colored rectangle labeled 'Reward Model' receives input from three sources: 'Prompt,' displaying the text 'What is 2+2?'; 'Winning res...', showing the correct answer 'Four.'; and 'Losing resp...', displaying the incorrect answer 'Math is hard.'  Arrows indicate the flow of information into the Reward Model.  The Reward Model then outputs two values, represented by  '$S_{win}' and '$S_{los}', connected by a dashed line labeled 'Margin...', suggesting a comparison or difference between the winning and losing reward signals. Arrows point from the Reward Model to these output values, indicating that the model assigns different reward signals based on the correctness of the response.  The entire diagram illustrates how the system evaluates responses based on a prompt and assigns rewards accordingly." loading="lazy" width="269" height="301" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-15-JT62W3SM.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 15: Reward modeling loss calculation for a single example from training data</figcaption></div></figure>
<h5 id="the-outcome-of-reward-modeling">The outcome of reward modeling</h5>
<p>The outcome of this step is a reward model that predicts relevance scores for (prompt, response) pairs. These scores reflect human judgments and are crucial for the second step in RLHF.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simplified diagram of a reinforcement learning system, specifically focusing on the reward mechanism.  The diagram shows a rectangular box labeled 'Reward Model' in peach/light-orange with a golden border, representing the core component that evaluates the quality of a generated response.  Below this box, '(Prompt, Response)' indicates that the input to the Reward Model consists of a prompt and the corresponding generated response. A single upward-pointing arrow connects '(Prompt, Response)' to the 'Reward Model,' signifying the flow of data.  Another upward-pointing arrow connects the 'Reward Model' to the word 'Score' at the top, indicating that the Reward Model outputs a numerical score based on its evaluation of the prompt and response pair.  The overall structure illustrates a process where a prompt and response are fed into a Reward Model, which then generates a score reflecting the quality of the response." loading="lazy" width="168" height="180" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-16-LHLGAPK6.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 16: The reward model predicts the relevance score for a (prompt, response) pair</figcaption></div></figure>
<h4 id="32-optimizing-the-sft-model">3.2. Optimizing the SFT model</h4>
<p>In the second step of RLHF, the SFT model is optimized with the help of the reward model. The purpose of this step is to adapt the SFT model to generate responses that are not only plausible but also helpful, based on the scores from the reward model.</p>
<p>A common approach to optimize the SFT model is to employ a reinforcement learning (RL) algorithm such as proximal policy optimization (PPO) [25], where the SFT model is finetuned to maximize the scores predicted by the reward model. This finetuning process performs the following steps iteratively:</p>
<ol>
<li><strong>Generate model responses:</strong> The model generates multiple possible responses for a given prompt.</li>
<li><strong>Compute rewards:</strong> The reward model scores these responses.</li>
<li><strong>Update model weights:</strong> The RL algorithm updates model weights to maximize the expected reward. This step reinforces responses that receive higher scores from the reward model.</li>
</ol>
<p>Figure 17 shows this process for a single response. In practice, multiple responses are generated and evaluated simultaneously.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simplified reinforcement learning (RL) system diagram.  A light orange rectangle labeled 'RL Model' is the core component, receiving input from an unspecified source indicated by 'What is...'. The RL model processes this input and produces an output, represented by a downward arrow and the text 'Math is hard.', which signifies the model's computation. This output feeds into a light green rectangle labeled 'Reward...', representing the reward signal generated by the model's actions.  A score of '1.8' is shown, likely indicating the performance metric of the RL model.  This reward signal is then fed into a purple rectangle labeled 'PPO,' which stands for Proximal Policy Optimization, an optimization algorithm.  The PPO algorithm uses the reward to optimize the RL model, indicated by an arrow labeled 'Optimize' connecting PPO back to the RL Model.  The system forms a closed loop where the PPO algorithm improves the RL model based on the reward signal, creating a continuous optimization process." loading="lazy" width="389" height="176" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-17-PPG4NU3A.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 17: Optimizing the model with the PPO algorithm</figcaption></div></figure>
<h5 id="training-data-2">Training data</h5>
<p>For this step, the training data usually includes a list of prompts created by contractors, typically ranging in number from 10,000 to 100,000.</p>
<h5 id="ml-objective-and-loss-function-3">ML objective and loss function</h5>
<p>Well-known LLMs such as ChatGPT and Llama use RL algorithms such as PPO and direct policy optimization (DPO) [26]. However, the details of these algorithms are usually beyond the scope of most ML system design interviews. For more information, refer to [27] and [28].</p>
<h5 id="the-outcome-of-rlhf">The outcome of RLHF</h5>
<p>The outcome of the RLHF stage is usually the final model that can be deployed as a chatbot. Table 4 lists some of the most popular LLMs.</p>
<div class="table-wrap" style="--table-min-width: 640px;"><table><thead><tr><th>LLM name</th><th>Developer</th><th>Release date</th><th>Access</th><th>Parameters</th></tr></thead><tbody><tr><td>o1</td><td>OpenAI</td><td>September 12, 2024</td><td>Preview only</td><td>Unknown</td></tr><tr><td>GPT-4o</td><td>OpenAI</td><td>May 13, 2024</td><td>API</td><td>Unknown</td></tr><tr><td>Claude 3</td><td>Anthropic</td><td>March 14, 2024</td><td>API</td><td>Unknown</td></tr><tr><td>Gemini 1.5</td><td>DeepMind</td><td>February 2, 2024</td><td>API</td><td>Unknown</td></tr><tr><td>Llama 3</td><td>Meta AI</td><td>April 18, 2024</td><td>Open-Source</td><td>8 and 70 billion</td></tr><tr><td>Grok-1</td><td>xAI</td><td>November 4, 2023</td><td>Open-Source</td><td>314 billion</td></tr><tr><td>Mixtral 8x22B</td><td>Mistral AI</td><td>April 10, 2024</td><td>Open-Source</td><td>141 billion</td></tr><tr><td>Gemma</td><td>DeepMind</td><td>February 21, 2024</td><td>Open-Source</td><td>2 and 7 billion</td></tr><tr><td>Phi-3</td><td>Microsoft</td><td>April 23, 2024</td><td>Open-Source</td><td>3.8 billion</td></tr><tr><td>DBRX</td><td>Databricks</td><td>March 27, 2024</td><td>Open-Source</td><td>132 billion</td></tr></tbody></table></div>
<p class="tableCaption">Table 4: Popular LLMs</p>
<p>To summarize the training section, we employ a three-stage training strategy, including pretraining, SFT, and RLHF. Pretraining involves training a model on a large corpus of text to gain a broad language understanding. SFT finetunes the model to adapt its output to a (prompt, response) format. RLHF further refines the model's responses to be helpful, safe, and aligned with human preferences.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a flowchart illustrating the stages involved in training a large language model (LLM), specifically highlighting the progression from a base model to a refined model using reinforcement learning.  The flowchart is divided into four main columns representing distinct training stages: Pretraining, Supervised Finetuning, Reward Modeling, and Reinforcement Learning. Each stage consists of three rows detailing the dataset used, the computational resources employed (number of GPUs), and the algorithm applied.  The Pretraining stage uses internet data, thousands of GPUs, and a language modeling algorithm to create a 'Base Model' (examples: GPT, Llama, PaLM).  The Supervised Finetuning stage takes the Base Model as input, utilizes demonstration data and 1-100 GPUs with a language modeling algorithm to produce an 'SFT Model' (example: Vicuna-13B).  The Reward Modeling stage uses comparisons data, 1-100 GPUs, and a regression algorithm to create a 'Reward Model' based on the SFT Model. Finally, the Reinforcement Learning stage uses prompts, 1-100 GPUs, and a reinforcement learning algorithm, taking both the SFT Model and the Reward Model as input, to generate an 'RL Model' (examples: ChatGPT, Gemini). Arrows indicate the flow of information and the model's progression through each stage.  Each stage's input and output are clearly labeled, along with the computational resources and algorithms used." loading="lazy" width="628" height="284" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-18-ABXYUHNY.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 18: Summary of LLM training, inspired by [29]</figcaption></div></figure>
<h3 id="sampling">Sampling</h3>
<p>In LLMs, sampling refers to how we select tokens from the model's predicted probability distribution to generate coherent and helpful responses.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simplified illustration of a Large Language Model (LLM) generating text.  At the bottom, a sequence of tokens 'What is 2 + 2 ?' is fed as input to the LLM (represented by a peach-colored rectangle). The LLM processes this input and outputs a probability distribution for the next token. This distribution is shown as a vertical column of numbers next to the LLM, with probabilities 0.01, 0.01, 0.93, and 0.00 assigned to different tokens.  A curved arrow connects this probability column to a histogram labeled 'Token probabilit...', which visually represents the same probability distribution. The histogram shows that the token 'four' has a 93% probability, '&lt;EOS&gt;' (end of sequence) has 1%, 'able' has a small probability, and 'zebra' has a very small probability.  An upward arrow connects the highest probability token, 'four', to the output of the LLM, indicating that the LLM selects 'four' as the next word in the sequence based on its highest probability." loading="lazy" width="489" height="313" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-19-M2EWBGCT.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 19: Selecting the next token from predicted probabilities</figcaption></div></figure>
<p>As discussed in Chapter 2, there are various methods for generating text. Some are deterministic, while others are stochastic. In this section, we examine these methods to determine which works better for open-ended text generation.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a hierarchical tree diagram illustrating different text generation methods.  At the top is a rectangular box labeled 'Text Generation Methods,' which branches down into two main categories: 'Deterministic' and 'Stochastic.'  The 'Deterministic' category further subdivides into two methods: 'Greedy Search' and 'Beam...', represented by rectangular boxes connected by downward-pointing arrows indicating the flow of information or hierarchical relationship.  Similarly, the 'Stochastic' category branches into three methods: 'Multinomial...', 'Top-k...', and 'Top-p...', each also depicted as rectangular boxes connected by downward-pointing arrows.  The overall structure shows a top-down breakdown of text generation approaches, classifying them as either deterministic or stochastic and then further specifying individual techniques within each category.  The ellipses (...) after some method names suggest further details or parameters are omitted for brevity." loading="lazy" width="549" height="224" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-20-DSBV5CHG.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 20: Common methods for generating text</figcaption></div></figure>
<h4 id="deterministic-methods">Deterministic methods</h4>
<p>Deterministic methods such as beam search work well for tasks with short, predictable text lengths. However, they are less effective for open-ended generation, such as dialogue, where output length varies. Let's examine the common issues that arise when using deterministic methods like greedy search or beam search to generate text from LLMs.</p>
<h5 id="greedy-search">Greedy search</h5>
<p>Greedy search selects the token with the highest probability at each step of the generation process.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a directed graph illustrating word probabilities in a sentence.  A thick, solid horizontal line labeled 'How' connects to a box labeled '0.56' representing the word 'are'.  From '0.56', a thick solid line labeled 'you' connects to a box labeled '0.91'.  From '0.91', a thick solid line labeled 'doing' connects to a box labeled '0.39'.  Dashed lines represent weaker connections.  A dashed line labeled 'come' connects 'How' to a box labeled '0.14'.  A dashed line labeled 'am' connects '0.56' to a box labeled '0.03'. A dashed line labeled 'dog' connects '0.56' to a box labeled '0.01'. A dashed line labeled 'do' connects 'How' to a box labeled '0.26'. A dashed line labeled 'work' connects '0.91' to a box labeled '0.001'. A dashed line labeled '?' connects '0.91' to a box labeled '0.38'.  Each box contains a numerical value, presumably representing the probability of that word appearing in the context of the sentence, given the preceding words.  The graph visually depicts the probabilistic relationships between words in a sentence structure." loading="lazy" width="484" height="284" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-21-XFXDDR6N.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 21: Greedy search</figcaption></div></figure>
<p>While this method is straightforward and often produces coherent text, it has two major issues:</p>
<ul>
<li>Repetition</li>
<li>Suboptimal generation</li>
</ul>
<p><strong>Repetition:</strong> When we use greedy search to select the next tokens, the text quickly starts repeating. This is because the model sometimes gets "stuck" in loops, reusing the same sequence of tokens. This happens when the model identifies certain words following each other with high probability.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simplified diagram illustrating a Large Language Model (LLM) interaction.  A peach-colored rectangle labeled 'LLM' is the central component.  Below the rectangle, the text 'How is the weather?' acts as an input prompt to the LLM.  An upward-pointing arrow connects this prompt to the LLM, indicating the flow of information into the model.  Above the rectangle, the text 'The weather today is sunny. The weathe...' represents the output generated by the LLM in response to the input prompt. An upward-pointing arrow connects the LLM to this output, showing the information flow from the model. The overall diagram depicts a basic question-answering process where a user's query ('How is the weather?') is processed by the LLM, resulting in a textual response ('The weather today is sunny...')." loading="lazy" width="360" height="216" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-22-2XYO53NX.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 22: Repetitive output</figcaption></div></figure>
<p><strong>Suboptimal generation:</strong> Greedy search ignores alternative paths during the text generation. It might miss a high-probability sequence of tokens hidden behind a low-probability token.</p>
<h5 id="beam-search">Beam search</h5>
<p>Beam search improves upon greedy search by considering multiple sequences simultaneously. At each step, it keeps track of the top k sequences, where k is configurable.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a probabilistic context-free grammar (PCFG) tree illustrating word probabilities in a sentence.  A central node labeled 'How' branches into three main paths, each representing a different word choice: 'come,' 'are,' and 'do.'  These words are connected with thick lines to subsequent nodes containing probabilities (0.24, 0.31, and 0.26 respectively). Each of these nodes further branches out via thinner, dashed lines to other words, representing possible continuations of the sentence. For example, the 'are' node connects to 'plants,' 'animals,' 'you,' and 'am' with associated probabilities (0.001, 0.21, 0.36, and 0.03 respectively for the 'are' node). Similarly, the 'come' node connects to 'are' and 'plants' with probabilities (0.24 and 0.21 respectively). The 'do' node connects to 'you,' 'the,' and 'people' with probabilities (0.63, 0.001, and 0.21 respectively).  The numbers within the boxes represent the conditional probability of a word given its parent node in the tree.  The overall structure shows the branching possibilities and associated probabilities of different word sequences, suggesting a language model's prediction of word choices based on preceding words." loading="lazy" width="353" height="416" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-23-E2YPJA35.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 23: Beam search with a beam width of 3</figcaption></div></figure>
<p>Beam search allows for more exploration and produces higher-quality text than greedy search. However, it can struggle with open-ended generation. Two common issues with beam search are:</p>
<ul>
<li>Inefficiency</li>
<li>Repetition</li>
</ul>
<p><strong>Inefficiency:</strong> Beam search can be computationally inefficient because it requires evaluating multiple sequences at once, which can slow down the generation process.</p>
<p><strong>Repetition:</strong> Beam search can lead to repetitive and generic responses. It sometimes gets stuck in a loop and repeats common phrases.</p>
<p>So far, we've seen that deterministic methods struggle with repetition and do not work well for text generation. Let's explore stochastic methods, which are more commonly used for text generation in LLMs.</p>
<h4 id="stochastic-methods">Stochastic methods</h4>
<p>Stochastic methods generate text by introducing randomness. This randomness makes them more suitable for open-ended text generation. Three popular stochastic methods are:</p>
<ul>
<li>Multinomial sampling</li>
<li>Top-k sampling</li>
<li>Top-p (nucleus) sampling</li>
</ul>
<h5 id="multinomial-sampling">Multinomial sampling</h5>
<p>Multinomial sampling selects the next token based on the probability distribution of the model's predictions. Each token has a probability associated with it, and a token is chosen based on these probabilities.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a bar chart illustrating the probability distribution of choosing different auxiliary verbs ('are,' 'is,' 'do,' 'should,' 'hard') to complete a sentence fragment, likely within a natural language processing context.  The horizontal axis displays the auxiliary verbs, with their corresponding probabilities shown as bar heights.  'are' has the highest probability (37%), followed by 'is' (21%), 'do' (12%), 'should' (4%), 'hard' (2%), and '0.13%' representing progressively lower probabilities, indicated by an ellipsis suggesting further, less likely options.  Two dashed arrows highlight the most probable choices: one points to 'are' with the text 'Choose 'are' with...', indicating its high likelihood of selection; the other points to 'hard' with the text 'Choose 'hard' with 2...', suggesting a less likely but still considered option. The bottom annotation,  `$P(w I \text{'How'})$`, likely represents a conditional probability formula, indicating the probability of choosing a word *w* given the context 'How'." loading="lazy" width="456" height="416" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-24-XQZP2DO6.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 24: Multinomial sampling</figcaption></div></figure>
<p>This approach ensures a wide variety of possible outputs. However, it introduces a significant amount of randomness, especially when the probability distribution is flat. This randomness often results in generations that are not coherent. For example, the generated text shown in Figure 25 is the output of the GPT-2 model using multinomial sampling.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simple generative model architecture.  At the bottom is a rectangular box labeled 'Model,' representing a language model.  Above it, the text 'Multinomial samp...' indicates that the model uses multinomial sampling to generate text. A vertical arrow connects the 'Model' box to a large rectangular box at the top containing the text 'I enjoy walking with my cute dog for the rest of t...', which represents the generated text output. The arrow points upwards, showing the flow of information from the model to the generated text.  The ellipsis ('...') suggests that the generated text is truncated and continues beyond what's shown.  The overall diagram illustrates a basic text generation process where the model produces text through multinomial sampling." loading="lazy" width="356" height="261" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-25-ZHZMMPJ7.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 25: GPT-2 output using multinomial sampling</figcaption></div></figure>
<p>Due to coherence issues, multinomial sampling is rarely used in LLMs for text generation.</p>
<h5 id="top-k-sampling">Top-k sampling</h5>
<p>Top-k sampling [30] is a more advanced method that selects from the <em>k</em> most likely tokens rather than sampling from the entire distribution.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a bar chart illustrating the probability distribution of different words given the context 'How'.  The horizontal axis displays a series of words: 'are,' 'is,' 'do,' 'should,' 'hard,' and an ellipsis indicating further words. The vertical axis represents probability, ranging from 0.0 to 1.0.  The height of each bar corresponds to the probability of that word following 'How'.  The bars are ordered from highest to lowest probability: 'are' (37%), 'is' (21%), 'do' (12%), 'should' (4%), 'hard' (2%), and '0.13%' representing a much lower probability. A dashed line encloses the three highest-probability words ('are,' 'is,' and 'do'). A curved dashed arrow extends from this enclosed area to the right, pointing to the text 'Sample from top three...', indicating that a selection is made from these top three words.  The bottom of the image shows a mathematical formula:  `$P(w I \text{'How'})$`, which likely represents the conditional probability of word *w* given the context 'How'." loading="lazy" width="432" height="428" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-26-YKCBJJLM.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 26: Example of top-k sampling with k=3</figcaption></div></figure>
<p>Here is a step-by-step process to select the next token in top-k sampling:</p>
<ol>
<li>The model predicts the probability distribution for the next token, providing a probability for each token in the vocabulary.</li>
<li>The tokens are sorted in descending order based on their predicted probabilities.</li>
<li>The top <em>k</em> tokens with the highest probabilities are considered for sampling.</li>
<li>The probabilities of the top <em>k</em> tokens are normalized to ensure they sum to 1.</li>
<li>A token is sampled from this normalized distribution.</li>
</ol>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simple generative model architecture.  At the bottom is a rectangular box labeled 'Model,' representing a language model or similar generative AI.  Above this box, a vertical arrow points upwards, labeled 'Top-k sampling (k=50),' indicating that the model's output is processed using this sampling technique, where only the top 50 most probable next words are considered.  At the very top is a rectangular box containing the text 'I enjoy walking with my cute dog for the rest of...', representing an input prompt or a partial text sequence fed into the 'Model.' The arrow indicates that the output of the 'Model' after Top-k sampling is the continuation of the input text.  The value 'k=50' specifies that the Top-k sampling algorithm considers only the 50 most likely word candidates at each step of text generation." loading="lazy" width="352" height="241" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-27-4EOFN2UX.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 27: GPT-2 output using top-k sampling with k=50</figcaption></div></figure>
<p>Top-k sampling balances coherence and diversity by picking from the top-k tokens. This reduces the chance of choosing irrelevant tokens while allowing some randomness. GPT-2 initially used top-k sampling, which was crucial to its success and popularity.</p>
<p>A major limitation of top-k sampling is that it always picks from a fixed number of top tokens. This is problematic depending on how the predicted probabilities are spread out. Let’s understand why.</p>
<p>Predicted token probabilities can be sharply or evenly distributed. With a sharp distribution, limiting choices to a fixed number of top tokens can produce nonsensical results because the model might miss the best choice. Conversely, with a flat distribution, this fixed limit restricts the model's creativity by not considering enough word options. For example, as shown in Figure 28, the model is 89% confident that the next token should be “lot,” but top-k sampling still considers "much" and "high" as possible next tokens to sample from.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a bar chart illustrating the probability distribution of a word (or n-gram) within a corpus, specifically focusing on the top three most frequent words. The horizontal axis displays different words: 'lot,' 'much,' 'high,' 'where,' 'this,' and an ellipsis indicating further words with lower probabilities. The vertical axis represents probability, ranging from 0.0 to 1.0.  The chart shows a tall bar for 'lot' representing 89% probability, followed by progressively shorter bars for 'much' (4%), 'high' (3%), 'where' (2%), 'this' (1%), and '0.13%' for the last visible word. A dashed line encloses the bars representing the top three most frequent words ('lot,' 'much,' 'high'). A curved dashed arrow extends from this enclosed area to the right, pointing to the text 'Sample from top three mos...', indicating that the enclosed area represents a sample from the top three most frequent words.  Below the chart, the formula '$P(w I \text{'Thanks a'})$' suggests the probability of word *w* given the preceding words 'Thanks a'." loading="lazy" width="388" height="376" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-28-I4PVPQSU.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 28: Top-k sampling in sharp distribution</figcaption></div></figure>
<p>This limitation is addressed in top-p sampling, which we examine next.</p>
<h5 id="top-p-nucleus-sampling">Top-p (nucleus) sampling</h5>
<p>Top-p sampling [31], also known as nucleus sampling, was developed in 2019. This method dynamically adjusts the number of tokens considered based on their combined probabilities. Instead of sampling only from the most likely <em>k</em> tokens, it chooses from the smallest possible set of tokens whose cumulative probability exceeds the probability <em>p</em>. This provides a more flexible and adaptive approach compared to top-k sampling.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents two bar charts illustrating the concept of top-p sampling in a language model.  Each chart displays the probability distribution of the next word given a preceding text prompt. The left chart shows the probability distribution for the prompt 'Thanks a...', with 'lot' having the highest probability (89%), followed by 'much' (4%), 'high' (3%), 'where' (2%), 'this' (1%), and others with probabilities less than 1%.  A dashed line encloses the bars representing the top-p selection, indicating that the model would likely select from these words based on their cumulative probability.  The right chart shows the probability distribution for the prompt 'How', with 'are' (31%), 'is' (29%), 'do' (24%), 'come' (7%), 'confident' (4%), and others having lower probabilities.  Similarly, a dashed line encloses the top-p selection, suggesting the model would choose from these words.  Both charts have a y-axis ranging from 0.0 to 1.0 representing probability, and an x-axis showing the potential next words and their associated probabilities.  The text '$P(w I \text{'Thanks a'...}$ and '$P(w I \text{'How'})$' below each chart indicates the conditional probability calculation being visualized, where 'P' represents probability, 'w' represents the next word, and 'I' represents the given text prompt.  Curved dashed arrows labeled 'Top-p sampling...' point from the dashed selection boxes to the right, indicating the sampling process." loading="lazy" width="652" height="332" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-29-CBVQXZAL.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 29: Top-p sampling adaptively chooses tokens based on the probability distribution</figcaption></div></figure>
<p>Here is a step-by-step process to select the next token in top-p sampling:</p>
<ol>
<li>The model predicts the probability distribution for the next token, providing a probability for each token in the vocabulary.</li>
<li>The tokens are sorted in descending order based on their predicted probabilities.</li>
<li>Instead of selecting a fixed number of tokens, top-p sampling chooses the smallest possible set of tokens whose cumulative probability exceeds a threshold <em>p</em>.</li>
<li>The probabilities of the selected tokens are normalized to ensure they sum to 1.</li>
<li>A token is sampled from this normalized distribution.</li>
</ol>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simple generative model architecture.  At the bottom is a rectangular box labeled 'Model,' representing a language model.  An upward-pointing arrow connects this box to a text label above it reading 'Top-p sampling (p=0.92),' indicating that the model's output is processed using top-p sampling with a probability threshold of 0.92. This sampling method selects the most probable words whose cumulative probability exceeds 0.92.  Finally, an upward-pointing arrow connects the sampling method to a rectangular box at the top containing the text 'I enjoy walking with my cute dog for the rest of...', which represents the generated text output of the model after the top-p sampling.  The overall diagram illustrates the flow of information from the model, through the top-p sampling process, to the final generated text." loading="lazy" width="321" height="220" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-30-V6PGCAA2.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 30: GPT-2 output using top-p sampling with p=0.92</figcaption></div></figure>
<p>The top-p sampling is widely used in advanced LLMs to generate human-like text. This method ensures the text is coherent and contextually relevant by focusing on the most probable tokens while allowing some randomness.</p>
<p>While we covered the key aspects of different sampling methods, there are more details to each method. Two popular techniques often used in advanced sampling methods are:</p>
<ul>
<li>Temperature</li>
<li>Repetition penalty</li>
</ul>
<h5 id="temperature">Temperature</h5>
<p>Temperature is a parameter in sampling methods that controls the randomness of predictions during sampling. Mathematically, the temperature parameter T scales the logits (raw scores) of the model’s output before applying the softmax function to generate probabilities. The adjusted softmax formula with temperature is given by:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>p</mi><mi>i</mi></msub><mo>=</mo><mfrac><mrow><mi>exp</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msub><mi>x</mi><mi>i</mi></msub><mi mathvariant="normal">/</mi><mi>T</mi><mo fence="true">)</mo></mrow></mrow><mstyle scriptlevel="0" displaystyle="true"><munderover><mo>∑</mo><mi>j</mi><mi>n</mi></munderover><mi>exp</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msub><mi>x</mi><mi>j</mi></msub><mi mathvariant="normal">/</mi><mi>T</mi><mo fence="true">)</mo></mrow></mstyle></mfrac></mrow><annotation encoding="application/x-tex">p_i=\frac{\exp \left(x_i / T\right)}{\displaystyle\sum_j^n \exp \left(x_j / T\right)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 4.3822em; vertical-align: -2.9552em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em;"><span style="top: -2.11em;"><span class="pstrut" style="height: 3.6514em;"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.6514em;"><span style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.05724em;">j</span></span></span><span style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.4138em;"><span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop">exp</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mord mathnormal" style="margin-right: 0.13889em;">T</span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span><span style="top: -3.8814em;"><span class="pstrut" style="height: 3.6514em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span style="top: -4.3284em;"><span class="pstrut" style="height: 3.6514em;"></span><span class="mord"><span class="mop">exp</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mord mathnormal" style="margin-right: 0.13889em;">T</span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.9552em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>
<p>where:</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> are the logits (raw scores) for each possible output</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.13889em;">T</span></span></span></span> is the temperature parameter</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">p_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> represents the probability of output <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> after applying the softmax function</li>
</ul>
<p>When <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">T=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.13889em;">T</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1</span></span></span></span>, the softmax function operates normally. When <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo>&gt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">T&gt;1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.7224em; vertical-align: -0.0391em;"></span><span class="mord mathnormal" style="margin-right: 0.13889em;">T</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1</span></span></span></span>, the model generates a more uniform probability distribution, making predictions more random and diverse. Higher temperatures increase randomness, which helps the model generate more creative outputs. If the model starts to stray off-topic or produce meaningless outputs, this indicates that the temperature has been set too high.</p>
<p>Conversely, when <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo>&lt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">T&lt;1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.7224em; vertical-align: -0.0391em;"></span><span class="mord mathnormal" style="margin-right: 0.13889em;">T</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1</span></span></span></span>, the model's output becomes more deterministic, with the highest logit values having more influence on the final prediction. Lower temperatures reduce randomness, which is more suitable for tasks requiring precise answers, such as summarization or translation. If the model starts to repeat itself, this indicates that the temperature has been set too low. A temperature of 0 consistently leads to the same output, making the sampling deterministic.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a comparative visualization of histograms, each depicting a probability distribution.  Four separate histograms are presented, arranged horizontally. Each histogram is enclosed within a dashed-line box.  The x-axis of each histogram is implicitly defined and represents a range of values (not explicitly labeled), while the y-axis (also implicitly defined) represents the frequency or probability of those values. The histograms differ in their distributions, showing varying degrees of concentration and spread.  Each histogram is labeled at the bottom with 'Temperature = [value]', where the value is 0.0, 0.5, 2, and 5 respectively, indicating that the histograms likely represent probability distributions at different temperature settings. The height of the bars in each histogram corresponds to the probability or frequency of the values within the corresponding bin.  The overall image suggests an analysis of how a probability distribution changes with varying temperature parameters." loading="lazy" width="583" height="289" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-31-GBDU3ZXZ.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 31: Different temperature values applied to the same logits</figcaption></div></figure>
<h6 id="what-are-typical-temperature-values">What are typical temperature values?</h6>
<p>Most model providers set the permissible temperature range between 0 and 2. Figure 32 illustrates OpenAI's API reference for the temperature setting.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a rectangular box with a light gray border containing only the text 'temperature...' centrally aligned.  No other components, connections, or information flows are depicted within the box.  Below the box, a small caption reads 'Text is not SVG - cannot display,' indicating that the image is a placeholder or a failed attempt to render a more complex diagram, likely an SVG (Scalable Vector Graphics) file, which would have contained visual elements beyond simple text.  The overall impression is that the image is incomplete or a representation of missing data related to 'temperature.'" loading="lazy" width="472" height="113" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-32-H42ULR7R.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 32: OpenAI’s temperature documentation [32]</figcaption></div></figure>
<p>In modern LLMs, the temperature parameter typically ranges from 0.1 to 1.5. When set beyond 1.5, outputs can become increasingly erratic and less coherent, which is undesirable. The optimal value depends on the desired behavior and is often determined empirically. The following table, created by [33], suggests possible temperature values for several use cases.</p>
<div class="table-wrap" style="--table-min-width: 640px;"><table><thead><tr><th>Use case</th><th style="text-align: center;">Temperature</th><th style="text-align: center;">Top-p</th><th>Description</th></tr></thead><tbody><tr><td>Code generation</td><td style="text-align: center;">0.2</td><td style="text-align: center;">0.1</td><td>Generates code that adheres to established patterns and conventions. Output is more deterministic and focused. Useful for generating syntactically correct code.</td></tr><tr><td>Creative writing</td><td style="text-align: center;">0.7</td><td style="text-align: center;">0.8</td><td>Generates creative and diverse text for storytelling. Output is more exploratory and less constrained by patterns.</td></tr><tr><td>Chatbot responses</td><td style="text-align: center;">0.5</td><td style="text-align: center;">0.5</td><td>Generates conversational responses that balance coherence and diversity. Output is more natural and engaging.</td></tr></tbody></table></div>
<p class="tableCaption"><p>Table 5: Empirical temperature and top-p ranges for different tasks</p></p>
<h5 id="repetition-penalty">Repetition penalty</h5>
<p>Similarly, applying a repetition penalty can explicitly reduce the likelihood of generating repetitive sequences of tokens. This can be achieved by terminating the generation when repetitive n-grams are detected (as controlled by the “no_repeat_ngram_size” parameter in Hugging Face models) or by directly modifying the probabilities of tokens that have already been sampled earlier in the sequence (such as the “frequency_penalty” in the ChatGPT API).</p>
<p>If you are interested in learning more about sampling methods in LLMs, refer to [30].</p>
<h2 id="evaluation">Evaluation</h2>
<h3 id="offline-evaluation-metrics">Offline evaluation metrics</h3>
<p>Evaluating LLMs like ChatGPT requires more than traditional metrics such as perplexity. These models behave in complex ways and perform differently across various tasks. Therefore, we need to assess their skills in different tasks to ensure the model is both effective and safe.</p>
<p>In this section, we evaluate our LLM from the following perspectives:</p>
<ul>
<li>Traditional evaluation</li>
<li>Task-specific evaluation</li>
<li>Safety evaluation</li>
<li>Human evaluation</li>
</ul>
<h4 id="traditional-evaluation">Traditional evaluation</h4>
<p>Traditional evaluation provides an initial understanding of the LLM’s performance using typical offline metrics. A common metric is perplexity, which measures how accurately the model predicts the exact sequence of tokens in the training data. A low perplexity value indicates that the model assigns higher probabilities, on average, to the tokens in the training data.</p>
<p>While these metrics are important for initial evaluation, they do not provide insights into an LLM's capabilities or limitations. For example, a low perplexity indicates the model is good at predicting the next tokens but does not measure its ability to understand code or solve math problems.</p>
<h4 id="task-specific-evaluation">Task-specific evaluation</h4>
<p>To effectively evaluate an LLM, we need to assess its performance across diverse tasks such as mathematics, code generation, and common-sense reasoning. This comprehensive approach helps identify the model’s strengths and weaknesses. Commonly used tasks for evaluating LLM’s capabilities are:</p>
<ul>
<li>Common-sense reasoning</li>
<li>World knowledge</li>
<li>Reading comprehension</li>
<li>Mathematical reasoning</li>
<li>Code generation</li>
<li>Composite benchmarks</li>
</ul>
<h5 id="common-sense-reasoning">Common-sense reasoning</h5>
<p>Common-sense reasoning evaluates a model's ability to make inferences based on everyday situations and general knowledge. It tests the model's understanding of basic human experiences, logical connections, and assumptions that people naturally make. Examples include interpreting idioms, understanding cause and effect in typical scenarios, and predicting likely outcomes in social situations.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simple block diagram illustrating a basic input-output system, likely related to a generative AI model.  The diagram is enclosed within a dashed rectangular border.  The main body is divided into two sections by a vertical line. The left section, labeled 'Prompt...', represents the input area where a user would provide a prompt or query to the system. The right section, labeled 'Answer...', represents the output area where the system's response or generated content would be displayed. A single horizontal line connects the 'Prompt...' and 'Answer...' sections, indicating the flow of information from input to output.  The text 'Text is not SVG - cannot display' at the bottom indicates that the image itself is a placeholder and not a functional representation of a system." loading="lazy" width="408" height="125" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-33-W75GY7V6.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 33: Example of common-sense reasoning</figcaption></div></figure>
<p>Typical benchmarks for common-sense reasoning are PIQA (Physical Interaction QA) [34], SIQA [35], HellaSwag [36], WinoGrande [37], OpenBookQA [38], and CommonsenseQA [39], each of which focuses on different aspects. For example, the CommonsenseQA benchmark is a multiple-choice question dataset for which the questions require common-sense knowledge to answer. PIQA focuses on reasoning about physical interactions in everyday situations, while HellaSwag focuses on everyday events.</p>
<h5 id="world-knowledge">World knowledge</h5>
<p>World knowledge refers to the model's factual knowledge about the world, including historical facts, scientific information, geography, and current events. An example would be answering questions about significant historical events or scientific principles.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simple system diagram depicting a basic input-output process.  The diagram is enclosed within a dashed rectangular border.  The interior is divided into two sections by a vertical line. The left section, labeled 'Prompt...', represents the input to the system. A horizontal line connects the 'Prompt...' section to the right section, indicating the flow of information. The right section, labeled 'Answer...', represents the output generated by the system in response to the input.  No internal components or processes are shown within the system; only the input and output are explicitly represented. The text 'Text is not SVG - cannot display' is present at the bottom, indicating that the image is a placeholder and lacks detailed internal representation." loading="lazy" width="408" height="108" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-34-46DY55B7.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 34: World knowledge example</figcaption></div></figure>
<p>Common benchmarks for this task include:</p>
<ul>
<li><strong>TriviaQA</strong> [40]<strong>:</strong> Questions are gathered from trivia and quiz-league websites.</li>
<li><strong>Natural Questions (NQ)</strong> [41]<strong>:</strong> A dataset from Google that includes questions and answers found in natural web queries.</li>
<li><strong>SQuAD (Stanford Question Answering Dataset)</strong> [42]<strong>:</strong> Contains questions based on Wikipedia articles.</li>
</ul>
<h5 id="reading-comprehension">Reading comprehension</h5>
<p>Reading comprehension tasks evaluate a model's ability to understand and interpret text passages and answer questions based on them. This is critical for assessing a model’s ability to extract information from and reason in relation to given texts.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simple diagram illustrating a basic input-output system, likely related to a large language model (LLM) or similar generative AI.  The diagram is enclosed within a dashed rectangular border.  This border is divided into two equal sections by a vertical line. The left section is labeled 'Prompt...' indicating the input area where a user would provide a text prompt or query. The right section is labeled 'Answer...', representing the output area where the system would generate a response. A single horizontal line connects the top of both sections, suggesting a unified system.  No explicit connections or data flow arrows are shown, implying a direct, implicit relationship between the prompt input and the answer output. The text 'Text is not SVG - cannot display' at the bottom indicates that the image is a static representation and not an interactive SVG." loading="lazy" width="516" height="213" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-35-V6C4EGQC.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 35: Reading comprehension example from SQuAD</figcaption></div></figure>
<p>Typical benchmarks for reading comprehension are SQuAD [42], QuAC [43], and BoolQ [44].</p>
<h5 id="mathematical-reasoning">Mathematical reasoning</h5>
<p>Mathematical reasoning tasks evaluate a model's ability to solve mathematical problems.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simple block diagram illustrating a basic input-output system, likely depicting a generative AI model.  The diagram is enclosed within a dashed-line rectangle.  The rectangle is horizontally divided into two sections by a solid line. The left section, labeled 'Prompt...', represents the input to the system, where a user would provide a text prompt or query. The right section, labeled 'Answer...', represents the output of the system, where the AI's generated response would appear.  A vertical line separates the input and output sections, visually suggesting a processing step occurring between them, although no internal components or processes are explicitly shown.  The information flow is unidirectional, from the 'Prompt...' input to the 'Answer...' output.  The overall simplicity suggests a high-level overview of the system, focusing solely on the input and output without detailing the internal workings of the AI model." loading="lazy" width="426" height="116" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-36-7JB54NV7.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 36: Mathematical reasoning example from GSM8K [45]</figcaption></div></figure>
<p>Two common benchmarks for mathematical reasoning tasks are:</p>
<ul>
<li><strong>MATH</strong> [46]<strong>:</strong> A dataset containing problems from high school mathematics competitions.</li>
<li><strong>GSM8K</strong> (Grade School Math 8K) [45]: A dataset with grade school math problems to test the model's problem-solving skills.</li>
</ul>
<h5 id="code-generation">Code generation</h5>
<p>Code generation evaluates a model's ability to write syntactically correct and functional code given a natural language prompt.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simple diagram illustrating a prompt-response interaction, likely within a code generation or large language model context.  The diagram is divided into two main rectangular sections by a vertical line. The left section, labeled 'Prompt...', is a blank space representing the input prompt given to the system. The right section, labeled 'Answer', contains the text 'def is_prime(n):...', indicating the system's response, which appears to be the beginning of a Python function definition for checking if a number is prime.  The two sections are separated by a horizontal line, suggesting a clear input-output relationship. The entire diagram is enclosed within a dashed-line rectangle, further emphasizing the system's boundaries.  No explicit data flow arrows are shown, but the implied flow is from the 'Prompt...' section to the 'Answer' section, representing the processing of the input prompt to generate the output response." loading="lazy" width="525" height="185" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-37-SRJMSFA3.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 37: Code generation example from HumanEval</figcaption></div></figure>
<p>Common benchmarks for code generation are:</p>
<ul>
<li><strong>HumanEval</strong> [47]<strong>:</strong> Python coding tasks.</li>
<li><strong>MBPP</strong> (MultiPL-E Benchmarks for Programming Problems) [48]: Multiple programming language tasks to evaluate multilingual code generation capabilities.</li>
</ul>
<h5 id="composite-benchmarks">Composite benchmarks</h5>
<p>In addition to specific benchmarks described above, composite benchmarks combine multiple tasks for a broader assessment. Popular composite benchmarks are:</p>
<ul>
<li><strong>MMLU</strong> <strong>(Massive Multitask Language Understanding)</strong> [49]<strong>:</strong> Consists of multiple-choice questions from a wide range of subjects including humanities, STEM, social sciences, and more, at various difficulty levels.</li>
<li><strong>MMMU (Massive Multilingual Multitask Understanding)</strong> [50]<strong>:</strong> MMMU includes a wide range of multiple-choice questions covering many subjects with varying levels of difficulty. Unlike MMLU, which focuses on English, MMMU tests the models’ ability to understand and generate accurate responses across different languages, assessing not only multilingual capabilities but also reasoning and cross-cultural knowledge.</li>
<li><strong>AGIEval</strong> [51]<strong>:</strong> A comprehensive benchmark designed to test artificial general intelligence across multiple domains and tasks.</li>
<li><strong>Meta Llama 3 human evaluation</strong> [13]: A high-quality human evaluation set containing 1,800 prompts that cover 12 key use cases: asking for advice, brainstorming, classification, closed question answering, coding, creative writing, extraction, inhabiting a character/persona, open question answering, reasoning, rewriting, and summarization.</li>
</ul>
<p>To summarize, we use various tasks and benchmarks to evaluate LLMs’ task-specific performance. This evaluation covers understanding and generating human-like responses across various domains. However, evaluation doesn't stop there. Safety evaluation is crucial for the responsible deployment of these models. Let's look deeper.</p>
<h4 id="safety-evaluation">Safety evaluation</h4>
<p>Safety evaluations of LLMs are critical to ensure these models generate responses that are safe and ethical. These evaluations focus on various tasks that help identify and mitigate risks such as the generation of harmful content. The main aspects of safety evaluation include:</p>
<ul>
<li>Toxicity and harmful content</li>
<li>Bias and fairness</li>
<li>Truthfulness</li>
<li>User privacy and data leakage</li>
<li>Adversarial robustness</li>
</ul>
<h5 id="toxicity-and-harmful-content">Toxicity and harmful content</h5>
<p>We evaluate a model's ability to avoid generating toxic content. Toxicity includes:</p>
<ul>
<li>Hate speech</li>
<li>Abusive language</li>
<li>Content that may pose harm to individuals, groups, or society</li>
<li>Content useful for planning attacks or violence</li>
<li>Instructions for finding illegal content</li>
</ul>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simple, high-level diagram illustrating a basic input-output system, possibly related to a large language model or similar generative AI.  The diagram is divided into two equal rectangular boxes by a horizontal and a vertical line, creating four quadrants.  The top-left quadrant contains the label 'Prompt...' indicating an input area where a user would provide a prompt or query. The bottom-right quadrant is labeled 'Answer...', representing the output area where the system's response or generated content would appear.  A horizontal line connects the 'Prompt...' and 'Answer...' labels, visually representing the flow of information from input to output. The dashed lines around the entire diagram suggest a system boundary.  No other components, connections, or data flow details beyond this basic input-output relationship are depicted." loading="lazy" width="417" height="118" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-38-TLMWXJTY.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 38: Model’s expected response to toxic prompts</figcaption></div></figure>
<p>Commonly used benchmarks to evaluate a model's toxicity are:</p>
<ul>
<li><strong>RealToxicityPrompts</strong> [52]<strong>:</strong> Consists of about 100,000 prompts that the model must complete; then a toxicity score is automatically evaluated using PerspectiveAPI [53].</li>
<li><strong>ToxiGen</strong> [54]<strong>:</strong> This benchmark tests a model's ability to avoid generating discriminatory language.</li>
<li><strong>HateCheck</strong> [55]<strong>:</strong> A suite of tests specifically for hate speech detection, covering various types of hate speech.</li>
</ul>
<p>Evaluating models using these benchmarks helps identify potential risks and improve the ability of models to generate safe and respectful content.</p>
<h5 id="bias-and-fairness">Bias and fairness</h5>
<p>We assess the model's responses for potential biases. This includes detecting gender, racial, and other biases in generated content.</p>
<p>Typical benchmarks are:</p>
<ul>
<li><strong>CrowS-Pairs</strong> [56]<strong>:</strong> Contains paired sentences differing in only one attribute (e.g., gender) to test for bias. This dataset enables measuring biases in 9 categories: gender, religion, race/color, sexual orientation, age, nationality, disability, physical appearance, and socioeconomic status.</li>
<li><strong>BBQ</strong> [57]: A dataset of hand-written question sets that target attested social biases against different socially relevant categories.</li>
<li><strong>BOLD</strong> [58]: A large-scale dataset that consists of 23,679 English text generation prompts for bias benchmarking across five domains.</li>
</ul>
<p>These benchmarks help us ensure the model treats all demographic groups fairly and equally.</p>
<h5 id="truthfulness">Truthfulness</h5>
<p>We evaluate the LLM’s ability to generate truthful and factually accurate responses. This includes distinguishing between factual information and common misconceptions or falsehoods.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simple diagram illustrating a basic input-output model, likely for a generative AI system.  The diagram is divided into two equal-sized rectangular boxes by a horizontal line, further subdivided into two equal-sized boxes by a vertical line. The top-left box is labeled 'Prompt...', indicating it's where user input or prompts are entered. The bottom-left box is empty, implying it's where the processed prompt would be stored or displayed.  The top-right box is empty, suggesting it's a placeholder for internal processing steps. The bottom-right box is labeled 'Answer...', indicating it's where the AI's generated response or output is displayed.  The boxes are outlined with dashed lines, suggesting a conceptual representation rather than a detailed architectural diagram.  There are no explicit connections shown between the boxes, implying a simplified representation of the data flow from prompt to answer.  The text 'Text is not SVG...cannot display' at the bottom indicates a limitation in displaying the image's content." loading="lazy" width="441" height="117" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-39-3ZV66POY.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 39: Truthfulness example from TruthfulQA</figcaption></div></figure>
<p>A common benchmark to evaluate truthfulness is TruthfulQA [59]. It measures the truthfulness of a model, i.e., its ability to identify when a claim is true. This benchmark can evaluate the risks of a model generating misinformation or false claims.</p>
<h5 id="user-privacy-and-data-leakage">User privacy and data leakage</h5>
<p>We evaluate the LLM’s tendency to leak sensitive information that it may have been exposed to during training. Since LLMs are trained on various publicly available data sources, they might know about people with a public internet presence. These assessments ensure that LLMs do not inadvertently disclose personal information. A common benchmark for this purpose is PrivacyQA [60].</p>
<h5 id="adversarial-robustness">Adversarial robustness</h5>
<p>Adversarial robustness tests an LLM’s ability to handle inputs intentionally designed to confuse or trick the model. This is crucial for ensuring the model's reliability and safety in practice. Typical benchmarks for testing LLM’s adversarial robustness include AdvGLUE [61], TextFooler [62], and AdvBench [63].</p>
<p>To summarize, we use various benchmarks to evaluate the safety of the LLM, which is crucial to ensure users’ safety. While both task-specific and safety evaluations are essential, human evaluation remains the most reliable method for comprehensive assessment.</p>
<h4 id="human-evaluation">Human evaluation</h4>
<p>In this approach, human evaluators are asked to rate the different aspects of an LLM such as helpfulness and safety. Human evaluation is critical for assessing nuanced aspects of helpfulness and safety that task-specific and safety benchmarks might miss.</p>
<h3 id="online-evaluation-metrics">Online evaluation metrics</h3>
<p>Online evaluation metrics measure how an LLM performs when deployed in production. Commonly used metrics are:</p>
<ul>
<li>User feedback and ratings</li>
<li>User engagement</li>
<li>Conversion rate</li>
<li>Online leaderboards</li>
</ul>
<p><strong>User feedback and ratings:</strong> Users can rate their satisfaction with the model's responses. This direct feedback from users highlights areas that need improvement.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simple system illustrating user interaction with a question-answering system.  The system displays a question, 'Where is the capital of Franc...', within a rounded rectangle.  To the left, another rounded rectangle contains the answer, 'Paris.'. A dashed arrow originates near the 'Paris' answer, curves downwards, and points to the text 'User feedback' indicating that the answer 'Paris' is considered user feedback to the system.  The overall structure suggests a feedback loop where the system provides an answer ('Paris') and this answer is then used as feedback to improve the system's performance or understanding.  No URLs or parameters are visible." loading="lazy" width="314" height="171" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-40-NNCWVMXO.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 40: Collecting users’ feedback</figcaption></div></figure>
<p><strong>User engagement:</strong> Metrics such as “number of queries made” and “session duration” can be insightful signals to measure user engagement. High engagement levels often indicate the LLM is effective in providing helpful information.</p>
<p><strong>Conversion rate:</strong> Conversion rate refers to the percentage of users who make a purchase or sign up for a service after interacting with the LLM. Conversion rate is a crucial metric to monitor because higher conversion rates indicate that users find the LLM useful enough to pay for the service.</p>
<p><strong>Online leaderboards:</strong> Online leaderboards track the performance of various LLMs in real time, A notable example is LMSYS Chatbot Arena [64], a crowdsourced open platform designed to evaluate LLMs. These models are ranked based on more than 800,000 human pairwise comparisons.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a leaderboard ranking different large language models (LLMs).  The table is organized into columns representing:  'Rank (UB)' indicating the model's position, 'Model' listing the name and version of each LLM (e.g., `o1-preview`, `ChatGPT-40-latest (2024-09-03)`, `Gemini-1.5-Pro-Exp-0827`), 'Arena Score' providing a numerical score for each model's performance, '95% CI' showing the 95% confidence interval around the Arena Score (e.g., '+6/-7'), 'Votes' indicating the number of votes contributing to the score, and 'Organization' specifying the developer of each LLM (e.g., OpenAI, Google, xAI, Anthropic).  The rows represent individual LLMs, ordered by their Arena Score in descending order.  No explicit information flow is depicted; the table simply presents comparative performance data for various LLMs." loading="lazy" width="832" height="566" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(832px, 100vw), (max-width: 1200px) min(832px, 80vw), min(832px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-41-ASEZETJL.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-41-ASEZETJL.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-41-ASEZETJL.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-41-ASEZETJL.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-41-ASEZETJL.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-41-ASEZETJL.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-41-ASEZETJL.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-41-ASEZETJL.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-41-ASEZETJL.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 41: Chatbot Arena leaderboard</figcaption></div></figure>
<h2 id="overall-ml-system-design">Overall ML System Design</h2>
<p>Designing a chatbot system such as ChatGPT requires several components working together smoothly. Unlike traditional models, this system combines multiple services and pipelines to ensure efficiency, safety, and continuous improvement. In this section, we'll explore two key pipelines:</p>
<ul>
<li>Training pipeline</li>
<li>Inference pipeline</li>
</ul>
<h3 id="training-pipeline">Training pipeline</h3>
<p>The training pipeline involves three critical stages: pretraining, SFT, and RLHF. These stages collectively ensure the model is capable and that it generates helpful and safe responses.</p>
<h3 id="inference-pipeline">Inference pipeline</h3>
<p>The inference pipeline includes several components that ensure the safety, relevance, and quality of the generated responses. This pipeline is responsible for real-time interaction with users. The key components in the inference pipeline are:</p>
<ul>
<li>Safety filtering</li>
<li>Prompt enhancer</li>
<li>Response generator</li>
<li>Response safety evaluator</li>
<li>Rejection response generator</li>
<li>Session management</li>
</ul>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a flowchart depicting the process of generating a response from a language model.  The process begins with a 'Text prompt' which is fed into a 'Safety Filt...' block.  A diamond-shaped decision node labeled 'Safe?' determines if the prompt is safe; if yes, the prompt proceeds to a 'Prompt...' block, otherwise, a 'Rejection Response...' is generated.  The 'Prompt...' block feeds into a 'Response...' block, which utilizes 'Top-p sampling' and interacts with a 'Trained...' (presumably the language model) cloud component.  The 'Response...' output is then checked for safety in another 'Safe...' decision node. If safe, a 'Generated response' is output; otherwise, the process returns to the 'Rejection Response...'.  The entire process is managed by a 'Session Management' block, which receives the final generated response and likely handles session-related data.  The connections between blocks are represented by arrows indicating the flow of information." loading="lazy" width="672" height="296" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-42-UI22IJRT.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 42: Chatbot overall design</figcaption></div></figure>
<p>Let’s explore each component in more detail.</p>
<h4 id="safety-filtering">Safety filtering</h4>
<p>This component analyzes the user prompt to detect harmful, inappropriate, or unsafe queries before it is processed by the model. For example, a prompt asking for instructions on creating a harmful device will be rejected and flagged.</p>
<h4 id="prompt-enhancer">Prompt enhancer</h4>
<p>The prompt enhancer component refines and enriches the input prompt to make it more informative and detailed. It expands acronyms, corrects misspellings, and adds context where necessary.</p>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simple data flow diagram illustrating a prompt enhancement process.  The diagram shows an initial prompt, 'Tell me about NYC.', as input. This prompt flows rightward via a black arrow into a rectangular box labeled 'Prompt Enhancer,' which is light purple with a darker purple border.  The 'Prompt Enhancer' box represents a process that modifies or improves the input prompt.  From the 'Prompt Enhancer' box, another black arrow points rightward to the output, which is a more detailed and enhanced prompt: 'Tell me about New York City (NYC), h...'.  The ellipsis ('...') suggests that the output prompt is longer than what's fully displayed, implying the 'Prompt Enhancer' added information such as context or keywords.  The overall flow demonstrates a transformation of a concise prompt into a more comprehensive one suitable for a downstream process (not shown)." loading="lazy" width="553" height="76" decoding="async" data-nimg="1" src="https://bytebytego.com/images/courses/genai-system-design-interview/chatgpt-personal-assistant-chatbot/figure-4-43-EAW33XI5.svg" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 43: Example of prompt enhancement</figcaption></div></figure>
<p>This component ensures the text prompts are clear, unambiguous, and free of grammatical errors before passing it to the model, which helps the model generate better responses.</p>
<h4 id="response-generator">Response generator</h4>
<p>The response generator interacts with the trained LLM and utilizes top-p sampling to generate a helpful response. This component can optionally use other techniques to improve the quality and safety of the generated response. For example, it might generate multiple possible responses and then choose the one that is more appropriate based on a set of predefined criteria.</p>
<h4 id="response-safety-evaluator">Response safety evaluator</h4>
<p>This component evaluates the generated response to detect harmful or inappropriate content before it is shown to the user. It acts as a final safeguard to ensure responses meet ethical and safety standards.</p>
<h4 id="rejection-response-generator">Rejection response generator</h4>
<p>This component generates a proper response when the input prompt is unsafe or the generated response is unsuitable. It provides a clear and polite explanation of why the request cannot be fulfilled.</p>
<h4 id="session-management">Session management</h4>
<p>To maintain conversation context and handle follow-up questions effectively, specific handling is required. For example, when a user is chatting with a model about their favorite movies, the model needs to remember not just the current question, but also their previous mentions of different genres or films.</p>
<p>This component maintains the continuity and coherence of the conversation by tracking the chat history and managing the flow of dialogue. This is achieved by feeding the chat history, along with the enhanced prompt, into the response generator. This design ensures that each response is contextually relevant by referencing previous interactions and appropriately handling the state of the conversation.</p>
<h2 id="other-talking-points">Other Talking Points</h2>
<p>If there is extra time at the end of the interview, here are some additional talking points:</p>
<ul>
<li>Techniques for managing dialogue states and tracking context across multiple turns [65].</li>
<li>Employing advanced or more efficient ML objectives such as multi-token prediction [66].</li>
<li>Handling very long sequence lengths [67][68].</li>
<li>How to develop multimodal LLMs [69][70].</li>
<li>Techniques such as RAG to leverage external knowledge bases and databases to enhance LLM output [71]. We explore this in Chapter 6.</li>
<li>Efficiency techniques (e.g., distillation) for faster text generation.</li>
<li>Techniques for adapting LLMs to specific domains (e.g., customer service, healthcare) without forgetting previous knowledge [72].</li>
<li>Addressing security and privacy concerns in LLMs.</li>
<li>Different optimization algorithms such as PPO, DPO, and rejection sampling [73].</li>
<li>Red-teaming LLMs to reduce harm [74].</li>
<li>Super-alignment and its importance in developing LLMs [75].</li>
<li>How in-context learning works [76].</li>
<li>Grouped query attention and its benefits [77].</li>
<li>Employing chain-of-thought prompting techniques [78]. We explore this in Chapter 6.</li>
<li>Implementing KV cache [79].</li>
<li>Enhancing trust by requiring models to produce clear and verifiable justifications for their outputs [80].</li>
</ul>
<h2 id="summary">Summary</h2>
<figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a mind map summarizing the design of a generative AI system.  The central node is labeled 'Summary,' branching out into several main categories.  These include 'Caching mechanisms,' detailing aspects like specification (input and output), ML upscaling, and Docker/clip; 'Jobs processing,' encompassing web-crawling, URL and language identification, content quality filtering, inappropriate content removal, and data quality assurance; 'Architecture,' focusing on positional encoding, Transformer architecture, and prediction tasks; 'Training,' covering data generation, instruction data, vector prediction, training a large model, calibration, and sampling methods (deterministic, beam search, MCMC, top-k, top-p, temperature); 'Traditional metrics,' encompassing common-sense reasoning, world knowledge, reading comprehension, and code generation benchmarks; 'CI/CD,' including compilable benchmarks, triviality level validation, traffic noise, and data leakage/privacy issues; and 'Human evaluation,' covering user feedback, user comparisons, online leaderboards, and training updates.  Finally, a 'System components' branch details overall system components and other traffic mechanisms, while a 'Solicitor to' branch describes prompt parameters, response parameters, and response quality evaluation.  Each branch further subdivides into more specific sub-topics, creating a hierarchical structure illustrating the various components and their interrelationships within the generative AI system." loading="lazy" width="680" height="1499" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(680px, 100vw), (max-width: 1200px) min(680px, 80vw), min(680px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-44-EMIP5WXU.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-44-EMIP5WXU.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-44-EMIP5WXU.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-44-EMIP5WXU.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-44-EMIP5WXU.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-44-EMIP5WXU.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-44-EMIP5WXU.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-44-EMIP5WXU.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fgenai-system-design-interview%2Fchatgpt-personal-assistant-chatbot%2Ffigure-4-44-EMIP5WXU.png&amp;w=3840&amp;q=75" style="color: transparent;"></div></figure>
<h2 id="reference-material">Reference Material</h2>
<p>[1] OpenAI’s ChatGPT. <a href="https://openai.com/index/chatgpt/" target="_blank" rel="noopener noreferrer">https://openai.com/index/chatgpt/</a>.<br>
[2] ChatGPT wiki. <a href="https://en.wikipedia.org/wiki/ChatGPT" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/ChatGPT</a>.<br>
[3] OpenAI’s models. <a href="https://platform.openai.com/docs/models" target="_blank" rel="noopener noreferrer">https://platform.openai.com/docs/models</a>.<br>
[4] Google’s Gemini. <a href="https://gemini.google.com/" target="_blank" rel="noopener noreferrer">https://gemini.google.com/</a>.<br>
[5] Meta’s Llama. <a href="https://llama.meta.com/" target="_blank" rel="noopener noreferrer">https://llama.meta.com/</a>.<br>
[6] Beautiful Soup. <a href="https://beautiful-soup-4.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">https://beautiful-soup-4.readthedocs.io/en/latest/</a>.<br>
[7] Lxml. <a href="https://lxml.de/" target="_blank" rel="noopener noreferrer">https://lxml.de/</a>.<br>
[8] Document Object Model. <a href="https://en.wikipedia.org/wiki/Document_Object_Model" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Document_Object_Model</a>.<br>
[9] Boilerplate removal tool. <a href="https://github.com/miso-belica/jusText" target="_blank" rel="noopener noreferrer">https://github.com/miso-belica/jusText</a>.<br>
[10] fastText. <a href="https://fasttext.cc/" target="_blank" rel="noopener noreferrer">https://fasttext.cc/</a>.<br>
[11] langid. <a href="https://github.com/saffsd/langid.py" target="_blank" rel="noopener noreferrer">https://github.com/saffsd/langid.py</a>.<br>
[12] RoFormer: Enhanced Transformer with Rotary Position Embedding. <a href="https://arxiv.org/abs/2104.09864" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2104.09864</a>.<br>
[13] Llama 3 human evaluation. <a href="https://github.com/meta-llama/llama3/blob/main/eval_details.md" target="_blank" rel="noopener noreferrer">https://github.com/meta-llama/llama3/blob/main/eval_details.md</a>.<br>
[14] Exploring the Limits of Transfer Learning with a Unified Text-to-Text Transformer. <a href="https://arxiv.org/abs/1910.10683" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/1910.10683</a>.<br>
[15] DeBERTa: Decoding-enhanced BERT with Disentangled Attention. <a href="https://arxiv.org/abs/2006.03654" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2006.03654</a>.<br>
[16] Transformers are RNNs: Fast Autoregressive Transformers with Linear Attention. <a href="https://arxiv.org/abs/2006.16236" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2006.16236</a>.<br>
[17] Common Crawl. <a href="https://commoncrawl.org/" target="_blank" rel="noopener noreferrer">https://commoncrawl.org/</a>.<br>
[18] C4 dataset. <a href="https://www.tensorflow.org/datasets/catalog/c4" target="_blank" rel="noopener noreferrer">https://www.tensorflow.org/datasets/catalog/c4</a>.<br>
[19] Stack Exchange dataset. <a href="https://github.com/EleutherAI/stackexchange-dataset" target="_blank" rel="noopener noreferrer">https://github.com/EleutherAI/stackexchange-dataset</a>.<br>
[20] Training language models to follow instructions with human feedback. <a href="https://arxiv.org/abs/2203.02155" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2203.02155</a>.<br>
[21] Alpaca. <a href="https://crfm.stanford.edu/2023/03/13/alpaca.html" target="_blank" rel="noopener noreferrer">https://crfm.stanford.edu/2023/03/13/alpaca.html</a>.<br>
[22] Dolly-15K. <a href="https://www.databricks.com/blog/2023/04/12/dolly-first-open-commercially-viable-instruction-tuned-llm" target="_blank" rel="noopener noreferrer">https://www.databricks.com/blog/2023/04/12/dolly-first-open-commercially-viable-instruction-tuned-llm</a>.<br>
[23] Introducing FLAN: More generalizable Language Models with Instruction Fine-Tuning. <a href="https://research.google/blog/introducing-flan-more-generalizable-language-models-with-instruction-fine-tuning/" target="_blank" rel="noopener noreferrer">https://research.google/blog/introducing-flan-more-generalizable-language-models-with-instruction-fine-tuning/</a>.<br>
[24] Training a Helpful and Harmless Assistant with Reinforcement Learning from Human Feedback. <a href="https://arxiv.org/abs/2204.05862" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2204.05862</a>.<br>
[25] Proximal Policy Optimization Algorithms. <a href="https://arxiv.org/abs/1707.06347" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/1707.06347</a>.<br>
[26] Direct Preference Optimization: Your Language Model is Secretly a Reward Model. <a href="https://arxiv.org/abs/2305.18290" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2305.18290</a>.<br>
[27] Illustrating RLHF. <a href="https://huggingface.co/blog/rlhf" target="_blank" rel="noopener noreferrer">https://huggingface.co/blog/rlhf</a>.<br>
[28] RLHF progress and challenges. <a href="https://www.youtube.com/watch?v=hhiLw5Q_UFg" target="_blank" rel="noopener noreferrer">https://www.youtube.com/watch?v=hhiLw5Q_UFg</a>.<br>
[29] State of GPT. <a href="https://www.youtube.com/watch?v=bZQun8Y4L2A" target="_blank" rel="noopener noreferrer">https://www.youtube.com/watch?v=bZQun8Y4L2A</a>.<br>
[30] Different sampling methods. <a href="https://huggingface.co/blog/how-to-generate" target="_blank" rel="noopener noreferrer">https://huggingface.co/blog/how-to-generate</a>.<br>
[31] The Curious Case of Neural Text Degeneration. <a href="https://arxiv.org/abs/1904.09751" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/1904.09751</a>.<br>
[32] OpenAI’s API reference. <a href="https://platform.openai.com/docs/api-reference/chat/create" target="_blank" rel="noopener noreferrer">https://platform.openai.com/docs/api-reference/chat/create</a>.<br>
[33] Cheat Sheet: Mastering Temperature and Top_p in ChatGPT API. <a href="https://community.openai.com/t/cheat-sheet-mastering-temperature-and-top-p-in-chatgpt-api/172683" target="_blank" rel="noopener noreferrer">https://community.openai.com/t/cheat-sheet-mastering-temperature-and-top-p-in-chatgpt-api/172683</a>.<br>
[34] PIQA: Reasoning about Physical Commonsense in Natural Language. <a href="https://arxiv.org/abs/1911.11641" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/1911.11641</a>.<br>
[35] SocialIQA: Commonsense Reasoning about Social Interactions. <a href="https://arxiv.org/abs/1904.09728" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/1904.09728</a>.<br>
[36] HellaSwag: Can a Machine Really Finish Your Sentence? <a href="https://arxiv.org/abs/1905.07830" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/1905.07830</a>.<br>
[37] WinoGrande: An Adversarial Winograd Schema Challenge at Scale. <a href="https://arxiv.org/abs/1907.10641" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/1907.10641</a>.<br>
[38] Can a Suit of Armor Conduct Electricity? A New Dataset for Open Book Question Answering. ​​<a href="https://arxiv.org/abs/1809.02789" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/1809.02789</a>.<br>
[39] CommonsenseQA: A Question Answering Challenge Targeting Commonsense Knowledge. <a href="https://arxiv.org/abs/1811.00937" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/1811.00937</a>.<br>
[40] TriviaQA: A Large Scale Dataset for Reading Comprehension and Question Answering. <a href="https://nlp.cs.washington.edu/triviaqa/" target="_blank" rel="noopener noreferrer">https://nlp.cs.washington.edu/triviaqa/</a>.<br>
[41] The Natural Questions Dataset. <a href="https://ai.google.com/research/NaturalQuestions" target="_blank" rel="noopener noreferrer">https://ai.google.com/research/NaturalQuestions</a>.<br>
[42] SQuAD: 100,000+ Questions for Machine Comprehension of Text. <a href="https://arxiv.org/abs/1606.05250" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/1606.05250</a>.<br>
[43] QuAC dataset. <a href="https://quac.ai/" target="_blank" rel="noopener noreferrer">https://quac.ai/</a>.<br>
[44] BoolQ: Exploring the Surprising Difficulty of Natural Yes/No Questions. <a href="https://arxiv.org/abs/1905.10044" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/1905.10044</a>.<br>
[45] GSM8K dataset. <a href="https://github.com/openai/grade-school-math" target="_blank" rel="noopener noreferrer">https://github.com/openai/grade-school-math</a>.<br>
[46] MATH dataset. <a href="https://github.com/hendrycks/math/" target="_blank" rel="noopener noreferrer">https://github.com/hendrycks/math/</a>.<br>
[47] HumanEval dataset. <a href="https://github.com/openai/human-eval" target="_blank" rel="noopener noreferrer">https://github.com/openai/human-eval</a>.<br>
[48] MBPP dataset. <a href="https://github.com/google-research/google-research/tree/master/mbpp" target="_blank" rel="noopener noreferrer">https://github.com/google-research/google-research/tree/master/mbpp</a>.<br>
[49] Measuring Massive Multitask Language Understanding. <a href="https://arxiv.org/abs/2009.03300" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2009.03300</a>.<br>
[50] Measuring Massive Multilingual Multitask Language Understanding. <a href="https://huggingface.co/datasets/openai/MMMLU" target="_blank" rel="noopener noreferrer">https://huggingface.co/datasets/openai/MMMLU</a>.<br>
[51] AGIEval: A Human-Centric Benchmark for Evaluating Foundation Models. <a href="https://arxiv.org/abs/2304.06364" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2304.06364</a>.<br>
[52] RealToxicityPrompts: Evaluating Neural Toxic Degeneration in Language Models. <a href="https://arxiv.org/abs/2009.11462" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2009.11462</a>.<br>
[53] Perspective API. <a href="https://perspectiveapi.com/" target="_blank" rel="noopener noreferrer">https://perspectiveapi.com/</a>.<br>
[54] ToxiGen: A Large-Scale Machine-Generated Dataset for Adversarial and Implicit Hate Speech Detection. <a href="https://arxiv.org/abs/2203.09509" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2203.09509</a>.<br>
[55] HateCheck: Functional Tests for Hate Speech Detection Models. <a href="https://arxiv.org/abs/2012.15606" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2012.15606</a>.<br>
[56] CrowS-Pairs: A Challenge Dataset for Measuring Social Biases in Masked Language Models. <a href="https://arxiv.org/abs/2010.00133" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2010.00133</a>.<br>
[57] BBQ: A Hand-Built Bias Benchmark for Question Answering. <a href="https://arxiv.org/abs/2110.08193" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2110.08193</a>.<br>
[58] BOLD: Dataset and Metrics for Measuring Biases in Open-Ended Language Generation. <a href="https://arxiv.org/abs/2101.11718" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2101.11718</a>.<br>
[59] TruthfulQA: Measuring How Models Mimic Human Falsehoods. <a href="https://arxiv.org/abs/2109.07958" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2109.07958</a>.<br>
[60] Question Answering for Privacy Policies: Combining Computational and Legal Perspectives. <a href="https://arxiv.org/abs/1911.00841" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/1911.00841</a>.<br>
[61] AdvGLUE Benchmark. <a href="https://adversarialglue.github.io/" target="_blank" rel="noopener noreferrer">https://adversarialglue.github.io/</a>.<br>
[62] Is BERT Really Robust? A Strong Baseline for Natural Language Attack on Text Classification and Entailment. <a href="https://arxiv.org/abs/1907.11932" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/1907.11932</a>.<br>
[63] AdvBench. <a href="https://github.com/llm-attacks/llm-attacks" target="_blank" rel="noopener noreferrer">https://github.com/llm-attacks/llm-attacks</a>.<br>
[64] Chatbot Arena leaderboard. <a href="https://lmarena.ai/leaderboard" target="_blank" rel="noopener noreferrer">https://lmarena.ai/leaderboard</a>.<br>
[65] A Survey on Recent Advances in LLM-Based Multi-turn Dialogue Systems. <a href="https://arxiv.org/abs/2402.18013" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2402.18013</a>.<br>
[66] Better &amp; Faster Large Language Models via Multi-token Prediction. <a href="https://arxiv.org/abs/2404.19737" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2404.19737</a>.<br>
[67] Gemini 1.5: Unlocking multimodal understanding across millions of tokens of context. <a href="https://arxiv.org/abs/2403.05530" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2403.05530</a>.<br>
[68] HyperAttention: Long-context Attention in Near-Linear Time. <a href="https://arxiv.org/abs/2310.05869" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2310.05869</a>.<br>
[69] MM-LLMs: Recent Advances in MultiModal Large Language Models. <a href="https://arxiv.org/abs/2401.13601" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2401.13601</a>.<br>
[70] Multimodality and Large Multimodal Models. <a href="https://huyenchip.com/2023/10/10/multimodal.html" target="_blank" rel="noopener noreferrer">https://huyenchip.com/2023/10/10/multimodal.html</a>.<br>
[71] What is Retrieval-Augmented Generation? <a href="https://cloud.google.com/use-cases/retrieval-augmented-generation" target="_blank" rel="noopener noreferrer">https://cloud.google.com/use-cases/retrieval-augmented-generation</a>.<br>
[72] How to Customize an LLM: A Deep Dive to Tailoring an LLM for Your Business. <a href="https://techcommunity.microsoft.com/t5/ai-machine-learning-blog/how-to-customize-an-llm-a-deep-dive-to-tailoring-an-llm-for-your/ba-p/4110204" target="_blank" rel="noopener noreferrer">https://techcommunity.microsoft.com/t5/ai-machine-learning-blog/how-to-customize-an-llm-a-deep-dive-to-tailoring-an-llm-for-your/ba-p/4110204</a>.<br>
[73] Llama 2: Open Foundation and Fine-Tuned Chat Models. <a href="https://arxiv.org/abs/2307.09288" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2307.09288</a>.<br>
[74] Red Teaming Language Models to Reduce Harms: Methods, Scaling Behaviors, and Lessons Learned. <a href="https://arxiv.org/abs/2209.07858" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2209.07858</a>.<br>
[75] Introducing superalignment. <a href="https://openai.com/index/introducing-superalignment/" target="_blank" rel="noopener noreferrer">https://openai.com/index/introducing-superalignment/</a>.<br>
[76] Language Models are Few-Shot Learners. <a href="https://arxiv.org/abs/2005.14165" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2005.14165</a>.<br>
[77] GQA: Training Generalized Multi-Query Transformer Models from Multi-Head Checkpoints. <a href="https://arxiv.org/abs/2305.13245" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2305.13245</a>.<br>
[78] Chain-of-Thought Prompting Elicits Reasoning in Large Language Models. <a href="https://arxiv.org/abs/2201.11903" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2201.11903</a>.<br>
[79] Efficiently Scaling Transformer Inference. <a href="https://arxiv.org/abs/2211.05102" target="_blank" rel="noopener noreferrer">https://arxiv.org/abs/2211.05102</a>.<br>
[80] Prover-Verifier Games improve legibility of language model outputs. <a href="https://openai.com/index/prover-verifier-games-improve-legibility/" target="_blank" rel="noopener noreferrer">https://openai.com/index/prover-verifier-games-improve-legibility/</a>.</p>
        </article>
    </main>

    <div class="nav">
        <a href="../genai-system-design-interview.html">← Course Contents</a>
        <a href="google-translate.html">← Previous</a>
        <a href="image-captioning.html">Next →</a>
    </div>

    <footer class="metadata">
        <p>Scraped on 10/10/2025</p>
    </footer>
</body>
</html>