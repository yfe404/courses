<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ad Click Prediction on Social Platforms - Machine Learning System Design Interview</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Open Sans', Arial, sans-serif;
    font-size: 16px;
    line-height: 1.6;
    color: #454545;
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

h1 {
    font-size: 2em;
    margin: 1em 0 0.5em 0;
    line-height: 1.2;
}

h2 {
    font-size: 1.5em;
    margin: 1.2em 0 0.6em 0;
    line-height: 1.3;
}

h3 {
    font-size: 1.2em;
    margin: 1em 0 0.5em 0;
    line-height: 1.4;
}

p {
    margin: 0.8em 0;
}

a {
    color: #0077aa;
    text-decoration: none;
}

a:hover {
    text-decoration: underline;
}

ul, ol {
    margin: 0.8em 0;
    padding-left: 2em;
}

li {
    margin: 0.4em 0;
}

code, pre {
    background: #f4f4f4;
    border: 1px solid #ddd;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
}

code {
    padding: 2px 5px;
}

pre {
    padding: 10px;
    overflow-x: auto;
    margin: 1em 0;
}

pre code {
    border: none;
    padding: 0;
}

img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 1.5em auto;
}

figure {
    margin: 1.5em 0;
    text-align: center;
}

figcaption {
    font-style: italic;
    font-size: 0.9em;
    color: #666;
    margin-top: 0.5em;
}

.chapter-number {
    font-weight: bold;
    color: #0077aa;
}

.nav {
    margin: 2em 0;
    padding: 1em 0;
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
}

.nav a {
    margin-right: 1em;
}

.toc {
    list-style: none;
    padding: 0;
}

.toc li {
    margin: 0.8em 0;
}

.course-section {
    margin: 2em 0;
}

.course-title {
    font-size: 1.3em;
    font-weight: bold;
    color: #0077aa;
    margin: 1.5em 0 0.8em 0;
}

.metadata {
    font-size: 0.9em;
    color: #888;
    margin: 2em 0 1em 0;
}

.breadcrumb {
    font-size: 0.9em;
    color: #666;
    margin-bottom: 1em;
}

.breadcrumb a {
    color: #0077aa;
}

@media (max-width: 600px) {
    body {
        padding: 10px;
    }

    h1 {
        font-size: 1.5em;
    }

    h2 {
        font-size: 1.3em;
    }
}</style>
</head>
<body>
    <div class="breadcrumb">
        <a href="../../index.html">Home</a> /
        <a href="../machine-learning-system-design-interview.html">Machine Learning System Design Interview</a> /
        Ad Click Prediction on Social Platforms
    </div>

    <div class="nav">
        <a href="../machine-learning-system-design-interview.html">← Course Contents</a>
        <a href="event-recommendation-system.html">← Previous</a>
        <a href="similar-listings-on-vacation-rental-platforms.html">Next →</a>
    </div>

    <main>
        <h1>
            <span class="chapter-number">08</span> Ad Click Prediction on Social Platforms
        </h1>

        <div class="metadata">
            <a href="https://bytebytego.com/courses/machine-learning-system-design-interview/ad-click-prediction-on-social-platforms" target="_blank" rel="noopener">Original source</a>
        </div>

        <article>
            <header><strong class="style_chapter__grtAe">08</strong><h1>Ad Click Prediction on Social Platforms</h1></header><h2 id="introduction">Introduction</h2>
<p>Online advertising allows advertisers to bid and place their advertisements (ads) on a platform for measurable responses such as impressions, clicks, and conversions. Displaying relevant ads to users is a fundamental for many online platforms such as Google, Facebook, and Instagram.</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a smartphone screen displaying two distinct content blocks.  The top block, labeled 'Sponsored' in red text, contains a dashed-line border and shows a video placeholder icon (a black camcorder symbol) within a rectangular area.  A small circle and a rectangular input field are positioned above this sponsored content. An arrow points from the left edge of the screen to the top sponsored ad, indicating its placement within the app's interface. Below this, a second content block displays a stylized mountain icon within a rectangular area, also with a small circle and a rectangular input field above it. Both content blocks are visually similar in structure, suggesting a consistent design pattern for content presentation within the application. The entire layout is contained within the outline of a smartphone screen, implying a mobile application context." width="347" height="441" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(347px, 100vw), (max-width: 1200px) min(347px, 80vw), min(347px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-01-1-3UBSMWS6.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-01-1-3UBSMWS6.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-01-1-3UBSMWS6.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-01-1-3UBSMWS6.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-01-1-3UBSMWS6.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-01-1-3UBSMWS6.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-01-1-3UBSMWS6.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-01-1-3UBSMWS6.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-01-1-3UBSMWS6.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 8.1: Sponsored ads placed on the user’s timeline</figcaption></div></figure></center>
<p>In this chapter, we design an (also known as ) system similar to what popular social media platforms use.</p>
<h2 id="clarifying-requirements">Clarifying Requirements</h2>
<p>Here is a typical interaction between a candidate and an interviewer.</p>
<p><strong>Candidate</strong>: Can I assume the business objective of building an ad prediction system is to maximize revenue?<br>
<strong>Interviewer:</strong> Yes, that’s correct.</p>
<p><strong>Candidate:</strong> There are different types of ads, such as video and image ads. In addition, ads can be displayed in different sizes and formats, like users’ timelines, pop-up ads, etc. For simplicity, can I assume ads are placed on users’ timelines only, and every click generates the same revenue?<br>
<strong>Interviewer:</strong> That sounds good.</p>
<p><strong>Candidate:</strong> Can the system show the same ad to the same user more than once?<br>
<strong>Interviewer:</strong> Yes, we can show an ad more than once. Sometimes, an ad turns into a click after multiple impressions. In reality, companies have a “fatigue period”, that is, they don’t show the same ad to the same user for X days if the user repeatedly ignores it. For simplicity, assume we have no fatigue period.</p>
<p><strong>Candidate:</strong> Do we support the “hide this ad” feature? How about “block this advertiser”? These kinds of negative feedback help us to detect irrelevant ads.<br>
<strong>Interviewer:</strong> Good question. Let’s assume users can hide an ad they don’t like. “Block this advertiser” is an interesting feature, but we don’t need to support it for now.</p>
<p><strong>Candidate:</strong> Would it be okay to assume that the training dataset should be constructed using user and ad data, and the labels should be based on user-ad interactions?<br>
<strong>Interviewer:</strong> Sure.</p>
<p><strong>Candidate:</strong> We can construct positive training data points via user clicks, but how do we generate negative data points? Can we assume any impression that is not clicked is a negative data point? What if the user scrolls fast and doesn’t spend time seeing the ad? What if we count an impression as negative, but eventually, the user clicks on it?<br>
<strong>Interviewer:</strong> These are excellent questions. What are your thoughts?</p>
<p><strong>Candidate:</strong> If an ad is visible on a user’s screen for a certain duration but not clicked, we can count it as a negative data point. An alternative approach would be to assume impressions are negative until a click is observed. In addition, we can rely on negative feedback such as “hide this ad” to label negative data points.<br>
<strong>Interviewer:</strong> Makes sense! In practice, we might use other complex techniques to label negative data points . For this interview, let’s proceed with your suggestions.</p>

<p><strong>Candidate:</strong> In ad click prediction systems, it’s critical for the model to learn from new interactions continuously. Is it fair to assume continual learning is a necessity here?<br>
<strong>Interviewer:</strong> Great point. Experiments have shown that even a 5-minute delay in updating models can damage performance [1].</p>
<p>Let's summarize the problem statement. We are asked to design an ad click prediction system. The business objective of the system is to maximize revenue. The ads are placed only on users' timelines, and each click generates the same revenue. It is necessary to train the model on new interactions continually. We construct the dataset from the user and ad data, and label them based on interactions. In this chapter, we will not discuss AdTech-specific topics as they are not relevant to ML interviews. To learn more about AdTech, refer to [2].</p>
<h2 id="frame-the-problem-as-an-ml-task">Frame the Problem as an ML Task</h2>
<h3 id="defining-the-ml-objective">Defining the ML objective</h3>
<p>The goal of the ad click prediction system is to increase revenue by showing users ads they are more likely to click on. This can be converted into the following ML objective: predicting if an ad will be clicked. This is due to the fact that by correctly predicting click probabilities, the system can display relevant ads to users, which leads to an increase in revenue.</p>
<h3 id="specifying-the-systems-input-and-output">Specifying the system’s input and output</h3>
<p>The ad click prediction system takes a user as input, and outputs a ranked list of ads based on click probabilities.</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a system for predicting ad clicks.  The system begins with a User, represented by a person icon, who is the input to an 'Ad click prediction system' block. This system receives information from a database cylinder labeled 'Ads,' which contains information about available advertisements.  The 'Ad click prediction system' processes user data and ad information to predict which ads the user is most likely to click. The output of the prediction system is a selection of ads, represented by a dashed-line box labeled 'Ads' containing individual ad boxes labeled 'Ad 1,' 'Ad 2,' '...,' and 'Ad k,' indicating a variable number of ads.  Arrows show the flow of information: from the User to the prediction system, from the 'Ads' database to the prediction system, and from the prediction system to the final selection of ads.  The system essentially takes user data and available ads as input, uses a machine learning model to predict click probability, and outputs a ranked list of ads for display." loading="lazy" width="500" height="246" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(500px, 100vw), (max-width: 1200px) min(500px, 80vw), min(500px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-02-1-SNQVHGOG.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-02-1-SNQVHGOG.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-02-1-SNQVHGOG.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-02-1-SNQVHGOG.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-02-1-SNQVHGOG.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-02-1-SNQVHGOG.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-02-1-SNQVHGOG.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-02-1-SNQVHGOG.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-02-1-SNQVHGOG.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 8.2: Ad click prediction system’s input and output</figcaption></div></figure></center>
<h3 id="choosing-the-right-ml-category">Choosing the right ML category</h3>
<p>Figure 8.2 illustrates how ad prediction can be framed as a ranking problem. As described in Chapter 7, Event Recommendation System, the pointwise Learning to Rank (LTR) is a great starting point for solving ranking problems. The pointwise LTR employs a binary classification model that takes a <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟨</mo></mrow><annotation encoding="application/x-tex">\langle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">⟨</span></span></span></span> user, ad <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">\rangle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mclose">⟩</span></span></span></span> pair as input and predicts whether the user will click on the ad. Figure 8.3 shows the model's input and output.</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><div style="position: relative; width: 260px; height: 342px;"><img alt="Image represents a system for predicting the probability of a user clicking on an advertisement.  At the bottom, a simple icon representing a 'User' and a stylized browser window labeled 'Advertisement' (containing a video camera icon) feed information into a central 'Binary classification model' box.  Arrows indicate the flow of data from the user and advertisement into the model. The model then outputs a value 'p' (representing the probability) to a box labeled 'Probability of this user clicking on the ad' at the top of the diagram.  The arrow from the model to the probability box shows the model's prediction of the click-through probability.  The entire diagram illustrates a machine learning pipeline where user and advertisement data are used to predict the likelihood of ad engagement." loading="lazy" width="260" height="342" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(260px, 100vw), (max-width: 1200px) min(260px, 80vw), min(260px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-03-1-73NOO4FT.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-03-1-73NOO4FT.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-03-1-73NOO4FT.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-03-1-73NOO4FT.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-03-1-73NOO4FT.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-03-1-73NOO4FT.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-03-1-73NOO4FT.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-03-1-73NOO4FT.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-03-1-73NOO4FT.png&amp;w=3840&amp;q=75" style="color: transparent;"></div></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 8.3: Binary classification model’s input-output</figcaption></div></figure></center>
<h2 id="data-preparation">Data Preparation</h2>
<h3 id="data-engineering">Data engineering</h3>
<p>Here is some raw data available in this system:</p>
<ul>
<li>Ads</li>
<li>Users</li>
<li>User-ad interactions</li>
</ul>
<h4 id="ads">Ads</h4>
<p>Ad data is shown in Table 8.1. In practice, we may have hundreds of attributes associated with each ad. For simplicity, we only list important ones.</p>
<div class="table-wrap" style="--table-min-width: 640px;"><table><thead><tr><th style="text-align: center;">Ad ID</th><th style="text-align: center;">Advertiser ID</th><th style="text-align: center;">Ad group ID</th><th style="text-align: center;">Campaign ID</th><th style="text-align: center;">Category</th><th style="text-align: center;">Subcategory</th><th style="text-align: center;">Images or Videos</th></tr></thead><tbody><tr><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td style="text-align: center;">4</td><td style="text-align: center;">7</td><td style="text-align: center;">travel</td><td style="text-align: center;">hotel</td><td style="text-align: center;">http: //cdn.mysite.com/u1.jpg</td></tr><tr><td style="text-align: center;">2</td><td style="text-align: center;">7</td><td style="text-align: center;">2</td><td style="text-align: center;">9</td><td style="text-align: center;">insurance</td><td style="text-align: center;">car</td><td style="text-align: center;">http: //cdn.mysite.com/t3.mp4</td></tr><tr><td style="text-align: center;">3</td><td style="text-align: center;">9</td><td style="text-align: center;">6</td><td style="text-align: center;">28</td><td style="text-align: center;">travel</td><td style="text-align: center;">airline</td><td style="text-align: center;">http: //cdn.mysite.com/t5.jpg</td></tr></tbody></table></div>
<p class="tableCaption">Table 8.1: Ad data</p>
<h4 id="users">Users</h4>
<p>The schema for user data is shown below.</p>
<div class="table-wrap" style="--table-min-width: 640px;"><table><thead><tr><th style="text-align: center;">ID</th><th style="text-align: center;">Username</th><th style="text-align: center;">Age</th><th style="text-align: center;">Gender</th><th style="text-align: center;">City</th><th style="text-align: center;">Country</th><th style="text-align: center;">Language</th><th style="text-align: center;">Time zone</th></tr></thead></table></div>
<p class="tableCaption">Table 8.2: Schema for user data</p>
<h4 id="user-ad-interactions">User-ad interactions</h4>
<p>This table stores user-ad interactions such as impressions, clicks, and conversions.</p>
<div class="table-wrap" style="--table-min-width: 640px;"><table><thead><tr><th style="text-align: center;">User ID</th><th style="text-align: center;">Ad ID</th><th style="text-align: center;">Interaction type</th><th style="text-align: center;">Dwell time</th><th style="text-align: center;">Location (lat, long)</th><th style="text-align: center;">Timestamp</th></tr></thead><tbody><tr><td style="text-align: center;">11</td><td style="text-align: center;">6</td><td style="text-align: center;">Impression</td><td style="text-align: center;">5sec</td><td style="text-align: center;">38.8951<br> -77.0364</td><td style="text-align: center;">165845053</td></tr><tr><td style="text-align: center;">11</td><td style="text-align: center;">7</td><td style="text-align: center;">Impression</td><td style="text-align: center;">0.4 sec</td><td style="text-align: center;">41.9241<br> -89.0389</td><td style="text-align: center;">1658451365</td></tr><tr><td style="text-align: center;">4</td><td style="text-align: center;">20</td><td style="text-align: center;">Click</td><td style="text-align: center;">-</td><td style="text-align: center;">22.7531<br> 47.9642</td><td style="text-align: center;">1658435948</td></tr><tr><td style="text-align: center;">11</td><td style="text-align: center;">6</td><td style="text-align: center;">Conversion</td><td style="text-align: center;">-</td><td style="text-align: center;">22.7531<br> 47.9642</td><td style="text-align: center;">1658451849</td></tr></tbody></table></div>
<p class="tableCaption">Table 8.3: User-ad interaction data</p>
<h3 id="feature-engineering">Feature engineering</h3>
<p>Our aim in this section is to engineer features that will assist us in predicting user clicks.</p>
<h4 id="ad-features">Ad features</h4>
<p>Ad features include the following:</p>
<ul>
<li>IDs</li>
<li>Image/video</li>
<li>Category and subcategory</li>
<li>Impression and click numbers</li>
</ul>
<p>Let's examine each in more detail.</p>
<h5 id="ids">IDs</h5>
<p>These are advertiser ID, campaign ID, ad group ID, ad ID,etc.</p>
<p><strong>Why is it important?</strong> The IDs represent the advertiser, the campaign, the ad group, and the ad itself. These IDs are used as predictive features to capture the unique characteristics of different advertisers, campaigns, ad groups, and ads.</p>
<p><strong>How to prepare it?</strong> The embedding layer converts sparse features, such as IDs, into dense feature vectors. Each ID type has its own embedding layer.</p>
<h5 id="imagevideo">Image/video</h5>
<p><strong>Why is it important?</strong> A video or image in a post is another signal that can help us predict what the ad is about. For example, an image of an airplane may indicate the ad is related to travel.</p>
<p><strong>How to prepare it?</strong> The images or videos are first preprocessed. After that, we use a pre-trained model such as SimCLR [3] to convert unstructured data into a feature vector.</p>
<h5 id="ad-category-and-subcategory">Ad category and subcategory</h5>
<p>As provided by the advertiser, this is the ad's category and subcategory. For example, here is a list of broad types of categories that are targetable: Arts &amp; Entertainment, Autos &amp; Vehicles, Beauty &amp; Fitness, etc.</p>
<p><strong>Why is it important?</strong> It helps the model to understand which category the ad belongs to.</p>
<p><strong>How to prepare it?</strong> These are manually provided by the advertiser based on a predefined list of categories and subcategories. To learn more about preparing textual data, read Chapter 4, YouTube Video Search.</p>
<h5 id="impressions-and-click-numbers">Impressions and click numbers</h5>
<ul>
<li>Total impression/clicks on the ad</li>
<li>Total impressions/clicks on ads supplied by an advertiser</li>
<li>Total impressions of the campaign</li>
</ul>
<p><strong>Why is it important?</strong> These numbers indicate how other users reacted to this ad. For example, users are more likely to click on an ad with a high click-through rate (CTR).</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a machine learning model architecture diagram illustrating feature concatenation from various sources.  The bottom layer shows three feature groups: 'Textual features' (derived from 'Tokenization' of 'Travel' and 'Flight' categories, processed by a 'Pretrained text model' producing two embedding vectors with numerical values), 'Engagement features' (consisting of numerical values representing 'Ad impressions,' 'Ad clicks,' 'Advertiser total clicks,' and 'Campaign total clicks'), and 'Image/video features' (processed by a 'Pretrained image/video model' resulting in a visual feature vector).  Each feature group feeds into an 'Embedding' layer, generating a vector of numerical values (e.g., [-0.8, 0.6, 0, 0.1, -0.3]). These embeddings, along with the numerical IDs ('Ad ID,' 'Advertiser ID,' 'Campaign ID,' and 'Group ID'), are then concatenated in the top layer, 'Concatenated features,' forming a combined feature vector for subsequent model processing (not shown).  The arrows indicate the data flow, showing how individual features are processed and combined to create the final feature vector." loading="lazy" width="839" height="389" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(839px, 100vw), (max-width: 1200px) min(839px, 80vw), min(839px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-04-1-QQBOWIK3.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-04-1-QQBOWIK3.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-04-1-QQBOWIK3.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-04-1-QQBOWIK3.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-04-1-QQBOWIK3.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-04-1-QQBOWIK3.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-04-1-QQBOWIK3.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-04-1-QQBOWIK3.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-04-1-QQBOWIK3.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 8.4: Summary of ad-related feature preparation</figcaption></div></figure></center>
<h4 id="user-features">User features</h4>
<p>Similar to previous chapters, we choose the following features:</p>
<ul>
<li>Demographics: age, gender, city, country, etc</li>
<li>Contextual information: device, time of the day, etc</li>
<li>Interaction-related features: clicked ads, user's historical engagement statistics, etc</li>
</ul>
<p>Let's take a closer look at interaction-related features.</p>
<h5 id="clicked-ads">Clicked ads</h5>
<p>Ads previously clicked by the user.</p>
<p><strong>Why is it important?</strong> Previous clicks indicate a user's interests. For example, when a user clicks on lots of insurance-related ads, it suggests they are likely to click on a similar ad again.</p>
<p><strong>How to prepare it?</strong> In the same way as described in "Ad features".</p>
<h5 id="users-historical-engagement-statistics">User’s historical engagement statistics</h5>
<p>These are the user’s historical engagement numbers, such as their total ad views and ad click rate.</p>
<p><strong>Why is it important?</strong> An individual's historical engagement is a good predictor of future engagement. In general, users are more likely to click on ads in the future, if they clicked on ads frequently in the past.</p>
<p><strong>How to prepare it?</strong> Engagement statistics are represented as numerical values. To prepare them, we scale their values into a similar range.</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a data processing pipeline for feature engineering in a machine learning system.  The pipeline begins with three distinct feature groups: Demographics (Age, Gender, City, Country, Language), Contextual Information (Time of day, Device), and Interaction-related features (User's ad click rate, User's total ad views, Clicked ad IDs).  Each feature within these groups undergoes preprocessing:  'Bucketize + One-hot' for categorical features like Age and Gender, and 'Embedding' for features like City and Language, resulting in numerical vector representations. These processed features are then individually fed into a 'Concatenated features' block, which combines them into a single feature vector.  Separately, the 'Interaction-related features' undergo an 'Ad-related feature computation' step, likely involving aggregation or transformation.  The output of this computation, along with the output from the 'Scale' block (which processes the User's total ad views), is then aggregated using an 'Aggregate (avg)' function, likely calculating the average of multiple values.  The final output is not explicitly shown but would presumably be the combined feature vector ready for use in a machine learning model.  Numerical values within the boxes represent example feature values or weights." loading="lazy" width="759" height="468" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(759px, 100vw), (max-width: 1200px) min(759px, 80vw), min(759px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-05-1-EKSODA4Z.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-05-1-EKSODA4Z.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-05-1-EKSODA4Z.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-05-1-EKSODA4Z.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-05-1-EKSODA4Z.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-05-1-EKSODA4Z.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-05-1-EKSODA4Z.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-05-1-EKSODA4Z.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-05-1-EKSODA4Z.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 8.5: Feature preparation for user metadata and interactions</figcaption></div></figure></center>
<p>Before concluding the data preparation section, let's examine a common challenge in ad click prediction systems. In most cases, these systems deal with lots of high cardinality categorical features. For example, "ad category" takes values from a huge list of all possible categories. Similarly, "advertiser ID" and "user ID" take potentially millions of unique values, depending on how many users or advertisers are active on the platform. Given the huge feature space which often exists, it is common to have thousands or millions of features mostly filled with zeroes. In the model selection section, we will cover techniques to overcome these unique challenges.</p>
<h2 id="model-development">Model Development</h2>
<h3 id="model-selection">Model selection</h3>
<p>As described in the section "Frame the Problem as an ML Task", the binary classification model is chosen to solve the ranking problem. Binary classifications can be modeled in several different ways. The following are common choices in ad click prediction systems:</p>
<ul>
<li>Logistic regression</li>
<li>Feature crossing + logistic regression</li>
<li>Gradient boosted decision trees</li>
<li>Gradient boosted decision trees + logistic regression</li>
<li>Neural networks</li>
<li>Deep &amp; Cross networks</li>
<li>Factorization Machines</li>
<li>Deep Factorization Machines</li>
</ul>
<h4 id="logistic-regression-lr">Logistic regression (LR)</h4>
<p>LR models the probability of a binary outcome using a linear combination of one or multiple features. LR is fast to train and easy to implement. An LR-based ad click prediction system, however, does have the following drawbacks:</p>
<ul>
<li>
<p><strong>Non-linear problems can't be solved with LR.</strong> LR solves the task using a linear combination of input features, which leads to a linear decision boundary. In ad click prediction systems, data is usually not linearly separable, so LR may perform poorly.</p>
</li>
<li>
<p><strong>Inability to capture feature interactions.</strong> LR is not capable of capturing feature interactions. In ad prediction systems, it is very common to have various interactions between features. When features interact with each other, the output probability cannot be expressed as the sum of the feature effects, since the effect of one feature depends on the value of the other feature.</p>
</li>
</ul>
<p>Given these two drawbacks, LR is not the best choice for the ad prediction system. However, because it is fast to implement and easy to train, many companies use it to create a baseline model.</p>
<h4 id="feature-crossing--lr">Feature crossing + LR</h4>
<p>To capture feature interactions better, we use a technique called feature crossing</p>
<p><strong>What is feature crossing?</strong></p>
<p>Feature crossing is a technique used in ML to create new features from existing features. It involves combining two or more existing features into one new feature by taking their product, sum, or another combination. It is possible to capture nonlinear interactions between the original features in this way, which can improve the performance of ML models. For example, interactions such as "young and basketball" or "USA and football" may positively impact a model's ability to predict click probability.</p>
<p><strong>How to create feature crosses?</strong></p>
<p>In feature crossing, we manually add new features to the existing features based on prior knowledge. As Figure <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8.6</mn></mrow><annotation encoding="application/x-tex">8.6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">8.6</span></span></span></span> shows, crossing two features, such as "country" and "language" adds six new features to the existing feature space. To learn more about crossing, refer to [4].</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a Cartesian product operation between two sets.  On the left, we have two feature vectors: `f1: Country` with values `[USA, China, England]` and `f2: Language` with values `[English, Chinese]`.  A horizontal line connects these vectors to a central 'x' symbol representing the Cartesian product.  This 'x' is labeled 'Country' vertically and 'Language' horizontally, indicating the dimensions of the product.  A rightward arrow extends from the 'x' to a list of eight feature vectors (f3-f8) on the right.  These vectors represent all possible combinations resulting from the Cartesian product of the Country and Language sets: f3 (USA and English), f4 (USA and Chinese), f5 (China and English), f6 (China and Chinese), f7 (England and English), and f8 (England and Chinese).  Essentially, the diagram visually demonstrates how combining two sets of features generates a new set containing all possible pairings." loading="lazy" width="600" height="111" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(600px, 100vw), (max-width: 1200px) min(600px, 80vw), min(600px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-06-1-RQCCRDOJ.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-06-1-RQCCRDOJ.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-06-1-RQCCRDOJ.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-06-1-RQCCRDOJ.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-06-1-RQCCRDOJ.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-06-1-RQCCRDOJ.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-06-1-RQCCRDOJ.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-06-1-RQCCRDOJ.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-06-1-RQCCRDOJ.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 8.6: Crossing two features: country and language</figcaption></div></figure></center>
<p><strong>How to use feature crossing + LR?</strong></p>
<p>As shown in Figure 8.7, feature crossing + LR works as follows:</p>
<ol>
<li>Use feature crossing on the original set of features to extract new features (crossed features)</li>
<li>Use the original and the crossed features as input for the LR model</li>
</ol>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a machine learning model pipeline.  At the bottom, a rectangular box labeled 'Original features' represents the input data, depicted as a series of individual feature columns.  An arrow points upward from this box to a rectangular box labeled 'Feature crossing,' which processes the original features to generate new, combined features.  The output of the feature crossing is a rectangular box labeled 'Crossed features,' also shown as a series of columns, representing the newly created features.  An arrow connects the 'Crossed features' box to a rectangular box labeled 'Logistic regression,' indicating that these features are fed into the logistic regression model.  Another arrow connects the 'Original features' box directly to the 'Logistic regression' box, showing that the original features are also used as input to the logistic regression. Finally, an arrow points upward from the 'Logistic regression' box to a smaller square box labeled 'p,' representing the predicted output (presumably a probability) of the model.  The entire diagram illustrates a system where both original and crossed features are used as input to a logistic regression model to generate a prediction." loading="lazy" width="400" height="397" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(400px, 100vw), (max-width: 1200px) min(400px, 80vw), min(400px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-07-1-TF5NWYY4.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-07-1-TF5NWYY4.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-07-1-TF5NWYY4.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-07-1-TF5NWYY4.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-07-1-TF5NWYY4.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-07-1-TF5NWYY4.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-07-1-TF5NWYY4.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-07-1-TF5NWYY4.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-07-1-TF5NWYY4.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 8.7: Feature crossing performed on original features</figcaption></div></figure></center>
<p>This method allows the model to capture certain pairwise (second-order) feature interactions. However, it has three shortcomings:</p>
<ul>
<li>
<p><strong>Manual process:</strong> Human involvement is required to choose features to be crossed, which is time-consuming and expensive.</p>
</li>
<li>
<p><strong>Requires domain knowledge:</strong> Feature crossing requires domain expertise. To determine which interactions between features are predictive signals for the model, we need to understand the problem and the feature space in advance.</p>
</li>
<li>
<p><strong>Cannot capture complex interactions:</strong> Crossed features may not be sufficient to capture all the complex interactions from thousands of sparse features.</p>
</li>
<li>
<p><strong>Sparsity:</strong> The original features can be sparse. With feature crossing, the cardinality of the crossed features can become much larger, leading to more sparsity.</p>
</li>
</ul>
<p>Given the drawbacks, this method is not an ideal solution for the ad prediction system.</p>
<h4 id="gradient-boosted-decision-trees-gbdt">Gradient-boosted decision trees (GBDT)</h4>
<p>We examined GBDT in Chapter 7, Event Recommendation System. Here, we will only explore the pros and cons of GBDT when applied to the ad click prediction system.</p>
<p><strong>Pros</strong></p>
<ul>
<li>GBDT is interpretable and easy to understand</li>
</ul>
<p><strong>Cons</strong></p>
<ul>
<li>
<p><strong>Inefficient for continual learning.</strong> In ad click prediction systems, we continuously collect new data such as user, ad, and interaction data. To continually train a model on new data, we generally have two options: 1) training from scratch, or 2) fine-tuning the model on new data. GBDT is not designed to be fine-tuned with new data. So we usually need to train the model from scratch, which is inefficient at a large scale.</p>
</li>
<li>
<p><strong>Cannot train embedding layers.</strong> In ad prediction systems, it's common to have many sparse categorical features, and the embedding layer is an effective way to represent these features. However, GBDT cannot benefit from embedding layers.</p>
</li>
</ul>
<h4 id="gbdt--lr">GBDT + LR</h4>
<p>There are two steps in this approach:</p>
<ol>
<li>Train the GBDT model to learn the task.</li>
<li>Instead of using the trained model to make predictions, use it to select and extract new predictive features. The newly generated features and the original features are used as input into the LR model for predicting clicks.</li>
</ol>
<p><strong>Use GBDT for feature selection</strong>
Feature selection is intended to reduce the number of input features to only those most useful and informative. Using decision trees, we can select a subset of features based on their importance. To better understand how decision trees are used for feature generation, refer to [5].</p>
<p><strong>Use GBDT for feature extraction</strong>
The purpose of feature extraction is to reduce the number of features by creating new features from existing ones. The newly extracted features are expected to have better predictive power. Figure <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8.8</mn></mrow><annotation encoding="application/x-tex">8.8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">8.8</span></span></span></span> explains how to extract features using GBDT.</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a schematic of a Gradient Boosting Decision Tree (GBDT) model extracting features.  At the top, a horizontal rectangle labeled 'Original features' represents the input data, a vector of features.  This vector is fed into three separate decision tree ensembles, each labeled T1, T2, and T3, which are components of the overall GBDT. Each tree is depicted as a series of nodes, with leaf nodes containing numerical values (1, 2, 3, 4).  Dashed boxes enclose the leaf nodes of each tree. Arrows indicate the flow of data through the trees.  The output of each tree is a vector of binary values (0s and 1s) representing extracted features, shown in horizontal rectangles labeled 'Extracted features:' at the bottom.  These extracted features are the result of the data traversing the decision trees, with each leaf node's value contributing to the final feature vector.  The entire GBDT is enclosed in a dashed box." loading="lazy" width="600" height="371" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(600px, 100vw), (max-width: 1200px) min(600px, 80vw), min(600px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-08-1-SARHSQGK.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-08-1-SARHSQGK.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-08-1-SARHSQGK.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-08-1-SARHSQGK.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-08-1-SARHSQGK.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-08-1-SARHSQGK.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-08-1-SARHSQGK.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-08-1-SARHSQGK.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-08-1-SARHSQGK.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 8.8: Use GBDT for feature extraction</figcaption></div></figure></center>
<p>An overview of GBDT in use followed by LR, is shown in Figure 8.9.</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a machine learning model ensemble.  At the bottom, a block labeled 'Original features' represents the initial dataset's features, which are fed into a Gradient Boosting Decision Tree (GBDT) model. The GBDT model processes these features and outputs 'Extracted features,' a transformed feature set.  Simultaneously, a separate process selects a subset of the 'Original features,' resulting in 'Selected features.' Both the 'Extracted features' and 'Selected features' are then fed as inputs into a Logistic Regression (LR) model, labeled 'LR.' Finally, the LR model receives a parameter 'p' as input from above, likely representing a hyperparameter or external control variable. The arrows indicate the direction of data flow, showing how the different components interact to produce a final prediction or output from the LR model." loading="lazy" width="520" height="385" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(520px, 100vw), (max-width: 1200px) min(520px, 80vw), min(520px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-09-1-RMHE3O5R.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-09-1-RMHE3O5R.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-09-1-RMHE3O5R.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-09-1-RMHE3O5R.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-09-1-RMHE3O5R.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-09-1-RMHE3O5R.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-09-1-RMHE3O5R.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-09-1-RMHE3O5R.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-09-1-RMHE3O5R.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 8.9: GBDT + LR overview</figcaption></div></figure></center>
<p>Let’s explore the pros and cons of this approach.</p>
<p><strong>Pros:</strong></p>
<ul>
<li>In contrast to the existing features, the newly created ones produced by GBDT are more predictive, making it easier for the LR model to learn the task.</li>
</ul>
<p><strong>Cons:</strong></p>
<ul>
<li>
<p><strong>Cannot capture complex interactions.</strong> Similar to LR, this approach cannot learn pairwise feature interactions.</p>
</li>
<li>
<p><strong>Continual learning is slow.</strong> Fine-tuning GBDT models on new data takes time, which slows down continual learning overall.</p>
</li>
</ul>
<h4 id="neural-network-nn">Neural network (NN)</h4>
<p>NN is another candidate for building the ad click prediction system. To predict click probabilities using a NN, we have two architectural options:</p>
<ul>
<li>Single NN</li>
<li>Two-tower architecture</li>
</ul>
<p><strong>Single NN:</strong> Using the original features as input, a neural network outputs the click probability (Figure 8.10).</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><div style="position: relative; width: 300px; height: 255px;"><img alt="Image represents a simplified machine learning model for predicting the probability of a user clicking an ad.  At the bottom, a rectangular box labeled 'Original features' is depicted as a series of equally sized, smaller, unlabeled boxes representing individual input features about the user. An upward arrow connects this box to a larger rectangular box labeled 'Neural network,' indicating that the original features are fed as input to the neural network.  The neural network processes these features.  An upward arrow then connects the neural network to a smaller square box labeled 'p' at the top, which represents the output of the model: the probability (p) of the user clicking the ad.  Above the 'p' box, the text 'Probability of this user clicking the ad' clarifies the meaning of the output. The overall flow is bottom-up, from input features through the neural network to the final probability prediction." loading="lazy" width="300" height="255" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(300px, 100vw), (max-width: 1200px) min(300px, 80vw), min(300px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-10-1-YMWPOWQY.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-10-1-YMWPOWQY.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-10-1-YMWPOWQY.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-10-1-YMWPOWQY.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-10-1-YMWPOWQY.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-10-1-YMWPOWQY.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-10-1-YMWPOWQY.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-10-1-YMWPOWQY.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-10-1-YMWPOWQY.png&amp;w=3840&amp;q=75" style="color: transparent;"></div></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 8.10: NN architecture</figcaption></div></figure></center>
<p>Two-tower architecture: In this option, we use two encoders: user encoder and ad encoder. The similarity between ad and user embeddings is used to determine the relevance, that is, the click probability. Figure 8.11 shows an overview of this architecture.</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a two-tower neural network architecture for predicting click-through rates (CTR) in a recommendation system.  The system consists of two independent towers: a 'User encoder' and an 'Ad encoder.'  The User encoder processes 'User-related features' (represented as a horizontal block of cells) to generate a 'User embedding,' a vector of numerical values (e.g., 0.1, 0.7, -0.1, 0.6, 0.5). Similarly, the Ad encoder processes 'Ad-related features' to produce an 'Ad embedding' (e.g., 0, 0.1, -0.9, 0.3, -0.3).  A dashed line connects the User and Ad embeddings, indicating that a similarity measure (represented as P(click) ~ Similarity) is calculated between these two vectors to predict the probability of a user clicking on a given ad.  The entire structure is labeled 'Two-tower NN,' highlighting the two-tower nature of the neural network.  The arrows indicate the flow of information: from features to embeddings, and then the embeddings are used to compute the click-through rate probability." loading="lazy" width="400" height="353" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(400px, 100vw), (max-width: 1200px) min(400px, 80vw), min(400px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-11-1-3D2KHTZQ.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-11-1-3D2KHTZQ.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-11-1-3D2KHTZQ.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-11-1-3D2KHTZQ.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-11-1-3D2KHTZQ.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-11-1-3D2KHTZQ.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-11-1-3D2KHTZQ.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-11-1-3D2KHTZQ.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-11-1-3D2KHTZQ.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 8.11: Embedding-based NN</figcaption></div></figure></center>
<p>Although NNs have many benefits, they may not be the best choice for ad click prediction systems because:</p>
<ul>
<li>
<p><strong>Sparsity:</strong> Given that the feature space is usually huge and sparse, most features are filled with zeroes. It may not be possible for <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">N</mi><mi mathvariant="normal">N</mi></mrow><annotation encoding="application/x-tex">\mathrm{NN}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord"><span class="mord mathrm">NN</span></span></span></span></span> to learn the task effectively because it does not have access to enough data points.</p>
</li>
<li>
<p><strong>Difficult to capture all pairwise feature interactions</strong> due to the large number of features.</p>
</li>
</ul>
<p>Given these limitations, we will not use NNs.</p>
<h4 id="deep--cross-network-dcn">Deep &amp; Cross Network (DCN)</h4>
<p>In 2017, Google proposed an architecture named DCN [6] to find feature interactions automatically. This addresses the challenges of the manual feature crossing method. The following two parallel networks are used in this method:</p>
<ul>
<li>
<p><strong>Deep network:</strong> Learns complex and generalizable features using a Deep Neural Network (DNN) architecture.</p>
</li>
<li>
<p><strong>Cross network:</strong> Automatically captures feature interactions and learns good feature crosses.</p>
</li>
</ul>
<p>The outputs of deep network and cross network are concatenated to make a final prediction.</p>
<p>There are two types of DCN architectures: stacked and parallel. Figure <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8.12</mn></mrow><annotation encoding="application/x-tex">8.12</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">8.12</span></span></span></span> shows the architecture of a parallel DCN. To learn more about stacked architecture, refer to [7]. Note that it's not usually expected to provide details of DCN during ML system design interviews. If you are interested in learning more about DCN networks, refer to [7] [8].</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><div style="position: relative; width: 350px; height: 575px;"><img alt="Image represents a machine learning model architecture.  At the bottom, 'Sparse input features' feed into 'Embedding layers', which generate 'Feature embeddings (Dense features)'. These dense features are input to a 'Deep neural network'.  Separately, 'Dense input features' are processed by a 'Cross network'. The outputs of the 'Deep neural network' and 'Cross network' are then 'Concatenated'. This concatenated output is fed into a 'Sigmoid' layer, producing a final 'Probability' output (P).  The diagram shows data flowing upwards, indicating a feedforward architecture.  The 'Deep neural network' and 'Cross network' represent distinct processing paths for different feature types, with their results combined to make a final prediction.  The shaded rectangles represent the output vectors of each layer, showing the dimensionality of the data at each stage." loading="lazy" width="350" height="575" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(350px, 100vw), (max-width: 1200px) min(350px, 80vw), min(350px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-12-1-CX5PRL67.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-12-1-CX5PRL67.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-12-1-CX5PRL67.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-12-1-CX5PRL67.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-12-1-CX5PRL67.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-12-1-CX5PRL67.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-12-1-CX5PRL67.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-12-1-CX5PRL67.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-12-1-CX5PRL67.png&amp;w=3840&amp;q=75" style="color: transparent;"></div></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 8.12: DCN architecture</figcaption></div></figure></center>
<p>DCN architecture is more effective than neural networks because it implicitly learns feature crosses. However, the cross network only models certain feature interactions, which may negatively affect the performance of the cross network model.</p>
<h4 id="factorization-machines-fm">Factorization Machines (FM)</h4>
<p>FM is an embedding-based model which improves logistic regression by automatically modeling all pairwise feature interactions. In ad click prediction systems, FM is widely used because it can efficiently model complex interactions between features.</p>
<p>So, let's understand how FM works. It automatically models all pairwise feature interactions by learning an embedding vector for each feature. The interaction between two features is determined by the dot product of their embeddings. Let's look at its formula to understand it better:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mi>y</mi><mo>^</mo></mover><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>w</mi><mn>0</mn></msub><mo>+</mo><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>w</mi><mi>i</mi></msub><msub><mi>x</mi><mi>i</mi></msub><mo>+</mo><munder><mo>∑</mo><mi>i</mi></munder><munder><mo>∑</mo><mi>j</mi></munder><mo stretchy="false">⟨</mo><msub><mi>v</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>v</mi><mi>j</mi></msub><mo stretchy="false">⟩</mo><msub><mi>x</mi><mi>i</mi></msub><msub><mi>x</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\hat{y}(x)=w_0+\sum_i w_i x_i+\sum_i \sum_j\langle v_i, v_j\rangle x_i x_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6944em;"><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal" style="margin-right: 0.03588em;">y</span></span><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1944em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.7333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 2.3277em; vertical-align: -1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.05em;"><span style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 2.4638em; vertical-align: -1.4138em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.05em;"><span style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.05em;"><span style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.05724em;">j</span></span></span><span style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.4138em;"><span></span></span></span></span></span><span class="mopen">⟨</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span></span></span></span></span></span></span><span class="mclose">⟩</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span></span></span></span></span></span></span></span></span></span></span>
<p>Where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> refers to the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span>-th feature, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">w_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> is the learned
weight, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">v_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> represents the embedding of the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span>-th feature.
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟨</mo></mrow><annotation encoding="application/x-tex">\langle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">⟨</span></span></span></span> v_i, v_j <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">\rangle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mclose">⟩</span></span></span></span> denotes the dot product between two
embeddings.</p>
<p>This formula may look complex, but it's actually easy to understand. The first two terms compute a linear combination of the features, similar to how logistic regression works. The third term models pairwise feature interactions. Figure <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8.13</mn></mrow><annotation encoding="application/x-tex">8.13</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">8.13</span></span></span></span> shows a high-level overview of FM. Refer to [9] to learn the details of FM.</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mi>y</mi><mo>^</mo></mover><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><munder><munder><mrow><msub><mi>w</mi><mn>0</mn></msub><mo>+</mo><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>w</mi><mi>i</mi></msub><msub><mi>x</mi><mi>i</mi></msub></mrow><mo stretchy="true">⏟</mo></munder><mtext>Logistic&nbsp;regression</mtext></munder><mo>+</mo><munder><munder><mrow><munder><mo>∑</mo><mi>i</mi></munder><munder><mo>∑</mo><mi>j</mi></munder><mo stretchy="false">⟨</mo><msub><mi>v</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>v</mi><mi>j</mi></msub><mo stretchy="false">⟩</mo><msub><mi>x</mi><mi>i</mi></msub><msub><mi>x</mi><mi>j</mi></msub></mrow><mo stretchy="true">⏟</mo></munder><mtext>Pairwise&nbsp;interactions</mtext></munder></mrow><annotation encoding="application/x-tex">\hat{y}(x)=\underbrace{w_0+\sum_i w_i x_i}_{\text{Logistic regression}}+\underbrace{\sum_i \sum_j\langle v_i, v_j\rangle x_i x_j}_{\text{Pairwise interactions}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6944em;"><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal" style="margin-right: 0.03588em;">y</span></span><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1944em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 3.7901em; vertical-align: -2.7401em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.05em;"><span style="top: -0.446em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Logistic&nbsp;regression</span></span></span></span></span><span style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.05em;"><span class="svg-align" style="top: -1.1243em;"><span class="pstrut" style="height: 3.05em;"></span><span class="stretchy" style="height: 0.548em; min-width: 1.6em;"><span class="brace-left" style="height: 0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMinYMin slice"><path d="M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13
 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688
 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7
-331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z"></path></svg></span><span class="brace-center" style="height: 0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMidYMin slice"><path d="M199572 214
c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14
 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3
 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0
-5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z"></path></svg></span><span class="brace-right" style="height: 0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMaxYMin slice"><path d="M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3
 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237
-174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z"></path></svg></span></span></span><span style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.05em;"><span style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.9257em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.7401em;"><span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 3.7901em; vertical-align: -2.7401em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.05em;"><span style="top: -0.3099em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Pairwise&nbsp;interactions</span></span></span></span></span><span style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class="mord munder"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.05em;"><span class="svg-align" style="top: -0.9882em;"><span class="pstrut" style="height: 3.05em;"></span><span class="stretchy" style="height: 0.548em; min-width: 1.6em;"><span class="brace-left" style="height: 0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMinYMin slice"><path d="M0 6l6-6h17c12.688 0 19.313.3 20 1 4 4 7.313 8.3 10 13
 35.313 51.3 80.813 93.8 136.5 127.5 55.688 33.7 117.188 55.8 184.5 66.5.688
 0 2 .3 4 1 18.688 2.7 76 4.3 172 5h399450v120H429l-6-1c-124.688-8-235-61.7
-331-161C60.687 138.7 32.312 99.3 7 54L0 41V6z"></path></svg></span><span class="brace-center" style="height: 0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMidYMin slice"><path d="M199572 214
c100.7 8.3 195.3 44 280 108 55.3 42 101.7 93 139 153l9 14c2.7-4 5.7-8.7 9-14
 53.3-86.7 123.7-153 211-199 66.7-36 137.3-56.3 212-62h199568v120H200432c-178.3
 11.7-311.7 78.3-403 201-6 8-9.7 12-11 12-.7.7-6.7 1-18 1s-17.3-.3-18-1c-1.3 0
-5-4-11-12-44.7-59.3-101.3-106.3-170-141s-145.3-54.3-229-60H0V214z"></path></svg></span><span class="brace-right" style="height: 0.548em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="0.548em" viewBox="0 0 400000 548" preserveAspectRatio="xMaxYMin slice"><path d="M399994 0l6 6v35l-6 11c-56 104-135.3 181.3-238 232-57.3
 28.7-117 45-179 50H-300V214h399897c43.3-7 81-15 113-26 100.7-33 179.7-91 237
-174 2.7-5 6-9 10-13 .7-1 7.3-1 20-1h17z"></path></svg></span></span></span><span style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.05em;"><span style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.05em;"><span style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.05724em;">j</span></span></span><span style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.4138em;"><span></span></span></span></span></span><span class="mopen">⟨</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span></span></span></span></span></span></span><span class="mclose">⟩</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.0618em;"><span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.7401em;"><span></span></span></span></span></span></span></span></span></span>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a Factorization Machine model.  The model takes sparse input features (represented by five empty boxes within a dashed rectangle) as input. These features are fed into embedding layers (a rectangular box), which transform them into dense feature embeddings (multiple columns of empty boxes within a dashed rectangle).  These dense features are then processed to calculate pairwise feature interactions (a rectangular box), which represent the interactions between pairs of features.  Simultaneously, per-feature weights (a rectangular box) are calculated.  Both the pairwise feature interactions and the per-feature weights are then summed (+) and passed through a sigmoid function (a rectangular box) to produce a probability (a rectangular box labeled 'p'). The entire process from sparse input features to the final probability is enclosed within a dashed line labeled 'Factorization Machine'.  Arrows indicate the flow of information between components." loading="lazy" width="420" height="590" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(420px, 100vw), (max-width: 1200px) min(420px, 80vw), min(420px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-13-1-H33OCDXR.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-13-1-H33OCDXR.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-13-1-H33OCDXR.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-13-1-H33OCDXR.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-13-1-H33OCDXR.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-13-1-H33OCDXR.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-13-1-H33OCDXR.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-13-1-H33OCDXR.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-13-1-H33OCDXR.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 8.13: Factorization Machine architecture</figcaption></div></figure></center>
<p>FM and its variants, such as FFM, effectively capture pairwise interactions between features. FM cannot learn sophisticated higher-order interactions from features, unlike neural networks, which can. In the next method, we combine FM and DNN to overcome this.</p>
<h4 id="deep-factorization-machines-deepfm">Deep Factorization Machines (DeepFM)</h4>
<p>DeepFM is an ML model that combines the strengths of both NN and FM. A DNN network captures sophisticated higher-order features, and an FM captures low-level pairwise feature interactions. Figure 8.14 shows the high-level architecture of DeepFM. If you are interested to learn more about DeepFM, refer to [10].</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a machine learning model architecture for predicting a probability (labeled 'P').  The model takes sparse input features (represented by several small squares within a dashed box labeled 'Sparse input features') as input. These features are processed through embedding layers, transforming them into dense feature embeddings (multiple rectangular boxes within a dashed box labeled 'Feature embeddings (Dense features)').  These dense features are then fed into three separate components: 'Per feature weights' (a box representing per-feature weights), 'Pairwise feature interactions' (a box representing pairwise interactions between features), and a 'Deep neural network' (a box representing a deep neural network). The outputs of these three components are summed (+) before being passed through a sigmoid function, resulting in a final probability output (P).  Arrows indicate the flow of information between components, showing how the processed features contribute to the final probability prediction." loading="lazy" width="420" height="588" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(420px, 100vw), (max-width: 1200px) min(420px, 80vw), min(420px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-14-1-CW7JJ5XS.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-14-1-CW7JJ5XS.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-14-1-CW7JJ5XS.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-14-1-CW7JJ5XS.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-14-1-CW7JJ5XS.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-14-1-CW7JJ5XS.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-14-1-CW7JJ5XS.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-14-1-CW7JJ5XS.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-14-1-CW7JJ5XS.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 8.14: DeepFM overview</figcaption></div></figure></center>
<p>One potential improvement is to combine GBDT and DeepFM. A GBDT converts the original features into more predictive features, while DeepFM operates on the new features. This method has won various ad prediction system competitions [11]. However, adding GBDT to DeepFM negatively affects the training and inference speed, and slows down the continual learning process.</p>
<p>In practice, we usually choose the correct model by running experiments. In our case, we start with a simple LR to create a baseline. Next, we experiment with DCN and DeepFM, as both are widely used in the tech industry.</p>
<h3 id="model-training">Model training</h3>
<h4 id="constructing-the-dataset">Constructing the dataset</h4>
<p>For every ad impression, we construct a new data point. The input features are computed
from the user and the ad. A label is assigned to the data point, based on the following
strategy:</p>
<ul>
<li>
<p><strong>Positive label:</strong> if the user clicks the ad in less than t seconds after the ad is shown, we label the data point as "positive". Note that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> is a hyperparameter and can be tuned via experimentation.</p>
</li>
<li>
<p><strong>Negative label:</strong> if the user does not click the ad in less than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> seconds, we label the data point as "negative".</p>
</li>
</ul>
<p>In practice, companies use more complex methods to find the optimal strategy for labeling negative data points. To learn more, refer to [1].</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a tabular dataset seemingly used for training a machine learning model, likely for ad click prediction.  The table is divided into four columns: a serial number column (#), a column for 'User and interaction features' (represented as a vector of numerical values), a column for 'Ad features' (also a numerical vector), and a 'Label' column indicating whether the data point represents a positive (ad click) or negative (no click) outcome. Each row represents a single data instance.  For instance, row 1 shows a vector of user and interaction features [1, 0, 1, 0.8, 0.1, 1, 0], a vector of ad features [0, 1, 1, 0.4, 0.9, 0], and a positive label. Row 2 similarly presents another data instance with different feature values and a negative label. The numerical values within the feature vectors likely represent different attributes or characteristics of the user, their interaction, and the ad itself.  The table structure suggests a supervised learning scenario where the model learns to associate feature vectors with their corresponding positive or negative labels." loading="lazy" width="600" height="156" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(600px, 100vw), (max-width: 1200px) min(600px, 80vw), min(600px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-15-1-VBQDNO5G.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-15-1-VBQDNO5G.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-15-1-VBQDNO5G.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-15-1-VBQDNO5G.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-15-1-VBQDNO5G.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-15-1-VBQDNO5G.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-15-1-VBQDNO5G.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-15-1-VBQDNO5G.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-15-1-VBQDNO5G.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 8.15: Constructed dataset</figcaption></div></figure></center>
<p>To keep the model adaptive to new data, it must continuously be trained. As a result, new training data points should be continuously generated using new interactions. We will discuss continual learning further in the serving section.</p>
<h4 id="choosing-the-loss-function">Choosing the loss function</h4>
<p>Since we are training a binary classification model, we choose cross-entropy as a classification loss function.</p>
<h2 id="evaluation">Evaluation</h2>
<h3 id="offline-metrics">Offline metrics</h3>
<p>Two metrics are typically used to evaluate an ad click prediction system:</p>
<ul>
<li>Cross-entropy (CE)</li>
<li>Normalized cross-entropy (NCE)</li>
</ul>
<p><strong>CE.</strong> This metric measures how close the model's predicted probabilities are to the ground truth labels. CE is zero if we have an ideal system that predicts a 0 for the negative classes and 1 for the positive classes. The lower the CE, the higher the accuracy of the prediction. The formula is:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>H</mi><mo stretchy="false">(</mo><mi>p</mi><mo separator="true">,</mo><mi>q</mi><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><munderover><mo>∑</mo><mrow><mi>c</mi><mo>=</mo><mn>1</mn></mrow><mi>C</mi></munderover><msub><mi>p</mi><mi>c</mi></msub><mi>log</mi><mo>⁡</mo><msub><mi>q</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">H(p, q)=-\sum_{c=1}^C p_c \log q_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.03588em;">q</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 3.0954em; vertical-align: -1.2671em;"></span><span class="mord">−</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.8283em;"><span style="top: -1.8829em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2671em;"><span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop">lo<span style="margin-right: 0.01389em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span></span>
<p>where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span> is the ground truth, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.03588em;">q</span></span></span></span> is the predicted probability, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.07153em;">C</span></span></span></span> is the total number of classes.</p>
<p>For binary classification, the CE formula can be rewritten as:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>H</mi><mo stretchy="false">(</mo><mi>p</mi><mo separator="true">,</mo><mi>q</mi><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>p</mi><mi>i</mi></msub><mi>log</mi><mo>⁡</mo><msub><mi>q</mi><mi>i</mi></msub><mo>=</mo><mo>−</mo><munder><mo>∑</mo><mi>i</mi></munder><mrow><mo fence="true">(</mo><msub><mi>y</mi><mi>i</mi></msub><mi>log</mi><mo>⁡</mo><msub><mover accent="true"><mi>y</mi><mo>^</mo></mover><mi>i</mi></msub><mo>+</mo><mrow><mo fence="true">(</mo><mn>1</mn><mo>−</mo><msub><mi>y</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow><mi>log</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mn>1</mn><mo>−</mo><msub><mover accent="true"><mi>y</mi><mo>^</mo></mover><mi>i</mi></msub><mo fence="true">)</mo></mrow><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">H(p, q)=-\sum_i p_i \log q_i=-\sum_i\left(y_i \log \hat{y}_i+\left(1-y_i\right) \log \left(1-\hat{y}_i\right)\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.03588em;">q</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.3277em; vertical-align: -1.2777em;"></span><span class="mord">−</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.05em;"><span style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop">lo<span style="margin-right: 0.01389em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.3277em; vertical-align: -1.2777em;"></span><span class="mord">−</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.05em;"><span style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop">lo<span style="margin-right: 0.01389em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6944em;"><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal" style="margin-right: 0.03588em;">y</span></span><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1944em;"><span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop">lo<span style="margin-right: 0.01389em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6944em;"><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal" style="margin-right: 0.03588em;">y</span></span><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1944em;"><span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span></span></span>
<p>where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">y_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> is the ground truth label of the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span>-th data point and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>y</mi><mo>^</mo></mover><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\hat{y}_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6944em;"><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal" style="margin-right: 0.03588em;">y</span></span><span style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1944em;"><span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> is the predicted probability of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span>-th data point.</p>
<p>Let's take a look at a concrete example, as shown in Figure 8.16.</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a comparison of two machine learning models, Model A and Model B, using cross-entropy (CE) loss to evaluate their performance on a click-through rate prediction task.  Three ad examples are shown, each with a visual representation (video camera or mountain icons) and a true label indicating whether a click occurred (1 for clicked, 0 for not clicked).  For each ad, both Model A and Model B provide a predicted probability of a click, P(click).  These predictions, along with the true labels, are used to calculate the cross-entropy loss for each model. The formula for cross-entropy is shown: CE = -Σᵢ yᵢ log ŷᵢ + (1 - yᵢ) log (1 - ŷᵢ). The calculated CE values for Model A (0.273) and Model B (1.319) are displayed.  A comparison of these CE values shows that CE for Model A is less than CE for Model B, indicating that Model A is a better performing model because it has a lower loss.  Dashed arrows visually connect the predictions and true labels to the CE calculation, and another arrow connects the calculated CE values to the final conclusion that Model A is better than Model B." loading="lazy" width="600" height="551" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(600px, 100vw), (max-width: 1200px) min(600px, 80vw), min(600px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-16-1-O35DQUM2.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-16-1-O35DQUM2.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-16-1-O35DQUM2.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-16-1-O35DQUM2.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-16-1-O35DQUM2.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-16-1-O35DQUM2.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-16-1-O35DQUM2.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-16-1-O35DQUM2.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-16-1-O35DQUM2.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 8.16: CE of two ML models</figcaption></div></figure></center>
<p>Note that aside from using CE as a metric, it is also commonly used as a standard loss function in classification tasks during model training.</p>
<p><strong>Normalized cross-entropy (NCE)</strong>. NCE is the ratio between our model's <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">C</mi><mi mathvariant="normal">E</mi></mrow><annotation encoding="application/x-tex">\mathrm{CE}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord"><span class="mord mathrm">CE</span></span></span></span></span> and the CE of the background CTR (average CTR in the training data). In other words, NCE compares the model with a simple baseline which always predicts the background CTR. A low NCE indicates the model outperforms the simple baseline. <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mi>C</mi><mi>E</mi><mo>≥</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">N C E \geq 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8193em; vertical-align: -0.136em;"></span><span class="mord mathnormal" style="margin-right: 0.05764em;">NCE</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1</span></span></span></span> indicates that the model is not performing better than the simple baseline.</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>&nbsp;Normalized&nbsp;cross&nbsp;entropy&nbsp;</mtext><mo>=</mo><mfrac><mrow><mi>C</mi><mi>E</mi><mo stretchy="false">(</mo><mtext>&nbsp;ML&nbsp;model&nbsp;</mtext><mo stretchy="false">)</mo></mrow><mrow><mi>C</mi><mi>E</mi><mo stretchy="false">(</mo><mtext>&nbsp;Simple&nbsp;baseline&nbsp;</mtext><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text { Normalized cross entropy }=\frac{C E(\text { ML model })}{C E(\text { Simple baseline })}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord text"><span class="mord">&nbsp;Normalized&nbsp;cross&nbsp;entropy&nbsp;</span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.363em; vertical-align: -0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em;"><span style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.05764em;">CE</span><span class="mopen">(</span><span class="mord text"><span class="mord">&nbsp;Simple&nbsp;baseline&nbsp;</span></span><span class="mclose">)</span></span></span><span style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.05764em;">CE</span><span class="mopen">(</span><span class="mord text"><span class="mord">&nbsp;ML&nbsp;model&nbsp;</span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>
<p>Let's take a look at a concrete example to understand better how NCE is calculated. As shown in Figure 8.17, a simple baseline model always predicts <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.6</mn></mrow><annotation encoding="application/x-tex">0.6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">0.6</span></span></span></span> (CTR in the training data). In this case, the NCE value is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.324</mn></mrow><annotation encoding="application/x-tex">0.324</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">0.324</span></span></span></span> (less than 1), indicating model A outperforms the simple baseline.</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a calculation of Normalized Cross-Entropy (NCE) for a machine learning model (Model A) predicting click-through rates (CTR) on advertisements.  Three ads are shown, each with a visual representation (Ad 1: video camera; Ad 2: mountains; Ad 3: video camera) and associated true labels (1 for clicked, 0 for not clicked).  Model A provides predicted probabilities of clicks (P(click)) for each ad.  A baseline CTR (background CTR) is also provided, representing a constant probability of a click regardless of the ad.  The cross-entropy (CE) is calculated for both Model A and the baseline using the formula:  -Σᵢ yᵢ log ŷᵢ + (1 - yᵢ) log (1 - ŷᵢ), where yᵢ is the true label and ŷᵢ is the predicted probability.  The calculated CE for Model A is 0.273, and for the baseline is 0.842.  Finally, the NCE for Model A is computed by dividing the Model A CE by the baseline CE (0.273 / 0.842 = 0.324), indicating the relative performance of Model A compared to the baseline.  Dashed arrows visually connect the relevant components, showing the flow of information from the ads and predictions to the CE calculations and finally to the NCE calculation." loading="lazy" width="600" height="512" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(600px, 100vw), (max-width: 1200px) min(600px, 80vw), min(600px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-17-1-MMNIBRQY.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-17-1-MMNIBRQY.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-17-1-MMNIBRQY.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-17-1-MMNIBRQY.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-17-1-MMNIBRQY.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-17-1-MMNIBRQY.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-17-1-MMNIBRQY.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-17-1-MMNIBRQY.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-17-1-MMNIBRQY.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 8.17: NCE calculations for model A</figcaption></div></figure></center>
<h3 id="online-metrics">Online metrics</h3>
<p>Let's examine some metrics we may use during online evaluation.</p>
<ul>
<li>CTR</li>
<li>Conversion rate</li>
<li>Revenue lift</li>
<li>Hide rate</li>
</ul>
<p><strong>CTR</strong>. This metric measures the ratio between clicked ads and the total number of shown ads.</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>C</mi><mi>T</mi><mi>R</mi><mo>=</mo><mfrac><mtext>&nbsp;Number&nbsp;of&nbsp;clicked&nbsp;ads&nbsp;</mtext><mtext>&nbsp;Number&nbsp;of&nbsp;shown&nbsp;ads&nbsp;</mtext></mfrac></mrow><annotation encoding="application/x-tex">C T R=\frac{\text { Number of clicked ads }}{\text { Number of shown ads }}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.00773em;">CTR</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.0574em; vertical-align: -0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3714em;"><span style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord text"><span class="mord">&nbsp;Number&nbsp;of&nbsp;shown&nbsp;ads&nbsp;</span></span></span></span><span style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord text"><span class="mord">&nbsp;Number&nbsp;of&nbsp;clicked&nbsp;ads&nbsp;</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>
<p>CTR is a great online metric for ad click prediction systems, as maximizing user clicks on ads is directly related to an increase in revenue.</p>
<p><strong>Conversion rate.</strong> This metric measures the ratio between the number of conversions and the total number of ads shown.</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>&nbsp;Conversion&nbsp;rate&nbsp;</mtext><mo>=</mo><mfrac><mtext>&nbsp;Number&nbsp;of&nbsp;conversions&nbsp;</mtext><mtext>&nbsp;Number&nbsp;of&nbsp;impressions&nbsp;</mtext></mfrac></mrow><annotation encoding="application/x-tex">\text { Conversion rate }=\frac{\text { Number of conversions }}{\text { Number of impressions }}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord text"><span class="mord">&nbsp;Conversion&nbsp;rate&nbsp;</span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.2519em; vertical-align: -0.8804em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3714em;"><span style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord text"><span class="mord">&nbsp;Number&nbsp;of&nbsp;impressions&nbsp;</span></span></span></span><span style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord text"><span class="mord">&nbsp;Number&nbsp;of&nbsp;conversions&nbsp;</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>
<p>This metric is important to track as it indicates how many times advertisers actually benefited from the system. This matters because advertisers will eventually lose interest and cease spending on ads if their ads do not lead to conversions.</p>
<p><strong>Revenue lift.</strong> This measures the percentage of revenue increase over time.</p>
<p><strong>Hide rate.</strong> This metric measures the ratio between the number of ads hidden by users and the number of shown ads.</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>&nbsp;Hide&nbsp;rate&nbsp;</mtext><mo>=</mo><mfrac><mtext>&nbsp;Number&nbsp;of&nbsp;ads&nbsp;hidden&nbsp;by&nbsp;users&nbsp;</mtext><mtext>&nbsp;Number&nbsp;of&nbsp;shown&nbsp;ads&nbsp;</mtext></mfrac></mrow><annotation encoding="application/x-tex">\text { Hide rate }=\frac{\text { Number of ads hidden by users }}{\text { Number of shown ads }}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord text"><span class="mord">&nbsp;Hide&nbsp;rate&nbsp;</span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.0574em; vertical-align: -0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3714em;"><span style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord text"><span class="mord">&nbsp;Number&nbsp;of&nbsp;shown&nbsp;ads&nbsp;</span></span></span></span><span style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord text"><span class="mord">&nbsp;Number&nbsp;of&nbsp;ads&nbsp;hidden&nbsp;by&nbsp;users&nbsp;</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>
<p>This metric is helpful for understanding how many irrelevant ads the system displayed to users, also known as false positives.</p>
<h2 id="serving">Serving</h2>
<p>At serving time, the system is responsible for outputting a list of ads ranked by their click probabilities. The proposed ML system design is shown in Figure 8.18. Let's examine each of the following pipelines:</p>
<ul>
<li>Data preparation pipeline</li>
<li>Continual learning pipeline</li>
<li>Prediction pipeline</li>
</ul>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a machine learning system for ad ranking.  A stream of new data and interactions feeds into a 'Data preparation pipeline,' which consists of 'Batch feature computation' and 'Online feature computation' processing 'New data' and 'Data lake' respectively.  The outputs are stored in a 'Feature store.'  This pipeline also feeds into 'Dataset generation,' which creates a 'Training dataset' for the 'Continual learning pipeline.' This pipeline includes 'Model training,' 'Model validation and deployment,' and updates a 'Model registry.' The trained 'ML model' is then used by a 'Ranking service,' which receives input from the 'Pool of Ads' and the 'Feature store,' and performs online feature computation. The 'Ranking service' output is further processed by a 'Re-ranking service,' using the 'Online feature computation' and finally, a 'Prediction pipeline' generates 'Ranked ads' for the user.  The entire system is designed for continuous learning and improvement of the ad ranking model." loading="lazy" width="600" height="560" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(600px, 100vw), (max-width: 1200px) min(600px, 80vw), min(600px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-18-1-TYLNC6R7.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-18-1-TYLNC6R7.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-18-1-TYLNC6R7.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-18-1-TYLNC6R7.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-18-1-TYLNC6R7.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-18-1-TYLNC6R7.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-18-1-TYLNC6R7.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-18-1-TYLNC6R7.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fad-click-prediction-on-social-platforms%2Fch8-18-1-TYLNC6R7.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 8.18: ML system design</figcaption></div></figure></center>
<h3 id="data-preparation-pipeline">Data preparation pipeline</h3>
<p>The data preparation pipeline performs the following two tasks:</p>
<ol>
<li>Compute online and batch features</li>
<li>Continuously generate training data from new ads and interactions</li>
</ol>
<p>To compute features, the following two options are used: batch feature computation and online feature computation. Let's see how they differ from each other.</p>
<p><strong>Batch feature computation</strong>
Some of the features we chose are static, which means they change very rarely. For example, an ad's image and category are static features. This component computes static features periodically (e.g., every few days or weeks) with batch jobs and then stores the features in a feature store. This improves the system's performance during serving because the features are precomputed.</p>
<p><strong>Online feature computation</strong>
Some features are dynamic as they change frequently. For example, the numbers of ad impressions and clicks are examples of dynamic features. These features need to be computed at query time, and this component is used to compute dynamic features.</p>
<h3 id="continual-learning-pipeline">Continual learning pipeline</h3>
<p>Based on the requirements, continually learning the model is critical. This pipeline is responsible for fine-tuning the model on new training data, evaluating the new model, and deploying the model if it improves the metrics. It ensures the prediction pipeline always uses a model adapted to the most recent data.</p>
<h3 id="prediction-pipeline">Prediction pipeline</h3>
<p>The prediction pipeline takes a query user as input and outputs a list of ads ranked by their click probabilities. Since some of the features which the model relies upon are dynamic, we cannot use batch prediction. Instead, requests are served as they arrive using online prediction.</p>
<p>As we've seen in previous chapters, a two-stage architecture is used in the prediction pipeline. First, we employ a candidate generation service to efficiently narrow down the available pool of ads to a small subset of ads. In this case, we use the ad targeting criteria often provided by advertisers, such as target age, gender, and country.</p>
<p>Next, we employ a ranking model which fetches the candidate ads from the candidate generation service, ranks them based on click probability, and outputs the top ads. This component interacts with the same feature store and online feature computation component. Once the static and dynamic features are obtained, the ranking service uses the model to get a predicted click probability for each candidate ad. These probabilities are used to rank the ads and to output those with the highest click probability.</p>
<p>Finally, a re-ranking service modifies the list of ads by incorporating additional logic and heuristics. For example, we can increase the diversity of ads by removing very similar ads from the list.</p>
<h2 id="other-talking-points">Other Talking Points</h2>
<p>If there is time left at the end of the interview, here are some potential talking points you might discuss with the interviewer:</p>
<ul>
<li>In ranking and recommendation systems, it's important to avoid data leakage <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>12</mn><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mn>13</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[12][13]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">[</span><span class="mord">12</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord">13</span><span class="mclose">]</span></span></span></span></li>
<li>The model needs to be calibrated in ad click prediction systems. Discuss model calibration and techniques for calibrating a model [14].</li>
<li>A common variant of FM is a field-aware Factorization Machine (FFM). It's good to talk about FFM and how it differs from FM [15].</li>
<li>A common variant of DeepFM is XDeepFM. Talk about XDeepFM and how it differs from DeepFM [10].</li>
<li>We've described why continuous learning is necessary for ad click prediction systems. However, continual learning on new data may lead to catastrophic forgetting. Discuss what catastrophic forgetting is and what common solutions are [16].</li>
</ul>
<h2 id="references">References</h2>
<ol>
<li>Addressing delayed feedback. <a href="https://arxiv.org/pdf/1907.06558.pdf" target="_blank" rel="noopener noreferrer">https://arxiv.org/pdf/1907.06558.pdf</a>.</li>
<li>AdTech basics. <a href="https://advertising.amazon.com/library/guides/what-is-adtech" target="_blank" rel="noopener noreferrer">https://advertising.amazon.com/library/guides/what-is-adtech</a>.</li>
<li>SimCLR paper. <a href="https://arxiv.org/pdf/2002.05709.pdf" target="_blank" rel="noopener noreferrer">https://arxiv.org/pdf/2002.05709.pdf</a>.</li>
<li>Feature crossing. <a href="https://developers.google.com/machine-learning/crash-course/feature-crosses/video-lecture" target="_blank" rel="noopener noreferrer">https://developers.google.com/machine-learning/crash-course/feature-crosses/video-lecture</a>.</li>
<li>Feature extraction with GBDT. <a href="https://towardsdatascience.com/gradient-boosted-decision-trees-explained-9259bd8205af/" target="_blank" rel="noopener noreferrer">https://towardsdatascience.com/gradient-boosted-decision-trees-explained-9259bd8205af/</a>.</li>
<li>DCN paper. <a href="https://arxiv.org/pdf/1708.05123.pdf" target="_blank" rel="noopener noreferrer">https://arxiv.org/pdf/1708.05123.pdf</a>.</li>
<li>DCN V2 paper. <a href="https://arxiv.org/pdf/2008.13535.pdf" target="_blank" rel="noopener noreferrer">https://arxiv.org/pdf/2008.13535.pdf</a>.</li>
<li>Microsoft’s deep crossing network paper. <a href="https://www.kdd.org/kdd2016/papers/files/adf0975-shanA.pdf" target="_blank" rel="noopener noreferrer">https://www.kdd.org/kdd2016/papers/files/adf0975-shanA.pdf</a>.</li>
<li>Factorization Machines. <a href="https://www.jefkine.com/recsys/2017/03/27/factorization-machines/" target="_blank" rel="noopener noreferrer">https://www.jefkine.com/recsys/2017/03/27/factorization-machines/</a>.</li>
<li>Deep Factorization Machines. <a href="https://d2l.ai/chapter_recommender-systems/deepfm.html" target="_blank" rel="noopener noreferrer">https://d2l.ai/chapter_recommender-systems/deepfm.html</a>.</li>
<li>Kaggle’s winning solution in ad click prediction. <a href="https://www.youtube.com/watch?v=4Go5crRVyuU" target="_blank" rel="noopener noreferrer">https://www.youtube.com/watch?v=4Go5crRVyuU</a>.</li>
<li>Data leakage in ML systems. <a href="https://machinelearningmastery.com/data-leakage-machine-learning/" target="_blank" rel="noopener noreferrer">https://machinelearningmastery.com/data-leakage-machine-learning/</a>.</li>
<li>Time-based dataset splitting. <a href="https://www.linkedin.com/pulse/time-based-splitting-determining-train-test-data-come-manraj-chalokia/?trk=public_profile_article_view" target="_blank" rel="noopener noreferrer">https://www.linkedin.com/pulse/time-based-splitting-determining-train-test-data-come-manraj-chalokia/?trk=public_profile_article_view</a>.</li>
<li>Model calibration. <a href="https://machinelearningmastery.com/calibrated-classification-model-in-scikit-learn/" target="_blank" rel="noopener noreferrer">https://machinelearningmastery.com/calibrated-classification-model-in-scikit-learn/</a>.</li>
<li>Field-aware Factorization Machines. <a href="https://www.csie.ntu.edu.tw/~cjlin/papers/ffm.pdf" target="_blank" rel="noopener noreferrer">https://www.csie.ntu.edu.tw/~cjlin/papers/ffm.pdf</a>.</li>
<li>Catastrophic forgetting problem in continual learning. <a href="https://www.cs.uic.edu/~liub/lifelong-learning/continual-learning.pdf" target="_blank" rel="noopener noreferrer">https://www.cs.uic.edu/~liub/lifelong-learning/continual-learning.pdf</a>.</li>
</ol>
        </article>
    </main>

    <div class="nav">
        <a href="../machine-learning-system-design-interview.html">← Course Contents</a>
        <a href="event-recommendation-system.html">← Previous</a>
        <a href="similar-listings-on-vacation-rental-platforms.html">Next →</a>
    </div>

    <footer class="metadata">
        <p>Scraped on 10/10/2025</p>
    </footer>
</body>
</html>