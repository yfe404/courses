<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Similar Listings on Vacation Rental Platforms - Machine Learning System Design Interview</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Open Sans', Arial, sans-serif;
    font-size: 16px;
    line-height: 1.6;
    color: #454545;
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

h1 {
    font-size: 2em;
    margin: 1em 0 0.5em 0;
    line-height: 1.2;
}

h2 {
    font-size: 1.5em;
    margin: 1.2em 0 0.6em 0;
    line-height: 1.3;
}

h3 {
    font-size: 1.2em;
    margin: 1em 0 0.5em 0;
    line-height: 1.4;
}

p {
    margin: 0.8em 0;
}

a {
    color: #0077aa;
    text-decoration: none;
}

a:hover {
    text-decoration: underline;
}

ul, ol {
    margin: 0.8em 0;
    padding-left: 2em;
}

li {
    margin: 0.4em 0;
}

code, pre {
    background: #f4f4f4;
    border: 1px solid #ddd;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
}

code {
    padding: 2px 5px;
}

pre {
    padding: 10px;
    overflow-x: auto;
    margin: 1em 0;
}

pre code {
    border: none;
    padding: 0;
}

img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 1.5em auto;
}

figure {
    margin: 1.5em 0;
    text-align: center;
}

figcaption {
    font-style: italic;
    font-size: 0.9em;
    color: #666;
    margin-top: 0.5em;
}

.chapter-number {
    font-weight: bold;
    color: #0077aa;
}

.nav {
    margin: 2em 0;
    padding: 1em 0;
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
}

.nav a {
    margin-right: 1em;
}

.toc {
    list-style: none;
    padding: 0;
}

.toc li {
    margin: 0.8em 0;
}

.course-section {
    margin: 2em 0;
}

.course-title {
    font-size: 1.3em;
    font-weight: bold;
    color: #0077aa;
    margin: 1.5em 0 0.8em 0;
}

.metadata {
    font-size: 0.9em;
    color: #888;
    margin: 2em 0 1em 0;
}

.breadcrumb {
    font-size: 0.9em;
    color: #666;
    margin-bottom: 1em;
}

.breadcrumb a {
    color: #0077aa;
}

@media (max-width: 600px) {
    body {
        padding: 10px;
    }

    h1 {
        font-size: 1.5em;
    }

    h2 {
        font-size: 1.3em;
    }
}</style>
</head>
<body>
    <div class="breadcrumb">
        <a href="../../index.html">Home</a> /
        <a href="../machine-learning-system-design-interview.html">Machine Learning System Design Interview</a> /
        Similar Listings on Vacation Rental Platforms
    </div>

    <div class="nav">
        <a href="../machine-learning-system-design-interview.html">← Course Contents</a>
        <a href="ad-click-prediction-on-social-platforms.html">← Previous</a>
        <a href="personalized-news-feed.html">Next →</a>
    </div>

    <main>
        <h1>
            <span class="chapter-number">09</span> Similar Listings on Vacation Rental Platforms
        </h1>

        <div class="metadata">
            <a href="https://bytebytego.com/courses/machine-learning-system-design-interview/similar-listings-on-vacation-rental-platforms" target="_blank" rel="noopener">Original source</a>
        </div>

        <article>
            <header><strong class="style_chapter__grtAe">09</strong><h1>Similar Listings on Vacation Rental Platforms</h1></header><p>Recommending items similar to those a user is currently viewing, is a key technology that allows people to discover potentially relevant content on large platforms. For example, Airbnb recommends similar accommodation listings, Amazon recommends similar products, and Expedia recommends similar experiences to users.</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a webpage or app screen displaying a listing for 'Modern Mountain Studios with Incredible views'.  The top section contains navigation elements (back, forward, refresh icons, and a file icon), followed by a search bar (empty). Below this, the main listing shows a 4.97-star rating and 1529 reviews. Four pale yellow placeholders likely represent images of the studio.  Buttons for 'Share' and 'Save' are present.  Details about the listing ('2 guests - Studio - 2 beds - 1 bath') are provided. Finally, a section labeled 'Similar Listings' displays five pale green placeholders, presumably for similar property images.  The overall layout is clean and simple, typical of a real estate or vacation rental website.  Three small circles in the upper right corner might represent user account settings or notifications." width="600" height="486" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(600px, 100vw), (max-width: 1200px) min(600px, 80vw), min(600px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-01-1-WMH5CYW6.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-01-1-WMH5CYW6.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-01-1-WMH5CYW6.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-01-1-WMH5CYW6.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-01-1-WMH5CYW6.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-01-1-WMH5CYW6.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-01-1-WMH5CYW6.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-01-1-WMH5CYW6.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-01-1-WMH5CYW6.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 9.1: Recommended similar listings</figcaption></div></figure></center>
<p>In this chapter, we design a "similar listings" feature which resembles those used by vacation rental websites such as Airbnb and Vrbo. When a user clicks a specific listing, a list of similar listings is recommended to them.</p>
<h3 id="clarifying-requirements">Clarifying Requirements</h3>
<p>Here is a typical interaction between a candidate and an interviewer.</p>
<p><strong>Candidate:</strong> Can I assume the business objective is to increase the number of bookings?<br>
<strong>Interviewer:</strong> Yes.</p>
<p><strong>Candidate:</strong> What is the definition of "similarity"? Are the recommended listings expected to be similar to the listing that a user is currently viewing?<br>
<strong>Interviewer:</strong> Yes, that's correct. Two listings are defined as similar when they are in the same neighborhood, city, price range, etc.</p>
<p><strong>Candidate:</strong> Are the recommended listings personalized to users?<br>
<strong>Interviewer:</strong> We want this feature to work for both logged-in and anonymous users. In practice, we treat the two groups differently and apply personalization to logged-in users. However, for simplicity, let's assume we treat logged-in and anonymous users equally.</p>
<p><strong>Candidate:</strong> How many listings are available on the platform?<br>
<strong>Interviewer:</strong> 5 million listings.</p>
<p><strong>Candidate:</strong> How do we construct the training dataset?<br>
<strong>Interviewer:</strong> Good question. For this interview, let's assume we use user-listing interactions only. The model doesn't leverage users' attributes, such as age or location, or a listing's attributes, like price and location, at all.</p>

<p><strong>Candidate:</strong> How long does it take for new listings to appear in the similar listings result?<br>
<strong>Interviewer:</strong> Let's assume new listings are okay to appear as recommendations one day after being posted. During this time, the system collects interaction data for new listings.</p>
<p>Let's summarize the problem statement. We are asked to design a "similar listings" feature for vacation rental platforms. The input is a specific listing that a user is currently viewing, and the output is a ranked list of similar listings the user is likely to click on next. The recommended listings should be the same for both anonymous and logged-in users. There are around 5 million listings on the platform, and new listings can appear in recommendations after one day. The business objective of the system is to increase the number of bookings.</p>
<h3 id="frame-the-problem-as-an-ml-task">Frame the Problem as an ML Task</h3>
<h4 id="defining-the-ml-objective">Defining the ML objective</h4>
<p>The sequence of listings that a user clicks on usually have similar characteristics, such as being in the same city or having similar price ranges. We rely on this observation to define the ML objective as accurately predicting which listing the user will click next, given the listing the user is currently viewing.</p>
<h4 id="specifying-the-systems-input-and-output">Specifying the system’s input and output</h4>
<p>As shown in Figure 9.2, the "similar listings" system takes a listing a user is currently viewing as input and then outputs a ranked list of listings, sorted by the probability of this user clicking on them.</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simplified system for recommending similar listings.  A 'Currently-viewing listing,' depicted as a house icon, is input into a 'Similar listings system' (a rectangular box). This system processes the information about the currently viewed listing and outputs a list of 'Recommended similar listings.'  These recommendations are shown as four house icons (L₁, L₂, L₃, L₄) within a dashed-line box labeled 'Recommended similar listings.'  Arrows indicate the flow of information: from the currently viewed listing to the system, and then from the system to the recommended listings.  The system implicitly uses some algorithm or model to determine similarity between listings, based on features not explicitly shown in the diagram (e.g., location, price, size, features)." loading="lazy" width="475" height="385" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(475px, 100vw), (max-width: 1200px) min(475px, 80vw), min(475px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-02-1-4VTVVQRZ.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-02-1-4VTVVQRZ.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-02-1-4VTVVQRZ.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-02-1-4VTVVQRZ.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-02-1-4VTVVQRZ.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-02-1-4VTVVQRZ.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-02-1-4VTVVQRZ.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-02-1-4VTVVQRZ.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-02-1-4VTVVQRZ.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 9.2: A similar listings system’s input-output</figcaption></div></figure></center>
<h4 id="choosing-the-right-ml-category">Choosing the right ML category</h4>
<p>Most recommendation systems rely on users' historical interactions to understand their long-term interests. However, such recommendation systems may not be good at solving the similar listings problem. In our situation, recently viewed listings are more informative than those viewed a long time ago. In this case, a session-based recommendation system is commonly used.</p>
<p>Like Airbnb, many e-commerce and travel booking platforms rely more on short-term interests to make recommendations. In systems where high-quality recommendations depend more on recent interactions than long-term interests, a session-based recommendation is often a substitute for traditional recommendation systems. A session-based recommendation makes recommendations based on the user's current browsing session. Now, let's take a closer look at session-based recommendation systems.</p>
<h4 id="session-based-recommendation-systems">Session-based recommendation systems</h4>
<p>A session-based recommendation system aims to predict the next item, given a sequence of recent items browsed by a user. In the system, users’ interests are context-dependent and evolve fast. A good recommendation heavily depends on the user’s most recent interactions, not their generic interests.</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a sequence of data transformations or a pipeline, depicted using icons.  It starts with an icon resembling a t-shirt, which is then processed through a series of stages represented by icons: a shoe, a tall rectangular box suggesting a data processing unit or model, a pair of shorts, and finally a winter hat with a snowflake detail.  Each stage is connected to the next by a rightward-pointing arrow, indicating the flow of data. The final output, represented by a question mark, suggests an unknown or yet-to-be-determined result after the hat stage.  The overall image suggests a machine learning pipeline where an input (t-shirt) undergoes transformations (shoe, data processing, shorts) leading to a final output (hat) which is then followed by an unknown next step." loading="lazy" width="600" height="64" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(600px, 100vw), (max-width: 1200px) min(600px, 80vw), min(600px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-03-1-IZSBSDGK.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-03-1-IZSBSDGK.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-03-1-IZSBSDGK.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-03-1-IZSBSDGK.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-03-1-IZSBSDGK.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-03-1-IZSBSDGK.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-03-1-IZSBSDGK.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-03-1-IZSBSDGK.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-03-1-IZSBSDGK.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 9.3: A browsing session of products</figcaption></div></figure></center>
<p><strong>How do session-based and traditional recommendation systems compare?</strong></p>
<p>In traditional recommendation systems, users' interests are context-independent and won't change too frequently. In session-based recommendations, users' interests are dynamic and evolve fast. The goal of a traditional recommendation system is to learn users' generic interests. In contrast, session-based recommendation systems aim to understand users' short-term interests, based on their recent browsing history.</p>
<p>A widely-used technique to build session-based recommendation systems is to learn item embeddings using co-occurrences of items in users' browsing histories. For example, Instagram learns account embeddings to power its "Explore" feature [1], Airbnb learns listing embeddings to power its similar listings feature [2], and word2vec [3] uses a similar approach to learn meaningful word embeddings.</p>
<p>In this chapter, we frame the "similar listings" problem as a session-based recommendation task. We build the system by training a model which maps each listing into an embedding vector, so that if two listings frequently co-occur in users' browsing history, their embedding vectors are in close proximity in the embedding space.</p>
<p>To recommend similar listings, we search the embedding space for listings closest to the one currently being viewed. Let's take a look at an example of this. In Figure 9.4, each listing is mapped into a <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi mathvariant="normal">D</mi></mrow><annotation encoding="application/x-tex">2 \mathrm{D}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord">2</span><span class="mord mathrm">D</span></span></span></span> space. To recommend similar listings to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">L_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span>, we choose the top 3 listings with the closest embeddings.</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a two-dimensional embedding space with axes labeled X1 and X2.  A house icon labeled 'L&lt;sub&gt;t&lt;/sub&gt;' is shown on the left, representing a target listing. A dashed line connects this house icon to a red 'X' point in the embedding space. This red 'X' lies within a dashed light-green circle labeled 'Frequently co-occurred listings,' indicating that it's clustered with other 'X' points representing similar listings.  Multiple 'X' points are scattered throughout the embedding space, illustrating various listings. The overall diagram visualizes how a target listing (L&lt;sub&gt;t&lt;/sub&gt;) is mapped to a point in the embedding space, showing its proximity to frequently co-occurring listings based on some similarity measure." loading="lazy" width="386" height="292" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(386px, 100vw), (max-width: 1200px) min(386px, 80vw), min(386px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-04-1-G4RCKGUN.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-04-1-G4RCKGUN.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-04-1-G4RCKGUN.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-04-1-G4RCKGUN.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-04-1-G4RCKGUN.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-04-1-G4RCKGUN.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-04-1-G4RCKGUN.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-04-1-G4RCKGUN.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-04-1-G4RCKGUN.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 9.4: Similar listings in the embedding space</figcaption></div></figure></center>
<h3 id="data-preparation">Data Preparation</h3>
<h4 id="data-engineering">Data engineering</h4>
<p>The following data are available:</p>
<ul>
<li>Users</li>
<li>Listings</li>
<li>User-listing interactions</li>
</ul>
<h5 id="users">Users</h5>
<p>A simplified user data schema is shown below.</p>
<div class="table-wrap" style="--table-min-width: 640px;"><table><thead><tr><th style="text-align: left;">ID</th><th style="text-align: left;">Username</th><th style="text-align: left;">Age</th><th style="text-align: left;">Gender</th><th style="text-align: left;">City</th><th style="text-align: left;">Country</th><th style="text-align: left;">Language</th><th style="text-align: left;">Time zone</th></tr></thead></table></div>
<p class="tableCaption">Table 9.1: User data schema</p>
<h5 id="listings">Listings</h5>
<p>Listing data contains attributes related to each listing, such as price, number of beds, host ID, etc. Table 9.2 shows a simple example of what the listing data might look like.</p>
<div class="table-wrap" style="--table-min-width: 640px;"><table><thead><tr><th style="text-align: center;">ID</th><th style="text-align: center;">Host ID</th><th style="text-align: center;">Price</th><th style="text-align: center;">Sq ft</th><th style="text-align: center;">Rate</th><th style="text-align: center;">Type</th><th style="text-align: center;">City</th><th style="text-align: center;">Beds</th><th style="text-align: center;">Max guests</th></tr></thead><tbody><tr><td style="text-align: center;">1</td><td style="text-align: center;">135</td><td style="text-align: center;">135</td><td style="text-align: center;">1060</td><td style="text-align: center;">4.97</td><td style="text-align: center;">Entire place</td><td style="text-align: center;">NYC</td><td style="text-align: center;">3</td><td style="text-align: center;">4</td></tr><tr><td style="text-align: center;">2</td><td style="text-align: center;">81</td><td style="text-align: center;">80</td><td style="text-align: center;">830</td><td style="text-align: center;">4.6</td><td style="text-align: center;">Private room</td><td style="text-align: center;">SF</td><td style="text-align: center;">1</td><td style="text-align: center;">2</td></tr><tr><td style="text-align: center;">3</td><td style="text-align: center;">64</td><td style="text-align: center;">65</td><td style="text-align: center;">2540</td><td style="text-align: center;">5.0</td><td style="text-align: center;">Shared room</td><td style="text-align: center;">Boston</td><td style="text-align: center;">4</td><td style="text-align: center;">6</td></tr></tbody></table></div>
<p class="tableCaption">Table 9.2: Listing data</p>
<h5 id="user-listing-interactions">User-listing interactions</h5>
<p>Table 9.3 stores user-listing interactions such as impressions, clicks, and bookings.</p>
<div class="table-wrap" style="--table-min-width: 640px;"><table><thead><tr><th style="text-align: center;">ID</th><th style="text-align: center;">User ID</th><th style="text-align: center;">Listing ID</th><th style="text-align: center;">Position of the listing in the displayed list</th><th style="text-align: center;">Interaction type</th><th style="text-align: center;">Source</th><th style="text-align: center;">Timestamp</th></tr></thead><tbody><tr><td style="text-align: center;">2</td><td style="text-align: center;">18</td><td style="text-align: center;">26</td><td style="text-align: center;">2</td><td style="text-align: center;">Click</td><td style="text-align: center;">Search feature</td><td style="text-align: center;">1655121925</td></tr><tr><td style="text-align: center;">3</td><td style="text-align: center;">5</td><td style="text-align: center;">18</td><td style="text-align: center;">5</td><td style="text-align: center;">Book</td><td style="text-align: center;">Similar listing feature</td><td style="text-align: center;">1655135257</td></tr></tbody></table></div>
<p class="tableCaption">Table 9.3: User-listing interaction data</p>
<h4 id="feature-engineering">Feature engineering</h4>
<p>As described in the "Frame the Problem as ML Task" section, the model only utilizes users' browsing history during training. Other information is not used, such as listing price, user's age, etc.</p>
<p>In this chapter, the browsing histories are called "search sessions". A search session is a sequence of clicked listing IDs, followed by an eventually booked listing, without interruption. Figure <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>9.5</mn></mrow><annotation encoding="application/x-tex">9.5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">9.5</span></span></span></span> shows an example of a search session, where the user's session started when the user clicked on <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">L_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span>, and ended when the user eventually booked <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mn>20</mn></msub></mrow><annotation encoding="application/x-tex">L_{20}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">20</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span>.</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a sequence of user interactions with listings over time.  The horizontal axis represents time, progressing from left to right. Above the axis, a series of square boxes labeled L&lt;sub&gt;1&lt;/sub&gt;, L&lt;sub&gt;2&lt;/sub&gt;, L&lt;sub&gt;3&lt;/sub&gt;,... L&lt;sub&gt;18&lt;/sub&gt;, L&lt;sub&gt;19&lt;/sub&gt; represent individual listings that a user clicked on.  These are grouped under the label 'clicked listings'.  The ellipsis (...) indicates that there are more listings between L&lt;sub&gt;3&lt;/sub&gt; and L&lt;sub&gt;18&lt;/sub&gt; than are explicitly shown.  Finally, a distinct, light-green box labeled L&lt;sub&gt;20&lt;/sub&gt; is shown, positioned to the right of the others and labeled 'booked listing,' indicating that this listing was ultimately booked by the user. The arrow at the far right signifies the continuous flow of time, showing the sequence of clicks leading to a final booking." loading="lazy" width="436" height="101" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(436px, 100vw), (max-width: 1200px) min(436px, 80vw), min(436px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-05-1-OPTCULSL.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-05-1-OPTCULSL.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-05-1-OPTCULSL.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-05-1-OPTCULSL.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-05-1-OPTCULSL.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-05-1-OPTCULSL.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-05-1-OPTCULSL.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-05-1-OPTCULSL.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-05-1-OPTCULSL.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 9.5: A search session</figcaption></div></figure></center>
<p>In the feature engineering step, we extract search sessions from the interaction data. Table 9.4 shows a simple example of the search sessions.</p>
<div class="table-wrap"><table><thead><tr><th style="text-align: center;">Session ID</th><th style="text-align: center;">Clicked listing IDs</th><th style="text-align: center;">Eventually booked listing ID</th></tr></thead><tbody><tr><td style="text-align: center;">1</td><td style="text-align: center;">1,5,4,9</td><td style="text-align: center;">26</td></tr><tr><td style="text-align: center;">2</td><td style="text-align: center;">6,8,9,21,6,13,6</td><td style="text-align: center;">5</td></tr><tr><td style="text-align: center;">3</td><td style="text-align: center;">5,9</td><td style="text-align: center;">11</td></tr></tbody></table></div>
<p class="tableCaption">Table 9.4: Search session data</p>
<h3 id="model-development">Model Development</h3>
<h4 id="model-selection">Model selection</h4>
<p>A neural network is the standard method to learn embeddings. Choosing a good architecture for the neural network depends upon various factors, such as the complexity of the task, the amount of training data, etc. One common way to choose the hyperparameters associated with neural network architectures - such as the number of neurons, layers, activation function, etc. - is to run experiments and choose the architecture that performs best. In our case, we choose a shallow neural network architecture to learn listing embeddings.</p>
<h4 id="model-training">Model training</h4>
<p>As shown in Figure 9.6, for a given input listing, the model’s job is to predict listings within the input listing’s context.</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a system for predicting booked listings based on user behavior.  The system takes as input a central listing, denoted  `L&lt;sub&gt;c&lt;/sub&gt;`, which represents the listing being considered.  Above `L&lt;sub&gt;c&lt;/sub&gt;` is a 'context' section showing a series of listings labeled `L&lt;sub&gt;t-m&lt;/sub&gt;` to `L&lt;sub&gt;t+m&lt;/sub&gt;` representing listings viewed around the time of `L&lt;sub&gt;c&lt;/sub&gt;`.  These listings, along with `L&lt;sub&gt;c&lt;/sub&gt;`, are fed into a 'Shallow neural network'.  To the left of the context are listings labeled `L&lt;sub&gt;1&lt;/sub&gt;`, `L&lt;sub&gt;2&lt;/sub&gt;`, ..., `L&lt;sub&gt;t-m&lt;/sub&gt;`, representing previously clicked listings.  To the right of the context are listings labeled `L&lt;sub&gt;k-1&lt;/sub&gt;` and `L&lt;sub&gt;k&lt;/sub&gt;`, representing listings booked before and after the central listing `L&lt;sub&gt;c&lt;/sub&gt;`, respectively.  `L&lt;sub&gt;k&lt;/sub&gt;` is highlighted in light green to indicate the target variable (the listing that was ultimately booked). The entire system is oriented along a time axis, indicated by the arrow at the top right, showing the temporal sequence of events.  The shallow neural network processes the input listings to predict the likelihood of a given listing being booked." loading="lazy" width="575" height="306" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(575px, 100vw), (max-width: 1200px) min(575px, 80vw), min(575px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-06-1-KZ7L73ZU.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-06-1-KZ7L73ZU.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-06-1-KZ7L73ZU.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-06-1-KZ7L73ZU.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-06-1-KZ7L73ZU.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-06-1-KZ7L73ZU.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-06-1-KZ7L73ZU.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-06-1-KZ7L73ZU.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-06-1-KZ7L73ZU.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 9.6: Predicting neighboring listings</figcaption></div></figure></center>
<p>The training process starts by initializing listing embeddings to random vectors. These embeddings are learned gradually by reading through search sessions, using the sliding window method. As the window slides, the embedding of the central listing in the window is updated to be similar to the embedding of other listings in the window, and dissimilar from listings outside the window. The model then uses these embeddings to predict the context of a given listing.</p>
<p>To adapt the model to new listings, we train it daily on the newly constructed training data.</p>
<h5 id="constructing-the-dataset">Constructing the dataset</h5>
<p>There are different ways to construct a dataset. In our case, we choose a technique called "negative sampling" [4], commonly used to learn embeddings.</p>
<p>To construct the training data, we create positive pairs and negative pairs from search sessions. Positive pairs are listings that are expected to have similar embeddings, while negative pairs are expected to have dissimilar embeddings.</p>
<p>More precisely, for each session, we read through the listings with the sliding window method. As the window slides, we use the central listing in the window and its context listings to create positive pairs. We use the central listing and randomly sampled listings to form negative pairs. Positive pairs have a ground truth label of 1 , and negative pairs are given a label of 0.</p>
<p>Figure 9.7 shows how positive and negative pairs are generated by sliding through a search session.</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a data generation process for a machine learning model, likely for a similarity or recommendation task.  Three input rows, each showing a sequence of eight labeled items (L1 through L8), are depicted.  A central item in each row (L3, L4, and L5 respectively) is highlighted in gray, indicating a focus item.  Each input row has a rightward arrow connecting it to a pair of columns labeled 'Positive pairs' and 'Negative pairs.' The positive pairs column lists pairs of the highlighted central item and other items from the same input row, suggesting these are considered similar or related.  The negative pairs column lists pairs of the highlighted central item and other items, implying these are dissimilar or unrelated.  The specific items paired with the central item vary across rows, indicating that the positive and negative relationships are context-dependent and determined by the input row.  The numbers following the labels (e.g., (L3, L10)) likely represent some form of identifier or weight associated with the pair, possibly reflecting the strength of the relationship or a unique identifier within a larger dataset." loading="lazy" width="460" height="449" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(460px, 100vw), (max-width: 1200px) min(460px, 80vw), min(460px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-07-1-A2AXMUQK.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-07-1-A2AXMUQK.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-07-1-A2AXMUQK.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-07-1-A2AXMUQK.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-07-1-A2AXMUQK.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-07-1-A2AXMUQK.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-07-1-A2AXMUQK.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-07-1-A2AXMUQK.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-07-1-A2AXMUQK.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 9.7: Constructed positive and negative listing pairs</figcaption></div></figure></center>
<h5 id="choosing-the-loss-function">Choosing the loss function</h5>
<p>Loss function measures the agreement between the ground truth label and the predicted probability. If two listings form a positive pair, the embeddings should be close, and if the two listings form a negative pair, the embeddings should be far apart. More formally, here are the steps to calculate loss:</p>
<ol>
<li>Compute the distance (e.g., dot product) between two embeddings.</li>
<li>Use the Sigmoid function to convert the computed distance to a probability value between 0 and 1 .</li>
<li>Use cross-entropy as a standard classification loss to measure the loss between the predicted probability and the ground truth label.</li>
</ol>
<p>Figure 9.8 shows the loss calculation steps.</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a simplified machine learning model pipeline for a binary classification task.  Two input vectors, labeled  `L&lt;sub&gt;10&lt;/sub&gt;` and `L&lt;sub&gt;8&lt;/sub&gt;` representing a 'listing pair,' are fed into a 'model' component. The model outputs two embedding vectors, `E&lt;sub&gt;8&lt;/sub&gt;` and `E&lt;sub&gt;10&lt;/sub&gt;`. These embeddings undergo a 'dot product,'  labeled 'dot product,' resulting in a scalar value (1). This scalar, representing the distance between the embeddings, is then passed through a sigmoid function (2), yielding a probability `p`. Finally, this probability is compared to a ground truth label `g` (represented by a light green box) using a cross-entropy loss function (3), which quantifies the difference between the predicted probability and the actual label.  The entire process illustrates how a model processes input data, generates a probability prediction, and evaluates its accuracy against the ground truth." loading="lazy" width="697" height="120" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(697px, 100vw), (max-width: 1200px) min(697px, 80vw), min(697px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-08-1-FC5FWRSD.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-08-1-FC5FWRSD.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-08-1-FC5FWRSD.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-08-1-FC5FWRSD.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-08-1-FC5FWRSD.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-08-1-FC5FWRSD.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-08-1-FC5FWRSD.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-08-1-FC5FWRSD.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-08-1-FC5FWRSD.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 9.8: Loss calculation steps</figcaption></div></figure></center>
<p>The loss can be represented by the following formula:</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>&nbsp;loss&nbsp;</mtext><mo>=</mo><munder><mo>∑</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo separator="true">,</mo><mi>p</mi><mo stretchy="false">)</mo><mo>∈</mo><msub><mi>D</mi><mi>p</mi></msub></mrow></munder><mi>log</mi><mo>⁡</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><msub><mi>E</mi><mi>p</mi></msub><mo>⋅</mo><msub><mi>E</mi><mi>c</mi></msub></mrow></msup></mrow></mfrac><mo>+</mo><munder><mo>∑</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">)</mo><mo>∈</mo><msub><mi>D</mi><mi>n</mi></msub></mrow></munder><mi>log</mi><mo>⁡</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><msub><mi>E</mi><mi>n</mi></msub><mo>⋅</mo><msub><mi>E</mi><mi>c</mi></msub></mrow></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text { loss }=\sum_{(c, p) \in D_p} \log \frac{1}{1+e^{-E_p \cdot E_c}}+\sum_{(c, n) \in D_n} \log \frac{1}{1+e^{E_n \cdot E_c}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord text"><span class="mord">&nbsp;loss&nbsp;</span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.8598em; vertical-align: -1.5383em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.05em;"><span style="top: -1.809em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">c</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">p</span><span class="mclose mtight">)</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1645em;"><span style="top: -2.357em; margin-left: -0.0278em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2819em;"><span></span></span></span></span></span></span></span></span></span><span style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.5383em;"><span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop">lo<span style="margin-right: 0.01389em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3214em;"><span style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7834em;"><span style="top: -3.0051em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1645em;"><span style="top: -2.357em; margin-left: -0.0576em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2819em;"><span></span></span></span></span></span></span><span class="mbin mtight">⋅</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1645em;"><span style="top: -2.357em; margin-left: -0.0576em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 2.8374em; vertical-align: -1.516em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.05em;"><span style="top: -1.809em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">c</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1645em;"><span style="top: -2.357em; margin-left: -0.0278em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.516em;"><span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop">lo<span style="margin-right: 0.01389em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3214em;"><span style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7673em;"><span style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1645em;"><span style="top: -2.357em; margin-left: -0.0576em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">⋅</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1645em;"><span style="top: -2.357em; margin-left: -0.0576em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>
<p>Where:</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">c</span></span></span></span> is a central listing, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span> is a positive listing (co-occurred with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">c</span></span></span></span> in a context), and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> is a negative listing (did not co-occur with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">c</span></span></span></span> )</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">E_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> represents the embedding vector of the central listing <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">c</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">E_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> represents the embedding vector of negative listing <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">E_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span></span></span></span></span></span></span></span></span></span> represents the embedding vector of positive listing <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">D_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span></span></span></span></span></span></span></span></span></span> is a positive set of pairs <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟨</mo><mi>c</mi><mo separator="true">,</mo><mi>p</mi><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">\langle c, p\rangle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">⟨</span><span class="mord mathnormal">c</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">p</span><span class="mclose">⟩</span></span></span></span> which represents (central listing, context listing) tuples whose vectors are being pushed toward one another</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">D_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> is a negative set of pairs <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟨</mo><mi>c</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">\langle c, n\rangle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">⟨</span><span class="mord mathnormal">c</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">⟩</span></span></span></span> which represents (central listing, random listing) tuples whose vectors are being pushed away from each other</li>
</ul>
<p>The first summation computes the loss over positive pairs and the second summation computes the loss over negative pairs.</p>
<h6 id="can-we-improve-the-loss-function-to-learn-better-embeddings">Can we improve the loss function to learn better embeddings?</h6>
<p>The loss function described earlier is a good starting point, but it has two shortcomings. First, during training, the embedding of the central listing is pushed closer to the embeddings in its context, but not towards the embedding of the eventually booked listing. This leads to embeddings that are good at predicting neighboring clicked listings, but not at predicting eventually booked listings. This is not optimal for helping users discover a listing that leads to a booking.</p>
<p>Second, the negative pairs generated earlier mainly comprise listings from different regions, since they are sampled randomly. However, users typically search only within a certain region, e.g., San Francisco. This may lead to embeddings that do not work well for same-region listings; those that have not co-occurred in context, but are from the same region.</p>
<p>Let's address these shortcomings.</p>
<p><strong>Using the eventually booked listing as a global context</strong> &nbsp;<br>
To learn embeddings that are good at predicting eventually booked listings, we treat the eventually booked listing as a global context during the training phase. As the window slides, some listings fall in or out of the context set, while the eventually booked listing always remains in the global context, and is used to update the central listing vector.</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a system for predicting booked listings based on user interaction history.  The system is organized chronologically along a horizontal time axis.  On the left, a series of squares labeled L&lt;sub&gt;1&lt;/sub&gt;, L&lt;sub&gt;2&lt;/sub&gt;, ..., L&lt;sub&gt;t-m&lt;/sub&gt; represent listings clicked by a user up to time t-m.  These are grouped under the label 'clicked listings'.  To the right,  L&lt;sub&gt;c&lt;/sub&gt; represents a 'central listing' which feeds into a 'Shallow neural network'.  The network also receives input from a 'context' window, consisting of listings L&lt;sub&gt;c-1&lt;/sub&gt;, L&lt;sub&gt;c+1&lt;/sub&gt;, ..., L&lt;sub&gt;t+m&lt;/sub&gt; surrounding the central listing L&lt;sub&gt;c&lt;/sub&gt; in time.  Arrows indicate the flow of information into the shallow neural network.  Finally, a dashed red arrow shows the output of the shallow neural network predicting a 'booked listing', represented by a light green square labeled L&lt;sub&gt;k&lt;/sub&gt;, which is the listing booked at time k.  The entire system models how past user clicks and the context surrounding a central listing influence the prediction of a future booking." loading="lazy" width="575" height="306" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(575px, 100vw), (max-width: 1200px) min(575px, 80vw), min(575px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-09-1-ZAX7PUPX.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-09-1-ZAX7PUPX.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-09-1-ZAX7PUPX.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-09-1-ZAX7PUPX.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-09-1-ZAX7PUPX.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-09-1-ZAX7PUPX.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-09-1-ZAX7PUPX.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-09-1-ZAX7PUPX.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-09-1-ZAX7PUPX.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 9.9: Adding the eventually booked listing to the positive pairs</figcaption></div></figure></center>
<p>To use the eventually booked listing as a global context during training, we add pairs of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟨</mo></mrow><annotation encoding="application/x-tex">\langle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">⟨</span></span></span></span> central listing, eventually booked listing <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">\rangle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mclose">⟩</span></span></span></span> to our training data and label them as positive. This drives the model to push the embedding of the eventually booked listing close to each of the clicked listings in the session during training, as shown in Figure 9.9.</p>
<p><strong>Add negative pairs from the same region to the training data</strong></p>
<p>As the window slides, we choose a listing from the same neighborhood as the central listing, which is not within the central listing's context. We label the pair as negative and add it to our training data.
Let's see the updated loss function that considers newly added training data.</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi mathvariant="normal">loss</mi><mo>⁡</mo><mo>=</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><munder><mo>∑</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo separator="true">,</mo><mi>p</mi><mo stretchy="false">)</mo><mo>∈</mo><msub><mi>D</mi><mi>p</mi></msub></mrow></munder><mi>log</mi><mo>⁡</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><msub><mi>E</mi><mi>c</mi></msub><mo>⋅</mo><msub><mi>E</mi><mi>p</mi></msub></mrow></msup></mrow></mfrac><mo>+</mo><munder><mo>∑</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">)</mo><mo>∈</mo><msub><mi>D</mi><mi>n</mi></msub></mrow></munder><mi>log</mi><mo>⁡</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><msub><mi>E</mi><mi>c</mi></msub><mo>⋅</mo><msub><mi>E</mi><mi>n</mi></msub></mrow></msup></mrow></mfrac><mo>+</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><munder><mo>∑</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>∈</mo><msub><mi>D</mi><mrow><mi mathvariant="normal">b</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">k</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">d</mi></mrow></msub></mrow></munder><mi>log</mi><mo>⁡</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><msub><mi>E</mi><mi>c</mi></msub><mo>⋅</mo><msub><mi>E</mi><mi>b</mi></msub></mrow></msup></mrow></mfrac><mo>+</mo><munder><mo>∑</mo><mrow><mo stretchy="false">(</mo><mi>c</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">)</mo><mo>∈</mo><msub><mi>D</mi><mrow><mi mathvariant="normal">h</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">d</mi></mrow></msub></mrow></munder><mi>log</mi><mo>⁡</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><msub><mi>E</mi><mi>c</mi></msub><mo>⋅</mo><msub><mi>E</mi><mi>n</mi></msub></mrow></msup></mrow></mfrac></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\operatorname{loss}= &amp; \sum_{(c, p) \in D_p} \log \frac{1}{1+e^{-E_c \cdot E_p}}+\sum_{(c, n) \in D_n} \log \frac{1}{1+e^{E_c \cdot E_n}}+ \\
&amp; \sum_{(c, b) \in D_{\mathrm{booked}}} \log \frac{1}{1+e^{-E_c \cdot E_b}}+\sum_{(c, n) \in D_{\mathrm{hard}}} \log \frac{1}{1+e^{E_c \cdot E_n}}
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 6.2972em; vertical-align: -2.8986em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 3.3986em;"><span style="top: -5.3986em;"><span class="pstrut" style="height: 3.3214em;"></span><span class="mord"><span class="mop"><span class="mord mathrm">loss</span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span></span></span><span style="top: -2.2388em;"><span class="pstrut" style="height: 3.3214em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.8986em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 3.3986em;"><span style="top: -5.3986em;"><span class="pstrut" style="height: 3.3214em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.05em;"><span style="top: -1.809em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">c</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">p</span><span class="mclose mtight">)</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1645em;"><span style="top: -2.357em; margin-left: -0.0278em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2819em;"><span></span></span></span></span></span></span></span></span></span><span style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.5383em;"><span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop">lo<span style="margin-right: 0.01389em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3214em;"><span style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7834em;"><span style="top: -3.0051em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1645em;"><span style="top: -2.357em; margin-left: -0.0576em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">⋅</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1645em;"><span style="top: -2.357em; margin-left: -0.0576em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2819em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.05em;"><span style="top: -1.809em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">c</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1645em;"><span style="top: -2.357em; margin-left: -0.0278em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.516em;"><span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop">lo<span style="margin-right: 0.01389em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3214em;"><span style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7673em;"><span style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1645em;"><span style="top: -2.357em; margin-left: -0.0576em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">⋅</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1645em;"><span style="top: -2.357em; margin-left: -0.0576em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord">+</span></span></span><span style="top: -2.2388em;"><span class="pstrut" style="height: 3.3214em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.05em;"><span style="top: -1.809em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">c</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">b</span><span class="mclose mtight">)</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em;"><span style="top: -2.3488em; margin-left: -0.0278em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">booked</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1512em;"><span></span></span></span></span></span></span></span></span></span><span style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.516em;"><span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop">lo<span style="margin-right: 0.01389em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3214em;"><span style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7673em;"><span style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1645em;"><span style="top: -2.357em; margin-left: -0.0576em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">⋅</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em;"><span style="top: -2.3488em; margin-left: -0.0576em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.05em;"><span style="top: -1.809em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">c</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em;"><span style="top: -2.3488em; margin-left: -0.0278em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">hard</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1512em;"><span></span></span></span></span></span></span></span></span></span><span style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.516em;"><span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop">lo<span style="margin-right: 0.01389em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3214em;"><span style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7673em;"><span style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1645em;"><span style="top: -2.357em; margin-left: -0.0576em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">⋅</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1645em;"><span style="top: -2.357em; margin-left: -0.0576em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 2.8986em;"><span></span></span></span></span></span></span></span></span></span></span></span>
<p>Where:</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mi>b</mi></msub></mrow><annotation encoding="application/x-tex">E_b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> represents the embedding vector of the eventually booked listing <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mtext>booked&nbsp;</mtext></msub></mrow><annotation encoding="application/x-tex">D_{\text {booked }}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">booked&nbsp;</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> are pairs of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟨</mo><mi>c</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">\langle c, b\rangle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">⟨</span><span class="mord mathnormal">c</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">b</span><span class="mclose">⟩</span></span></span></span> that represent (central listing, booked listing) tuples whose vectors are being pushed close to each other</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mtext>hard&nbsp;</mtext></msub></mrow><annotation encoding="application/x-tex">D_{\text {hard }}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">hard&nbsp;</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> are hard negative pairs <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟨</mo><mi>c</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">\langle c, n\rangle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">⟨</span><span class="mord mathnormal">c</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">⟩</span></span></span></span> that represent (central listing, same-region negative listing) tuples whose vectors are being pushed away from each other</li>
</ul>
<p>We explained the first two summations earlier. The third summation computes the loss over newly added positive pairs which contain the global context. It helps the model to push the central listings' embeddings close to eventually booked listings' embeddings.</p>
<p>The fourth summation computes the loss over newly added negative pairs from the same region. It enforces the model to push their embeddings away from each other.</p>
<h3 id="evaluation">Evaluation</h3>
<h4 id="offline-metrics">Offline metrics</h4>
<p>During the model development phase, we use offline metrics to measure the output quality of the model and compare the newly developed models with older ones. One way to evaluate learned embeddings is to test how good they are at predicting the eventually booked listing, based on the latest user click. Let's create a metric called "average rank of eventually booked listing" and discuss this in more detail.</p>
<p><strong>The average rank of the eventually-booked listing.</strong> Let's look at an example to understand this metric. Figure <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>9.10</mn></mrow><annotation encoding="application/x-tex">9.10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">9.10</span></span></span></span> shows a user's search session. As you can see, the search session consists of seven listings in total. The first listing is what the user viewed first <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">(</mo><msub><mi>L</mi><mn>0</mn></msub><mo fence="true">)</mo></mrow><annotation encoding="application/x-tex">\left(L_0\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span></span>. The next five are listings the user clicked on, sequentially. The last one <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">(</mo><msub><mi>L</mi><mn>6</mn></msub><mo fence="true">)</mo></mrow><annotation encoding="application/x-tex">\left(L_6\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span></span> is the listing that the user eventually booked.</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a machine learning model's application to re-ranking search results.  The left side shows a 'First clicked listing' (L₀), a single house icon.  A dashed line separates this from a 'Search session' displaying six house icons labeled L₁ through L₆, with L₆ highlighted in light green and labeled '(Booked),' indicating the user's choice.  These six listings are fed as input to a 'Trained model' (represented as a cloud), which processes the data.  The output of the trained model is a re-ranked list of the same six houses (L₁, L₂, L₃, L₄, L₅, L₆), but now with L₆, the originally booked listing, appearing earlier in the sequence, reflecting a change in ranking based on the model's learning from the user's previous booking.  The re-ranked listings are labeled below as 'Re-ranked listings using the new model.'  Arrows clearly show the data flow from the search session to the model and then to the re-ranked output." loading="lazy" width="495" height="374" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(495px, 100vw), (max-width: 1200px) min(495px, 80vw), min(495px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-10-1-JYOYYRDZ.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-10-1-JYOYYRDZ.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-10-1-JYOYYRDZ.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-10-1-JYOYYRDZ.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-10-1-JYOYYRDZ.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-10-1-JYOYYRDZ.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-10-1-JYOYYRDZ.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-10-1-JYOYYRDZ.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-10-1-JYOYYRDZ.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 9.10: A session re-ranked by a model</figcaption></div></figure></center>
<p>We use the model to compute the similarities between the first clicked listing and other listings in the embedding space. Once similarities are computed, the listings are ranked. The position of the eventually booked listing indicates how high in the ranking we could have recommended it <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">(</mo><msub><mi>L</mi><mn>6</mn></msub><mo fence="true">)</mo></mrow><annotation encoding="application/x-tex">\left(L_6\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span></span> by employing the new model. As you can see in Figure 9.10, the new model (second row) was able to rank the eventually booked listing <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">(</mo><msub><mi>L</mi><mn>6</mn></msub><mo fence="true">)</mo></mrow><annotation encoding="application/x-tex">\left(L_6\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span></span> in second place.</p>
<p>If the model ranks the eventually booked listing highly, it indicates the learned embeddings can place the eventually booked listing earlier in the recommended list. We average the rank of the eventually booked listings across all the sessions in the validation dataset, to compute the value of this metric.</p>
<h4 id="online-metrics">Online metrics</h4>
<p>According to the requirements, the business objective is to increase the number of bookings. Here are some options for online metrics:</p>
<ul>
<li>Click-through rate (CTR)</li>
<li>Session book rate</li>
</ul>
<p><strong>CTR.</strong> A ratio showing how often people who see the recommended listings, end up clicking them.</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>C</mi><mi>T</mi><mi>R</mi><mo>=</mo><mfrac><mtext>&nbsp;Number&nbsp;of&nbsp;clicked&nbsp;listings&nbsp;</mtext><mtext>&nbsp;Number&nbsp;of&nbsp;recommended&nbsp;listings&nbsp;</mtext></mfrac></mrow><annotation encoding="application/x-tex">C T R=\frac{\text { Number of clicked listings }}{\text { Number of recommended listings }}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.00773em;">CTR</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.2519em; vertical-align: -0.8804em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3714em;"><span style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord text"><span class="mord">&nbsp;Number&nbsp;of&nbsp;recommended&nbsp;listings&nbsp;</span></span></span></span><span style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord text"><span class="mord">&nbsp;Number&nbsp;of&nbsp;clicked&nbsp;listings&nbsp;</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>
<p>This metric is used to measure user engagement. For example, when users click on listings more frequently, there is a higher likelihood that some of the clicked listings become a booking. But since CTR does not measure the actual number of bookings made on the platform, we use the "session book rate" metric to supplement CTR.</p>
<p><strong>Session book rate.</strong> A ratio showing how many search sessions turn into a booking.</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>&nbsp;Session&nbsp;book&nbsp;Rate&nbsp;</mtext><mo>=</mo><mfrac><mtext>&nbsp;Number&nbsp;of&nbsp;sessions&nbsp;turned&nbsp;into&nbsp;booking&nbsp;</mtext><mtext>&nbsp;Total&nbsp;number&nbsp;of&nbsp;sessions&nbsp;</mtext></mfrac></mrow><annotation encoding="application/x-tex">\text { Session book Rate }=\frac{\text { Number of sessions turned into booking }}{\text { Total number of sessions }}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord text"><span class="mord">&nbsp;Session&nbsp;book&nbsp;Rate&nbsp;</span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.0574em; vertical-align: -0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3714em;"><span style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord text"><span class="mord">&nbsp;Total&nbsp;number&nbsp;of&nbsp;sessions&nbsp;</span></span></span></span><span style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord text"><span class="mord">&nbsp;Number&nbsp;of&nbsp;sessions&nbsp;turned&nbsp;into&nbsp;booking&nbsp;</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>
<p>This metric is directly related to our business objective, which is to increase the number of bookings. The higher the "session book rate" is, the more revenue the platform generates.</p>
<h3 id="serving">Serving</h3>
<p>At serving time, the system recommends listings similar to that the user is currently viewing. Figure 9.11 shows an overview of the ML system design.</p>
<center><figure class="py-1"><div style="display: flex; justify-content: center;"><img alt="Image represents a machine learning system for recommending similar listings.  The system is divided into three main pipelines: a training pipeline, an indexing pipeline, and a prediction pipeline. The training pipeline takes 'New listings' as input, processes them through a 'Model fine-tuning' step, and outputs a 'Trained model.' This trained model is then used in the indexing pipeline. The indexing pipeline takes 'Listings' from a database and feeds them into an 'Indexer,' which creates an 'Index table.'  The prediction pipeline begins when a 'Currently-viewing listing' is input into an 'Embedding fetcher service.' This service, along with the 'listing embedding' from the index table, feeds into a 'Nearest neighbor service.' The output of the nearest neighbor service is then passed to a 'Re-ranking service,' which finally produces 'Recommended similar listings,' represented as a series of houses labeled L₁, L₂, L₃, ..., Lₖ.  The dashed lines delineate the boundaries of each pipeline, showing the flow of data and processing steps within and between them." loading="lazy" width="821" height="674" decoding="async" data-nimg="1" sizes="(max-width: 840px) min(821px, 100vw), (max-width: 1200px) min(821px, 80vw), min(821px, 80vw)" srcset="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-11-1-6QO3IOKU.png&amp;w=640&amp;q=75 640w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-11-1-6QO3IOKU.png&amp;w=750&amp;q=75 750w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-11-1-6QO3IOKU.png&amp;w=828&amp;q=75 828w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-11-1-6QO3IOKU.png&amp;w=1080&amp;q=75 1080w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-11-1-6QO3IOKU.png&amp;w=1200&amp;q=75 1200w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-11-1-6QO3IOKU.png&amp;w=1920&amp;q=75 1920w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-11-1-6QO3IOKU.png&amp;w=2048&amp;q=75 2048w, https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-11-1-6QO3IOKU.png&amp;w=3840&amp;q=75 3840w" src="https://bytebytego.com/_next/image?url=%2Fimages%2Fcourses%2Fmachine-learning-system-design-interview%2Fsimilar-listings-on-vacation-rental-platforms%2Fch9-11-1-6QO3IOKU.png&amp;w=3840&amp;q=75" style="color: transparent;"></div><div style="display: flex; justify-content: center;"><figcaption class="py-1">Figure 9.11: ML system design</figcaption></div></figure></center>
<p>Let’s examine the main components in detail.</p>
<h4 id="training-pipeline">Training pipeline</h4>
<p>The training pipeline fine-tunes the model using new listings and user-listing interactions. This ensures the model is always adapted to new interactions and listings.</p>
<h4 id="indexing-pipeline">Indexing pipeline</h4>
<p>With a trained model, the embeddings of all listings on the platform can be pre-computed and stored in the index table. This significantly speeds up the prediction pipeline.</p>
<p>The indexing pipeline creates and maintains the index table. For example, when a new listing embedding becomes available, the pipeline adds its embedding to the index table. In addition, when a newly trained model becomes available, the pipeline re-computes all the embeddings using the new model and updates the index table.</p>
<h4 id="prediction-pipeline">Prediction pipeline</h4>
<p>The prediction pipeline recommends similar listings to what a user is currently viewing. The prediction pipeline, as shown in Figure 9.11, consists of:</p>
<ul>
<li>Embedding fetcher service</li>
<li>Nearest neighbor service</li>
<li>Re-ranking service</li>
</ul>
<p>Let’s inspect each component.</p>
<h5 id="embedding-fetcher-service">Embedding fetcher service</h5>
<p>This service takes the currently viewing listing as input and acts differently depending on whether or not the listing has been seen by the model during training.</p>
<p><strong>The input listing has been seen by the model during training</strong></p>
<p>If a listing was seen during training, its embedding vector has already been learned and is available in the index table. In this case, the embedding fetcher service directly fetches the listing embedding from the index table.</p>
<p><strong>The input listing has not been seen by the model during training</strong></p>
<p>If the input listing is new, the model hasn't seen it during training. This is problematic since we cannot find similar listings if we do not have the embedding of the given listing.</p>
<p>To solve this issue, the embedding fetcher uses heuristics to handle new listings. For example, we can use the embedding of a geographically nearby listing when the listing is new. When enough interaction data is gathered for the new listing, the training pipeline learns the embedding by fine-tuning the model.</p>
<h5 id="nearest-neighbor-service">Nearest neighbor service</h5>
<p>To recommend similar listings, we need to compute the similarity between the embedding of the currently-viewing listing and the embeddings of other listings on the platform. This is where the nearest neighbor service comes into play. This service computes these similarities and outputs the nearest neighbor listings in the embedding space.</p>
<p>Remember from the requirements that we have five million listings on the platform. Computing similarities for this many listings takes time and may slow down serving. Therefore, we use an approximate nearest neighbor method to speed up the search.</p>
<h5 id="re-ranking-service">Re-ranking service</h5>
<p>This service modifies the listings by applying user filters and certain constraints. For example, if a listing is above a certain price filter set by the user, this layer removes it. In addition, listings in cities other than the currently viewed listing can be removed from the list before being displayed to the user.</p>
<h3 id="other-talking-points">Other Talking Points</h3>
<p>If there is time left at the end of the interview, here are some additional talking points:</p>
<ul>
<li>What is positional bias, and how to address it [5].</li>
<li>How does a session-based approach compare to random walk [6], and how random walks with restart (RWR) can be used to recommend similar listings [7].</li>
<li>How to personalize the results of a session-based recommendation system by considering users' longer-term interests (in-session personalization) [2].</li>
<li>Given that seasonality greatly affects vacation rentals, how should we incorporate seasonality into our similar listings system [8].</li>
</ul>
<h3 id="references">References</h3>
<ol>
<li>Instagram’s Explore recommender system. <a href="https://ai.facebook.com/blog/powered-by-ai-instagrams-explore-recommender-system" target="_blank" rel="noopener noreferrer">https://ai.facebook.com/blog/powered-by-ai-instagrams-explore-recommender-system</a>.</li>
<li>Listing embeddings in search ranking. <a href="https://medium.com/airbnb-engineering/listing-embeddings-for-similar-listing-recommendations-and-real-time-personalization-in-search-601172f7603e" target="_blank" rel="noopener noreferrer">https://medium.com/airbnb-engineering/listing-embeddings-for-similar-listing-recommendations-and-real-time-personalization-in-search-601172f7603e</a>.</li>
<li>Word2vec. <a href="https://en.wikipedia.org/wiki/Word2vec" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Word2vec</a>.</li>
<li>Negative sampling technique. <a href="https://www.baeldung.com/cs/nlps-word2vec-negative-sampling" target="_blank" rel="noopener noreferrer">https://www.baeldung.com/cs/nlps-word2vec-negative-sampling</a>.</li>
<li>Positional bias. <a href="https://eugeneyan.com/writing/position-bias/" target="_blank" rel="noopener noreferrer">https://eugeneyan.com/writing/position-bias/</a>.</li>
<li>Random walk. <a href="https://en.wikipedia.org/wiki/Random_walk" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Random_walk</a>.</li>
<li>Random walk with restarts. <a href="https://www.youtube.com/watch?v=HbzQzUaJ_9I" target="_blank" rel="noopener noreferrer">https://www.youtube.com/watch?v=HbzQzUaJ_9I</a>.</li>
<li>Seasonality in recommendation systems. <a href="https://www.computer.org/csdl/proceedings-article/big-data/2019/09005954/1hJsfgT0qL6" target="_blank" rel="noopener noreferrer">https://www.computer.org/csdl/proceedings-article/big-data/2019/09005954/1hJsfgT0qL6</a>.</li>
</ol>
        </article>
    </main>

    <div class="nav">
        <a href="../machine-learning-system-design-interview.html">← Course Contents</a>
        <a href="ad-click-prediction-on-social-platforms.html">← Previous</a>
        <a href="personalized-news-feed.html">Next →</a>
    </div>

    <footer class="metadata">
        <p>Scraped on 10/10/2025</p>
    </footer>
</body>
</html>